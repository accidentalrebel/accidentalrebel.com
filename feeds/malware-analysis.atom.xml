<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>AccidentalRebel.com - Malware Analysis</title><link href="https://www.accidentalrebel.com/" rel="alternate"/><link href="https://www.accidentalrebel.com/feeds/malware-analysis.atom.xml" rel="self"/><id>https://www.accidentalrebel.com/</id><updated>2023-01-23T21:02:00+08:00</updated><entry><title>Adding Automation to Blue-Jupyter Malware Notebook</title><link href="https://www.accidentalrebel.com/adding-automation-to-blue-jupyter-malware-notebook.html" rel="alternate"/><published>2023-01-23T21:02:00+08:00</published><updated>2023-01-23T21:02:00+08:00</updated><author><name>AccidentalRebel</name></author><id>tag:www.accidentalrebel.com,2023-01-23:/adding-automation-to-blue-jupyter-malware-notebook.html</id><summary type="html">&lt;p&gt;I came across the &lt;a href="https://github.com/mttaggart/blue-jupyter"&gt;Blue-Jupyter project on Github&lt;/a&gt; while researching Jupyter notebooks. This &lt;a href="https://www.youtube.com/watch?v=-EX5Ybbt8uE"&gt;short demo video&lt;/a&gt; got me excited, so I cloned the project and added some improvements that automate many things when I am looking for malware to investigate.&lt;/p&gt;
&lt;h1 id="what-are-jupyter-notebooks"&gt;What are Jupyter Notebooks?&lt;/h1&gt;
&lt;p&gt;For readers who may be unfamiliar, Jupyter Notebooks are a web-based tool that allows users to create and share documents that contain live code, equations, visualizations, and narrative text. They are a popular tool among data scientists and researchers but have also adapted for use in other fields, such as cybersecurity.&lt;/p&gt;
&lt;h1 id="my-additions-to-the-blue-jupyter"&gt;My Additions to the Blue-Jupyter&lt;/h1&gt;
&lt;p&gt;Many of the changes I've made are focused on automating the process of quickly looking for interesting new samples to investigate.&lt;/p&gt;
&lt;p&gt;One addition to the notebook is the automated downloading of samples from &lt;a href="https://bazaar.abuse.ch/"&gt;Malware Bazaar&lt;/a&gt;. This can download a maximum of 100 samples continuously. Additional information is listed to highlight …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I came across the &lt;a href="https://github.com/mttaggart/blue-jupyter"&gt;Blue-Jupyter project on Github&lt;/a&gt; while researching Jupyter notebooks. This &lt;a href="https://www.youtube.com/watch?v=-EX5Ybbt8uE"&gt;short demo video&lt;/a&gt; got me excited, so I cloned the project and added some improvements that automate many things when I am looking for malware to investigate.&lt;/p&gt;
&lt;h1 id="what-are-jupyter-notebooks"&gt;What are Jupyter Notebooks?&lt;/h1&gt;
&lt;p&gt;For readers who may be unfamiliar, Jupyter Notebooks are a web-based tool that allows users to create and share documents that contain live code, equations, visualizations, and narrative text. They are a popular tool among data scientists and researchers but have also adapted for use in other fields, such as cybersecurity.&lt;/p&gt;
&lt;h1 id="my-additions-to-the-blue-jupyter"&gt;My Additions to the Blue-Jupyter&lt;/h1&gt;
&lt;p&gt;Many of the changes I've made are focused on automating the process of quickly looking for interesting new samples to investigate.&lt;/p&gt;
&lt;p&gt;One addition to the notebook is the automated downloading of samples from &lt;a href="https://bazaar.abuse.ch/"&gt;Malware Bazaar&lt;/a&gt;. This can download a maximum of 100 samples continuously. Additional information is listed to highlight some interesting points about the sample, like the malware signature. It also can skip samples that have already been downloaded to save bandwidth.&lt;/p&gt;
&lt;p&gt;&lt;img alt="adding-automation-to-blue-jupyter-malware-notebook-01" src="https://www.accidentalrebel.com/images/adding-automation-to-blue-jupyter-malware-notebook-01.png" /&gt;&lt;/p&gt;
&lt;p&gt;The second significant addition is the automated generation of &lt;a href="https://github.com/mandiant/capa"&gt;Capa&lt;/a&gt; results for each downloaded sample. This makes it easy to see which malware has a particular capability so I can quickly see which ones are interesting enough to investigate further.&lt;/p&gt;
&lt;p&gt;&lt;img alt="adding-automation-to-blue-jupyter-malware-notebook-02" src="https://www.accidentalrebel.com/images/adding-automation-to-blue-jupyter-malware-notebook-02.png" /&gt;&lt;/p&gt;
&lt;p&gt;I also added minor improvements like error handling, additional logging for troubleshooting, and some cleanup code just in case I want to start fresh.&lt;/p&gt;
&lt;h1 id="check-it-out"&gt;Check it out&lt;/h1&gt;
&lt;p&gt;If you are interested in checking it out, you can view my fork of the repository &lt;a href="https://github.com/accidentalrebel/blue-jupyter/blob/main/malware-analysis/Malware-Analysis.ipynb"&gt;here&lt;/a&gt;. I did not request for a pull request on the original branch because I've changed a lot of things that the original owner might not prefer to have. Of course, I encourage everyone to fork what I made and make it their own. That's the beauty of Jupyter notebooks, anyway.&lt;/p&gt;</content><category term="Malware Analysis"/><category term="malware"/><category term="re"/><category term="jupyter"/></entry><entry><title>Talking about Mitre's Malware Behavior Catalog</title><link href="https://www.accidentalrebel.com/talking-about-mitres-malware-behavior-catalog.html" rel="alternate"/><published>2022-08-02T15:06:00+08:00</published><updated>2022-08-02T15:06:00+08:00</updated><author><name>AccidentalRebel</name></author><id>tag:www.accidentalrebel.com,2022-08-02:/talking-about-mitres-malware-behavior-catalog.html</id><summary type="html">&lt;p&gt;I gave a 10-minute lightning talk at the recently concluded Blackhat Middle East &amp;amp; Africa community meetup. The topic is about Mitre's Malware Behavior Catalog (MBC) framework and the existing tools for it. My reason for selecting this topic is because I feel that more people should know about Mitre's not-so-well-known project.&lt;/p&gt;
&lt;p&gt;&lt;img alt="talking-about-mitres-malware-behavior-catalog-01" src="https://www.accidentalrebel.com/images/talking-about-mitres-malware-behavior-catalog-01.png" /&gt;&lt;/p&gt;
&lt;h2 id="a-brief-overview"&gt;A brief overview&lt;/h2&gt;
&lt;p&gt;MBC is a framework made by Mitre, similar to ATT&amp;amp;CK, but focuses on malware. It lists down the common objectives and behaviors commonly seen in malware. The purpose is to have standardize reporting so that everyone would use the same definitions when writing and talking about malware. This also aids with analysis and correlation with other tools.&lt;/p&gt;
&lt;p&gt;It has it's own matrix with malware objectives as headers for columns and an entry for each behavior. Each behavior then has a list of methods that explains how that behavior is achieved, example of malware that uses …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I gave a 10-minute lightning talk at the recently concluded Blackhat Middle East &amp;amp; Africa community meetup. The topic is about Mitre's Malware Behavior Catalog (MBC) framework and the existing tools for it. My reason for selecting this topic is because I feel that more people should know about Mitre's not-so-well-known project.&lt;/p&gt;
&lt;p&gt;&lt;img alt="talking-about-mitres-malware-behavior-catalog-01" src="https://www.accidentalrebel.com/images/talking-about-mitres-malware-behavior-catalog-01.png" /&gt;&lt;/p&gt;
&lt;h2 id="a-brief-overview"&gt;A brief overview&lt;/h2&gt;
&lt;p&gt;MBC is a framework made by Mitre, similar to ATT&amp;amp;CK, but focuses on malware. It lists down the common objectives and behaviors commonly seen in malware. The purpose is to have standardize reporting so that everyone would use the same definitions when writing and talking about malware. This also aids with analysis and correlation with other tools.&lt;/p&gt;
&lt;p&gt;It has it's own matrix with malware objectives as headers for columns and an entry for each behavior. Each behavior then has a list of methods that explains how that behavior is achieved, example of malware that uses it, and also IDs of ATT&amp;amp;CK techniques related to the behavior.&lt;/p&gt;
&lt;p&gt;&lt;img alt="talking-about-mitres-malware-behavior-catalog-02" src="https://www.accidentalrebel.com/images/talking-about-mitres-malware-behavior-catalog-02.png" /&gt;&lt;/p&gt;
&lt;h2 id="the-tools"&gt;The tools&lt;/h2&gt;
&lt;p&gt;There are a number of existing tools that make use of MBC. &lt;a href="https://github.com/mandiant/capa"&gt;Flare's Capa&lt;/a&gt; lists down MBC along with the related ATT&amp;amp;CK techniques and there's also a repository of MBC community rules for the Cuckoo Sandox.&lt;/p&gt;
&lt;p&gt;I find MBC to have a lot of potential so I decided to contribute by making my own tool called &lt;a href="https://github.com/accidentalrebel/mbcscan"&gt;MBCScan&lt;/a&gt;. It's a simple tool that uses Capa which scans a supplied file and lists the MBC behaviors and objectives associated with it. It also allows you to explore the related information and relationships directly from the command line.&lt;/p&gt;
&lt;p&gt;&lt;img alt="talking-about-mitres-malware-behavior-catalog-03" src="https://www.accidentalrebel.com/images/talking-about-mitres-malware-behavior-catalog-03.png" /&gt;&lt;/p&gt;
&lt;h2 id="the-future"&gt;The future&lt;/h2&gt;
&lt;p&gt;MBC has been around for a number of years already but it still has not risen in popularity. In spite of this, it's still being continuously updated. I hope that by sharing and talking about it it'll help spread awareness and, hopefully, get some adoption.&lt;/p&gt;
&lt;p&gt;You can find more information about the project via this &lt;a href="https://www.youtube.com/watch?v=qZef-SoREdY"&gt;video presentation from Mitre&lt;/a&gt;. The Github project is &lt;a href="https://github.com/MBCProject"&gt;here&lt;/a&gt;. And the slides are available &lt;a href="https://docs.google.com/presentation/d/1w89wccaYr2g6104l73Xt2IUMGis_zgTB6krRC1q09Dw/edit?usp=sharing"&gt;here&lt;/a&gt;. &lt;/p&gt;</content><category term="Malware Analysis"/><category term="malware"/><category term="analysis"/><category term="mitre"/><category term="mbc"/></entry><entry><title>Building my Virtual Cybersecurity Home Lab</title><link href="https://www.accidentalrebel.com/building-my-virtual-cybersecurity-home-lab.html" rel="alternate"/><published>2021-09-05T20:33:00+08:00</published><updated>2021-09-05T20:33:00+08:00</updated><author><name>AccidentalRebel</name></author><id>tag:www.accidentalrebel.com,2021-09-05:/building-my-virtual-cybersecurity-home-lab.html</id><summary type="html">&lt;p&gt;I have recently realized that one part of cybersecurity that I am lacking basic knowledge on is networking. I honestly did not think it was important when I was starting. It was the reason why I skipped Network+ so I could take Security+ directly. &lt;/p&gt;
&lt;p&gt;Now I know better.&lt;/p&gt;
&lt;p&gt;Ever since my realization, I have taken steps to patch the holes in my knowledge. I've started taking courses and bought books. But one thing that has made the most impact is me building my very own "homelab".&lt;/p&gt;
&lt;p&gt;I first came to know of the concept of homelabs &lt;a href="https://www.reddit.com/r/homelab/"&gt;from Reddit&lt;/a&gt;. To those unfamiliar, it is the practice of building a networked environment to gain practical knowledge in networking and IT. One way to do this is by making a virtual network.&lt;/p&gt;
&lt;p&gt;And so, over the past month, I have been building my very own virtual homelab with a focus on integrating cybersecurity …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I have recently realized that one part of cybersecurity that I am lacking basic knowledge on is networking. I honestly did not think it was important when I was starting. It was the reason why I skipped Network+ so I could take Security+ directly. &lt;/p&gt;
&lt;p&gt;Now I know better.&lt;/p&gt;
&lt;p&gt;Ever since my realization, I have taken steps to patch the holes in my knowledge. I've started taking courses and bought books. But one thing that has made the most impact is me building my very own "homelab".&lt;/p&gt;
&lt;p&gt;I first came to know of the concept of homelabs &lt;a href="https://www.reddit.com/r/homelab/"&gt;from Reddit&lt;/a&gt;. To those unfamiliar, it is the practice of building a networked environment to gain practical knowledge in networking and IT. One way to do this is by making a virtual network.&lt;/p&gt;
&lt;p&gt;And so, over the past month, I have been building my very own virtual homelab with a focus on integrating cybersecurity products.&lt;/p&gt;
&lt;h1 id="the-lab"&gt;The Lab&lt;/h1&gt;
&lt;p&gt;The network diagram below shows the current implementation of my lab. I will be discussing each part to give an idea of their purpose (&lt;a href="https://www.accidentalrebel.com/images/building-my-virtual-cybersecurity-home-lab-00.png"&gt;Click here for a bigger version&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;&lt;img alt="building-my-virtual-cybersecurity-home-lab-01" src="https://www.accidentalrebel.com/images/building-my-virtual-cybersecurity-home-lab-01.png" /&gt;&lt;/p&gt;
&lt;p&gt;At the heart of the network is a firewall running &lt;a href="https://www.pfsense.org/"&gt;pfSense&lt;/a&gt;. Its purpose is to ensure that each sub-network is separated and protected, and also to protect my virtual host from any malware outbreaks. This machine also serves as a DHCP and NTP server to all the machines in the network.&lt;/p&gt;
&lt;p&gt;&lt;img alt="building-my-virtual-cybersecurity-home-lab-13" src="https://www.accidentalrebel.com/images/building-my-virtual-cybersecurity-home-lab-13.png" /&gt;&lt;/p&gt;
&lt;h1 id="the-target-network"&gt;The Target Network&lt;/h1&gt;
&lt;p&gt;On the right side of the diagram is the "Target" network where workstations and vulnerable servers reside. These are the machines that I use to attack with exploits and malware.&lt;/p&gt;
&lt;p&gt;&lt;img alt="building-my-virtual-cybersecurity-home-lab-02" src="https://www.accidentalrebel.com/images/building-my-virtual-cybersecurity-home-lab-02.png" /&gt;&lt;/p&gt;
&lt;p&gt;I have Metasploitable 2 and Metasploitable 3 machines that have various services turned on to play around with. I can learn about specific attacks by exploiting this machine, but I can also don my defenders hat and learn about how to secure them.&lt;/p&gt;
&lt;p&gt;The Windows and Linux machines will serve as typical workstations for various experiments.&lt;/p&gt;
&lt;p&gt;One of the perks of my job is that I get to play with different cybersecurity solutions. I currently have access to a few that I am able to use on my lab for testing.&lt;/p&gt;
&lt;p&gt;One solution that I am using right now is an EDR (Endpoint Detection and Response) (Sorry, I can't reveal which). Each machine has an EDR agent deployed which monitors for any malicious activities on the host. It has an anti-virus feature, anti-ransomware, and fileless attack monitoring. It's awesome stuff but I have yet to maximize this.&lt;/p&gt;
&lt;p&gt;An IDS (intrusion Detection System) running &lt;a href="https://www.snort.org/"&gt;Snort&lt;/a&gt; monitors the traffic for any malicious activity. Signatures are constantly updated to ensure that I can detect the latest types of attack. If it finds anything important, it then sends an alert to a SIEM (running &lt;a href="https://www.splunk.com/"&gt;Splunk&lt;/a&gt;) on the Management network.&lt;/p&gt;
&lt;p&gt;&lt;img alt="building-my-virtual-cybersecurity-home-lab-11" src="https://www.accidentalrebel.com/images/building-my-virtual-cybersecurity-home-lab-11.png" /&gt;&lt;/p&gt;
&lt;h1 id="the-management-network"&gt;The Management Network&lt;/h1&gt;
&lt;p&gt;On the left side of the diagram is the Managemnet network. This is where the management part of the EDR, IDS, and the SIEM can be accessed from my virtual host.&lt;/p&gt;
&lt;p&gt;&lt;img alt="building-my-virtual-cybersecurity-home-lab-03" src="https://www.accidentalrebel.com/images/building-my-virtual-cybersecurity-home-lab-03.png" /&gt;&lt;/p&gt;
&lt;p&gt;There's nothing special about this network, I do want to note though that I find it interesting the Snort IDS has two interfaces. One is used for access to the management page, and the other is for sniffing traffic on the Attacker network.&lt;/p&gt;
&lt;h1 id="the-operations-network"&gt;The Operations Network&lt;/h1&gt;
&lt;p&gt;At the bottom side of the diagram is the "Operations" network.&lt;/p&gt;
&lt;p&gt;A machine running Kali is placed here. I can launch attacks from this machine towards the vulnerable machines on the Target network. This machine also has OpenVAS scanner that helps in discovering vulnerabilities on the target machines.&lt;/p&gt;
&lt;p&gt;&lt;img alt="building-my-virtual-cybersecurity-home-lab-04" src="https://www.accidentalrebel.com/images/building-my-virtual-cybersecurity-home-lab-04.png" /&gt;&lt;/p&gt;
&lt;p&gt;A windows machine serves as my malware analysis lab. It contains a lot of malware analysis tools to aid with investigations. &lt;/p&gt;
&lt;p&gt;This machine is then connected to a &lt;a href="https://remnux.org/"&gt;Remnux&lt;/a&gt; Linux machine. All traffic from the Windows machine is port forwarded by Remnux. From here I can run Wireshark to inspect the traffic coming from the Windows malware lab and it can also spoof the network responses to influence the behavior of malware. If the Remnux machine is turned off, then the Windows machine is effectively cut off from the whole network. It's a really neat setup that &lt;a href="https://www.ariefprabowo.com/en/malware-analysis-en/personal-notes-building-a-malware-analysis-lab-environment/"&gt;I learned here&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id="the-present"&gt;The Present&lt;/h1&gt;
&lt;p&gt;While the main intent of the network is to learn networking and implementing cybersecurity products, I can also investigate malware and learn about exploits by launching attacks. So it has a lot of multiple uses, which is perfect for someone like me who gets interested in different aspects of cybersecurity.&lt;/p&gt;
&lt;p&gt;My host machine currently has 32GB, 8 cores, and a total of 1.75TB which may seem a lot but is not powerful enough for all the machines to run at the same time. As a workaround, I just open the machines that I need for a particular exercise.&lt;/p&gt;
&lt;p&gt;&lt;img alt="building-my-virtual-cybersecurity-home-lab-05" src="https://www.accidentalrebel.com/images/building-my-virtual-cybersecurity-home-lab-05.png" /&gt;&lt;/p&gt;
&lt;p&gt;For example, if I want to investigate malware then I only need the firewall, Remnux, and the windows malware lab open. But if I want to attack and run an exploit, while making sure that it gets detected, then I need the firewall, EDR, IPS, SIEM, Kali, and the target machine to be open at the same time. This easily consumes around 20GB+!&lt;/p&gt;
&lt;h1 id="the-future"&gt;The Future&lt;/h1&gt;
&lt;p&gt;Working on this homelab has taught me a lot of practical knowledge. It helped solidify a lot of networking concepts I've learned througout the years.&lt;/p&gt;
&lt;p&gt;I'm not stopping here though. I also plan to upgrade the Target network so it would better resemble an enterprise network. For example, setting up an active directory, an internal DNS server, and maybe even a mail server (why not?). This is so I could play around in detecting and remediating more varied enterprise-level scenarios.&lt;/p&gt;
&lt;p&gt;I am also hoping I could get access to more cybersecurity products so I could play around with them. A SOAR (Security Orchestration and Response) would be a nice addition that would work really well.&lt;/p&gt;
&lt;p&gt;But, of course, before I could do any of the above I first need to upgrade my RAM and add more cores!&lt;/p&gt;</content><category term="Malware Analysis"/><category term="malware"/><category term="dev"/></entry><entry><title>Making a RAT</title><link href="https://www.accidentalrebel.com/making-a-rat.html" rel="alternate"/><published>2021-07-13T14:56:00+08:00</published><updated>2021-07-13T14:56:00+08:00</updated><author><name>AccidentalRebel</name></author><id>tag:www.accidentalrebel.com,2021-07-13:/making-a-rat.html</id><summary type="html">&lt;p&gt;A Remote Access Tool (RAT) is used to remotely access a computer. It has legitimate uses but it can also be used for malicious purposes. I've seen it used in malware I've analyzed and I've always been curious as to how it works.&lt;/p&gt;
&lt;p&gt;I was following along the &lt;a href="https://handmadehero.org/"&gt;Handmade Hero project&lt;/a&gt; &lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1"&gt;1&lt;/a&gt;&lt;/sup&gt; when the topic about dynamic DLL loading came up. This is a process of dynamically loading a DLL at runtime which is useful if you want your program to check if a DLL is present in a system before loading it.&lt;/p&gt;
&lt;p&gt;Two of the system calls that were discussed were LoadLibrary and GetProcAddress. These were familiar to me as I've seen them used on malware shellcode I analyzed in the past. I later learned that this is also used as an anti-virus evasion technique. I found this interesting.&lt;/p&gt;
&lt;p&gt;Having learned how to do runtime DLL loading myself I …&lt;/p&gt;</summary><content type="html">&lt;p&gt;A Remote Access Tool (RAT) is used to remotely access a computer. It has legitimate uses but it can also be used for malicious purposes. I've seen it used in malware I've analyzed and I've always been curious as to how it works.&lt;/p&gt;
&lt;p&gt;I was following along the &lt;a href="https://handmadehero.org/"&gt;Handmade Hero project&lt;/a&gt; &lt;sup id="fnref:1"&gt;&lt;a class="footnote-ref" href="#fn:1"&gt;1&lt;/a&gt;&lt;/sup&gt; when the topic about dynamic DLL loading came up. This is a process of dynamically loading a DLL at runtime which is useful if you want your program to check if a DLL is present in a system before loading it.&lt;/p&gt;
&lt;p&gt;Two of the system calls that were discussed were LoadLibrary and GetProcAddress. These were familiar to me as I've seen them used on malware shellcode I analyzed in the past. I later learned that this is also used as an anti-virus evasion technique. I found this interesting.&lt;/p&gt;
&lt;p&gt;Having learned how to do runtime DLL loading myself I decided to give it a try. And of course, a RAT is perfect for this.&lt;/p&gt;
&lt;p&gt;&lt;img alt="making-a-rat-01" src="https://www.accidentalrebel.com/images/making-a-rat-01.png" /&gt;&lt;/p&gt;
&lt;h2 id="planning-the-ratchitecture"&gt;Planning the RATchitecture&lt;/h2&gt;
&lt;p&gt;A lot of famous RATs are packed with features like the ability to log keystrokes, take screenshots, and turn on a webcam. I just want mine to be simple and have basic functionality like:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Execute command line commands remotely&lt;/li&gt;
&lt;li&gt;Download a file to the client&lt;/li&gt;
&lt;li&gt;Exfiltrate data via file upload&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can already do a lot of things even with the above basic functions. You can download a payload to the client, run it via remote command and then upload the results. You can even update the RAT itself using the same process!&lt;/p&gt;
&lt;p&gt;As an extra, I also wanted it to be stealthy. I am aware however that this is something that is not easily done. There are myriads of security defenses and I don't think I have the time and energy to have my RAT to be up-to-date with the latest evasion techniques. Having basic anti-debugging and anti-sandbox checks is enough for me.&lt;/p&gt;
&lt;p&gt;I've never made a RAT before but thankfully there are a lot of great resources online that helped me a lot:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/quantumcore/paradoxiaRAT"&gt;ParadoxiaRat&lt;/a&gt; is my main resource and has done a lot of the features I wanted to implement.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/yatt-ze/The-Collection/tree/master/Source%20Codes/Botnets/DarkRat%20Loader/derkrut"&gt;DarkRAT&lt;/a&gt; is a leaked source code that gave me an idea of how a RAT used in the wild looks like&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/vxunderground/WinAPI-Tricks"&gt;VXUnderground's WinAPI tricks&lt;/a&gt; taught me that there are alternative ways to do certain things to avoid detection&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As for the name of the project, I decided on "RATwurst" after the german sausage, Bratwurst. Don't ask me why. I just thought it's funny that it had the letters RAT in it.&lt;/p&gt;
&lt;p&gt;&lt;img alt="making-a-rat-02" src="https://www.accidentalrebel.com/images/making-a-rat-02.png" /&gt;&lt;/p&gt;
&lt;h2 id="the-nitty-gratty-details"&gt;The nitty gRATty details&lt;/h2&gt;
&lt;p&gt;The client is written in ANSI C because it's the language I prefer. Since I am only targeting Windows I chose MSVC for the compiler. Which is great because it allows me to use Visual Studio for debugging.&lt;/p&gt;
&lt;p&gt;The server, on the other hand, is written in Python because I wanted another excuse to practice with it. Choosing Python has been a good choice though because of the excellent low level &lt;a href="https://docs.python.org/3/library/socket.html"&gt;socket&lt;/a&gt; and &lt;a href="https://docs.python.org/3/library/cmd.html"&gt;cmd&lt;/a&gt; libraries.&lt;/p&gt;
&lt;p&gt;Sockets are used for communication between client and server. I've applied basic XOR obfuscation to the data to mask the traffic. The client and server can handle sending of strings and even executables over the network.&lt;/p&gt;
&lt;p&gt;When RATwurst is first executed. It does some anti-sandbox checks via process enumeration. It checks if there are more than 15 processe that are running and if there are virtualization tools present like &lt;code&gt;vmware.exe&lt;/code&gt;. It will also setup an auto-run registry entry for persistence. And also move the executable to Windows' temp folder and re-run it from there.&lt;/p&gt;
&lt;p&gt;Anti-debbuging checks are littered throughout the code which checks the amount of time it takes to reach from one part of the code to the next. This is used to detect if someone is stepping through the code, increasing the delay between code execution.&lt;/p&gt;
&lt;p&gt;When no shenanigans is detected then it'll proceed to work as intended. &lt;/p&gt;
&lt;p&gt;&lt;img alt="making-a-rat-02" src="https://www.accidentalrebel.com/images/making-a-rat-02.png" /&gt;&lt;/p&gt;
&lt;h2 id="for-edurational-purposes-only"&gt;For eduRATional purposes only&lt;/h2&gt;
&lt;p&gt;I've made the source of my project &lt;a href="https://github.com/accidentalrebel/ratwurst"&gt;available on Github&lt;/a&gt;. The aim is to share what I've learned so that others can learn too.&lt;/p&gt;
&lt;p&gt;I am aware of news of RAT authors having been arrested because of their work. They actively sought to gain money from their creation, I, of course, have no such plans.&lt;/p&gt;
&lt;p&gt;To make sure that I save myself from any legal problems, I've placed a disclaimer that I am not responsible for any misuse. While I am skeptical that a piece of text would prevent any legal action towards me, I do see other projects having their own disclaimers so I decided to do the same.&lt;/p&gt;
&lt;p&gt;I've also submitted my creation to a multi-scanner service like VirusTotal. This would help distribute my RATs signature to anti-virus companies so it can easily be detected when used in the wild.&lt;sup id="fnref:2"&gt;&lt;a class="footnote-ref" href="#fn:2"&gt;2&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;
&lt;h2 id="a-ratisfying-learning-experience"&gt;A RATisfying learning experience&lt;/h2&gt;
&lt;p&gt;Making this project has been a lot of fun. &lt;/p&gt;
&lt;p&gt;The most useful thing that I learned is the client and server communication via sockets. I've dabbled with it before but only in this project have I actually sent actual data back and forth.&lt;/p&gt;
&lt;p&gt;I am also happy that I got to use more Windows APIs. It's fun to play around with what's available and it is opening my mind as to what other things I can make in the future.&lt;/p&gt;
&lt;p&gt;And of course, this project has given me a good insight into the techniques used by malware. Learning about them is not enough until you've built one yourself.&lt;/p&gt;
&lt;div class="footnote"&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id="fn:1"&gt;
&lt;p&gt;Handmade here is a project by Casey Muratori where a game is created from scratch live on stream, has been going on for 6+ years, it's awesome&amp;#160;&lt;a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li id="fn:2"&gt;
&lt;p&gt;Multi-scanners help to easily distribute virus signatures to security services. An opposite to this are "no-distribute" sacnners. More info about this &lt;a href="https://www.bleepingcomputer.com/news/security/75-percent-of-malware-uploaded-on-no-distribute-scanners-is-unknown-to-researchers/"&gt;here&lt;/a&gt;.&amp;#160;&lt;a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text"&gt;&amp;#8617;&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;</content><category term="Malware Analysis"/><category term="malware"/><category term="dev"/></entry><entry><title>Maldoc101 Writeup (Part 2)</title><link href="https://www.accidentalrebel.com/maldoc101-writeup-part-2.html" rel="alternate"/><published>2021-03-14T08:34:00+08:00</published><updated>2021-03-14T08:34:00+08:00</updated><author><name>AccidentalRebel</name></author><id>tag:www.accidentalrebel.com,2021-03-14:/maldoc101-writeup-part-2.html</id><content type="html">&lt;p&gt;This is part 2 of my writeup for the Maldoc101 challenge. Check out &lt;a href="https://www.accidentalrebel.com/maldoc101-writeup-part-1.html"&gt;part 1&lt;/a&gt; for the beginning of the analysis.&lt;/p&gt;
&lt;p&gt;The next couple of lines does the same concatenating technique similar to the previous steps. &lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;deaknaugthein = roubhaol.kaizseah.ControlTipText
giakfeiw = deulsaocthuul + gooykadheoj + roubhaol.paerwagyouqumeid.ControlTipText + deaknaugthein
queegthaen = giakfeiw + roubhaol.joefwoefcheaw
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;At the end of the code above &lt;code&gt;queegthaen&lt;/code&gt; now contains the value &lt;code&gt;Win32_Process&lt;/code&gt; + &lt;code&gt;s&lt;/code&gt; + &lt;code&gt;tar&lt;/code&gt; + &lt;code&gt;tu&lt;/code&gt; + &lt;code&gt;P&lt;/code&gt;. Or when combined creates the string &lt;code&gt;Win32_ProcessstartuP&lt;/code&gt; which probably refers &lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-processstartup"&gt;to this WMI class&lt;/a&gt; in the Microsoft docs.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Note: This writeup appears to be incomplete. For the complete analysis, please refer to &lt;a href="https://www.accidentalrebel.com/maldoc101-writeup-part-1.html"&gt;part 1&lt;/a&gt; of this series.&lt;/em&gt;&lt;/p&gt;</content><category term="Malware Analysis"/><category term="re"/><category term="malware_analysis"/><category term="malware"/></entry><entry><title>Maldoc101 Writeup (Part 1)</title><link href="https://www.accidentalrebel.com/maldoc101-writeup-part-1.html" rel="alternate"/><published>2021-03-13T08:34:00+08:00</published><updated>2021-03-13T08:34:00+08:00</updated><author><name>AccidentalRebel</name></author><id>tag:www.accidentalrebel.com,2021-03-13:/maldoc101-writeup-part-1.html</id><summary type="html">&lt;p&gt;This is part 1 out of 2 of my writeup for the Maldoc101 challenge made by Josh Stroschein (&lt;a href="https://twitter.com/jstrosch"&gt;@jstrosch&lt;/a&gt;) and is currently playable at &lt;a href="https://cyberdefenders.org/labs/51"&gt;Cyberdefenders.Org&lt;/a&gt;. I've done some maldoc analysis before but this is the first time I'm writing about my approach.&lt;/p&gt;
&lt;p&gt;There is also an already existing writeup about this challenge &lt;a href="https://github.com/jstrosch/malware-samples/blob/master/malware_analysis_exercises/2020/December/solution.md"&gt;from the creator himself&lt;/a&gt;. You should check that out if you want a more detailed and focused writeup. This writeup is more from the perspective of someone relatively new to malware analysis. There's a lot more exploration and trial-and-error which, I hope, might give the reader a different view in how this kind of problem is approached.&lt;/p&gt;
&lt;h2 id="the-challenge"&gt;The challenge&lt;/h2&gt;
&lt;h3 id="name"&gt;Name&lt;/h3&gt;
&lt;p&gt;&lt;a href="https://cyberdefenders.org/labs/51"&gt;MalDoc101 - Malicious Document&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="description"&gt;Description&lt;/h3&gt;
&lt;p&gt;It is common for threat actors to utilize living off the land (LOTL) techniques, such as the execution of PowerShell to further their attacks and transition from macro code. This challenge is intended …&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is part 1 out of 2 of my writeup for the Maldoc101 challenge made by Josh Stroschein (&lt;a href="https://twitter.com/jstrosch"&gt;@jstrosch&lt;/a&gt;) and is currently playable at &lt;a href="https://cyberdefenders.org/labs/51"&gt;Cyberdefenders.Org&lt;/a&gt;. I've done some maldoc analysis before but this is the first time I'm writing about my approach.&lt;/p&gt;
&lt;p&gt;There is also an already existing writeup about this challenge &lt;a href="https://github.com/jstrosch/malware-samples/blob/master/malware_analysis_exercises/2020/December/solution.md"&gt;from the creator himself&lt;/a&gt;. You should check that out if you want a more detailed and focused writeup. This writeup is more from the perspective of someone relatively new to malware analysis. There's a lot more exploration and trial-and-error which, I hope, might give the reader a different view in how this kind of problem is approached.&lt;/p&gt;
&lt;h2 id="the-challenge"&gt;The challenge&lt;/h2&gt;
&lt;h3 id="name"&gt;Name&lt;/h3&gt;
&lt;p&gt;&lt;a href="https://cyberdefenders.org/labs/51"&gt;MalDoc101 - Malicious Document&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="description"&gt;Description&lt;/h3&gt;
&lt;p&gt;It is common for threat actors to utilize living off the land (LOTL) techniques, such as the execution of PowerShell to further their attacks and transition from macro code. This challenge is intended to show how you can often times perform quick analysis to extract important IOCs. The focus of this exercise is on static techniques for analysis.&lt;/p&gt;
&lt;h3 id="suggested-tools"&gt;Suggested Tools&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;REMnux Virtual Machine (remnux.org)&lt;/li&gt;
&lt;li&gt;Terminal/Command prompt w/ Python installed&lt;/li&gt;
&lt;li&gt;Oledump&lt;/li&gt;
&lt;li&gt;Text editor&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="the-easy-questions"&gt;The easy questions&lt;/h2&gt;
&lt;p&gt;The first question seems very easy. The &lt;em&gt;suggested tools&lt;/em&gt; section above also gives us an idea how to approach this.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;What streams contain macros in this document? (comma-separated, ascending).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href="https://blog.didierstevens.com/programs/oledump-py/"&gt;oledump.py&lt;/a&gt; is a tool made by &lt;a href="https://blog.didierstevens.com/about/"&gt;Didier Stevens&lt;/a&gt; that allows the analysis of data streams found in OLE files such as MS Office documetns. Running the command below would show us which streams have macros in it. These are denoted with the character &lt;em&gt;M&lt;/em&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gp"&gt;$ &lt;/span&gt;oledump.py&lt;span class="w"&gt; &lt;/span&gt;sample.bin
&lt;span class="go"&gt;  1:       114 &amp;#39;\x01CompObj&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  2:      4096 &amp;#39;\x05DocumentSummaryInformation&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  3:      4096 &amp;#39;\x05SummaryInformation&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  4:      7119 &amp;#39;1Table&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  5:    101483 &amp;#39;Data&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  6:       581 &amp;#39;Macros/PROJECT&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  7:       119 &amp;#39;Macros/PROJECTwm&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  8:     12997 &amp;#39;Macros/VBA/_VBA_PROJECT&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt;  9:      2112 &amp;#39;Macros/VBA/__SRP_0&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 10:       190 &amp;#39;Macros/VBA/__SRP_1&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 11:       532 &amp;#39;Macros/VBA/__SRP_2&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 12:       156 &amp;#39;Macros/VBA/__SRP_3&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 13: M    1367 &amp;#39;Macros/VBA/diakzouxchouz&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 14:       908 &amp;#39;Macros/VBA/dir&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 15: M    5705 &amp;#39;Macros/VBA/govwiahtoozfaid&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 16: m    1187 &amp;#39;Macros/VBA/roubhaol&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; 17:        97 &amp;#39;Macros/roubhaol/\x01CompObj&amp;#39;&lt;/span&gt;
&lt;span class="go"&gt; ...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I later noticed that there is an upper-case and lower-case &lt;em&gt;M&lt;/em&gt;. I learned that the upper-case &lt;em&gt;M&lt;/em&gt; denotes a macro with a code. The lower-case denotes a user form. This is a distinction that will be important later in this challenge.&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;
&lt;p&gt;What command-line argument with Oledump do you use to view the raw content of a stream? (Do not include the leading dash) &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The next question is another easy one which ran easily be solved through &lt;code&gt;oledump.py&lt;/code&gt;'s &lt;em&gt;--help&lt;/em&gt; parameter.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gp"&gt;$ &lt;/span&gt;oledump.py&lt;span class="w"&gt; &lt;/span&gt;--help
&lt;span class="go"&gt;Usage: oledump.py [options] [file]&lt;/span&gt;
&lt;span class="go"&gt;Analyze OLE files (Compound Binary Files)&lt;/span&gt;

&lt;span class="go"&gt;Options:&lt;/span&gt;
&lt;span class="go"&gt;  --version             show program&amp;#39;s version number and exit&lt;/span&gt;
&lt;span class="go"&gt;  -h, --help            show this help message and exit&lt;/span&gt;
&lt;span class="go"&gt;  -m, --man             Print manual&lt;/span&gt;
&lt;span class="go"&gt;  -s SELECT, --select=SELECT&lt;/span&gt;
&lt;span class="go"&gt;                        select item nr for dumping (a for all)&lt;/span&gt;
&lt;span class="go"&gt;  -d, --dump            perform dump&lt;/span&gt;
&lt;span class="go"&gt;  -x, --hexdump         perform hex dump&lt;/span&gt;
&lt;span class="go"&gt;  -a, --asciidump       perform ascii dump&lt;/span&gt;
&lt;span class="go"&gt;  -A, --asciidumprle    perform ascii dump with RLE&lt;/span&gt;
&lt;span class="go"&gt;  -S, --strings         perform strings dump&lt;/span&gt;
&lt;span class="go"&gt;  -T, --headtail        do head &amp;amp; tail&lt;/span&gt;
&lt;span class="go"&gt;  -v, --vbadecompress   VBA decompression&lt;/span&gt;
&lt;span class="go"&gt;  ...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The answer to question number two is easy to spot.&lt;/p&gt;
&lt;hr /&gt;
&lt;blockquote&gt;
&lt;p&gt;What event is used to begin the execution of the macros?  &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I used a different tool for this particular question mostly because I knew that it already shows the information I need to answer the question. The tool is called &lt;code&gt;olevba&lt;/code&gt; which is part of the &lt;a href="https://github.com/decalage2/oletools"&gt;oletools&lt;/a&gt; package of Python tools. &lt;em&gt;Olevba&lt;/em&gt; is used for extracting and analyzing VBA macro source code for MS Office documents.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gp"&gt;$ &lt;/span&gt;olevba&lt;span class="w"&gt; &lt;/span&gt;sample.bin
&lt;span class="go"&gt;+----------+--------------------+---------------------------------------------+&lt;/span&gt;
&lt;span class="go"&gt;|Type      |Keyword             |Description                                  |&lt;/span&gt;
&lt;span class="go"&gt;+----------+--------------------+---------------------------------------------+&lt;/span&gt;
&lt;span class="go"&gt;|AutoExec  |Document_open       |Runs when the Word or Publisher document is  |&lt;/span&gt;
&lt;span class="go"&gt;|          |                    |opened                                       |&lt;/span&gt;
&lt;span class="go"&gt;|Suspicious|Create              |May execute file or a system command through |&lt;/span&gt;
&lt;span class="go"&gt;|          |                    |WMI                                          |&lt;/span&gt;
&lt;span class="go"&gt;|Suspicious|showwindow          |May hide the application                     |&lt;/span&gt;
&lt;span class="go"&gt;|Suspicious|CreateObject        |May create an OLE object                     |&lt;/span&gt;
&lt;span class="go"&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;h2 id="onto-the-main-event"&gt;Onto the main event&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;What malware family was this maldoc attempting to drop?&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I figured that the way for me to determine the answer for the question above is to start investigating the macro codes included in the document.&lt;/p&gt;
&lt;p&gt;I knew from the previous question that the entry point to begin the execution of the macros is with the function &lt;code&gt;Document_open()&lt;/code&gt;. The next step is to look for this entry point and go through the code to understand what the macro is doing.&lt;/p&gt;
&lt;p&gt;To view the contents of a stream, I used the command below:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="gp"&gt;$ &lt;/span&gt;oledump.py&lt;span class="w"&gt; &lt;/span&gt;sample.bin&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;13&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-v
&lt;span class="go"&gt;Attribute VB_Name = &amp;quot;diakzouxchouz&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_Base = &amp;quot;1Normal.ThisDocument&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_GlobalNameSpace = False&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_Creatable = False&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_PredeclaredId = True&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_Exposed = True&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_TemplateDerived = True&lt;/span&gt;
&lt;span class="go"&gt;Attribute VB_Customizable = True&lt;/span&gt;
&lt;span class="go"&gt;Private Sub _&lt;/span&gt;
&lt;span class="go"&gt;Document_open()&lt;/span&gt;
&lt;span class="go"&gt;boaxvoebxiotqueb&lt;/span&gt;
&lt;span class="go"&gt;End Sub&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In the above output, I saw that &lt;code&gt;Document_open()&lt;/code&gt; contains a single line of code which is a call to function &lt;code&gt;boaxvoebxiotqueb'&lt;/code&gt;. This function is included in stream &lt;code&gt;15&lt;/code&gt; which can be viewed with the command:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;$&lt;span class="w"&gt; &lt;/span&gt;oledump.py&lt;span class="w"&gt; &lt;/span&gt;sample.bin&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;13&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-v
Attribute&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;VB_Name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;govwiahtoozfaid&amp;quot;&lt;/span&gt;
Function&lt;span class="w"&gt; &lt;/span&gt;boaxvoebxiotqueb&lt;span class="o"&gt;()&lt;/span&gt;
&lt;span class="nv"&gt;gooykadheoj&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;Chr&lt;span class="o"&gt;(&lt;/span&gt;roubhaol.Zoom&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;Int&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;*&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;
Dim&lt;span class="w"&gt; &lt;/span&gt;c7�ATOQe2�j&lt;span class="w"&gt; &lt;/span&gt;As&lt;span class="w"&gt; &lt;/span&gt;Integer
c7�ATOQe2�j&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;6&lt;/span&gt;
Do&lt;span class="w"&gt; &lt;/span&gt;While&lt;span class="w"&gt; &lt;/span&gt;c7�ATOQe2�j&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;6&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
c7�ATOQe2�j&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;c7�ATOQe2�j&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;DoEvents
Loop
&lt;span class="nv"&gt;haothkoebtheil&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqw2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqm2342772g3&amp;amp;*gs7712ffvs626fqgm2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqt2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;gooykadheoj&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fq:w2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq322342772g3&amp;amp;*gs7712ffvs626fq_2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;roubhaol.joefwoefcheaw&lt;span class="w"&gt; &lt;/span&gt;+&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2342772g3&amp;amp;*gs7712ffvs626fqr2342772g3&amp;amp;*gs7712ffvs626fqo2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqc2342772g3&amp;amp;*gs7712ffvs626fqes2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;&lt;/span&gt;
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The above output contains more lines of what looks like gibberish code. Upon further inspection I realized that it's actually obfuscated. I can see common coding patterns which tells me that I could make sense of the code if I step through it and organize it so it is easy to understand.&lt;/p&gt;
&lt;p&gt;The first line of the &lt;code&gt;boaxvoebxiotqueb&lt;/code&gt; shows:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;gooykadheoj = Chr(roubhaol.Zoom + Int(5 * 3))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;What's &lt;code&gt;roubhaol&lt;/code&gt;? Since this is the first line in the function, I know that it is not a locally defined variable. It must be declared somplace else.&lt;/p&gt;
&lt;p&gt;After looking around I learned that &lt;code&gt;roubhaol&lt;/code&gt; is a the name of the user form at stream &lt;em&gt;16&lt;/em&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="go"&gt;16: m    1187 &amp;#39;Macros/VBA/roubhaol&amp;#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;So the next step is figuring out what &lt;code&gt;roubhaol.Zoom&lt;/code&gt;'s value is. This value is not set anywhere in any of the macros by code. This means that the value is set in the form itself. To confirm, I opened up the Word document, pressed &lt;code&gt;Alt+F11&lt;/code&gt; to open up the Visual Basic editor and then opened the &lt;code&gt;roubhaol&lt;/code&gt; form. At the bottom we see that the value of &lt;code&gt;Zoom&lt;/code&gt; is set to &lt;code&gt;100&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img alt="maldoc101-writeup-01" src="https://www.accidentalrebel.com/images/maldoc101-writeup-01.png" /&gt;&lt;/p&gt;
&lt;p&gt;This means that by simulating the first line of code again we find that the variable &lt;code&gt;gooykadheoj&lt;/code&gt; gets the character value of &lt;code&gt;s&lt;/code&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;gooykadheoj = Chr(roubhaol.Zoom + Int(5 &lt;span class="gs"&gt;* 3))&lt;/span&gt;
&lt;span class="gs"&gt;gooykadheoj = Chr(100 + Int(5 *&lt;/span&gt; 3))
gooykadheoj = Chr(115)
gooykadheoj = Chr(115) # character &amp;quot;s&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;I then proceeded to go through the next set of lines.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="nv"&gt;Dim&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;c7&lt;/span&gt;�&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;�&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;As&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;Integer&lt;/span&gt;
&lt;span class="nv"&gt;c7&lt;/span&gt;�&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;�&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;
&lt;span class="k"&gt;Do&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;While&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;c7&lt;/span&gt;�&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;�&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="nv"&gt;c7&lt;/span&gt;�&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;�&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;c7&lt;/span&gt;�&lt;span class="nv"&gt;ATOQe2&lt;/span&gt;�&lt;span class="nv"&gt;j&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;DoEvents&lt;/span&gt;
&lt;span class="k"&gt;Loop&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This one is easier to simulate. &lt;code&gt;c7�ATOQe2�j&lt;/code&gt; is assigend 6. And then there's a loop that adds &lt;code&gt;5&lt;/code&gt; that eventually results to the value of &lt;code&gt;16&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;But wait, something is fishy here. The variable &lt;code&gt;c7�ATOQe2�j&lt;/code&gt; is not found anywhere else after the block of code above. This tells us that this is just junk code that does not really do anything aside from waste an analyst's time! Sneaky sneaky.&lt;/p&gt;
&lt;p&gt;To save me the time I proceeded to remove all junk code. I did this by going through each variables and seeing if they are used somewhere useful. If not, then they are safe to remove.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;Attribute VB_Name = &amp;quot;govwiahtoozfaid&amp;quot;
Function boaxvoebxiotqueb()
    gooykadheoj = Chr(roubhaol.Zoom + Int(5 * 3))

    haothkoebtheil = &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqw2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqm2342772g3&amp;amp;*gs7712ffvs626fqgm2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqt2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot; + gooykadheoj + &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fq:w2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq322342772g3&amp;amp;*gs7712ffvs626fq_2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot; + roubhaol.joefwoefcheaw + &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fqr2342772g3&amp;amp;*gs7712ffvs626fqo2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqc2342772g3&amp;amp;*gs7712ffvs626fqes2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;

    deulsaocthuul = juuvzouchmiopxeox(haothkoebtheil)

    Set tiajriokchaoy = CreateObject(deulsaocthuul)

    deaknaugthein = roubhaol.kaizseah.ControlTipText
    giakfeiw = deulsaocthuul + gooykadheoj + roubhaol.paerwagyouqumeid.ControlTipText + deaknaugthein
    queegthaen = giakfeiw + roubhaol.joefwoefcheaw

    Set deavjoajsear = luumlaud(queegthaen)

    xve = Array &lt;span class="ge"&gt;_&lt;/span&gt;
&lt;span class="ge"&gt;        (&amp;quot;1234444123&amp;quot;, tiajriokchaoy. _&lt;/span&gt;
        Create(geulgelquuuj, kaenhaig, deavjoajsear), &amp;quot;9938723&amp;quot;)
End Function

Function juuvzouchmiopxeox(yiajthoavheiw)
    geutyoeytiestheug = yiajthoavheiw
    feaxgeip = Split(geutyoeytiestheug, &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;)

    jaquhoiqu = csqw + Join(feaxgeip, eihnx)
    juuvzouchmiopxeox = jaquhoiqu
End Function

Function geulgelquuuj()
    sjiqw = roubhaol.gaoddaicsauktheb.Pages(10 / 10).ControlTipText
    geulgelquuuj = juuvzouchmiopxeox(sjiqw)
End Function

Function luumlaud(zeolkaepxoag)
    Set luumlaud = CreateObject(zeolkaepxoag)
    Dim vPu As String
    vPu = Replace$(&amp;quot;BenqV1�igVwifwdQq&amp;quot;, &amp;quot;BenqV1�i&amp;quot;, &amp;quot;on5�&amp;quot;)
        luumlaud &lt;span class="ge"&gt;_&lt;/span&gt;
&lt;span class="ge"&gt;        . _&lt;/span&gt;
        showwindow = (mujgoiy + jioyseertioch) + (neivberziok + xuajroegquoudcaij)
End Function
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;As you can see above, the code is shorter. It's also a little easier to understand. Only a little though, we still need to step through the code carefully to have a better grasp of what it is doing.&lt;/p&gt;
&lt;p&gt;Let's take on the next line:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;haothkoebtheil = &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqw2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqm2342772g3&amp;amp;*gs7712ffvs626fqgm2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqt2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot; + gooykadheoj + &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fq:w2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq322342772g3&amp;amp;*gs7712ffvs626fq_2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot; + roubhaol.joefwoefcheaw + &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fqr2342772g3&amp;amp;*gs7712ffvs626fqo2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqc2342772g3&amp;amp;*gs7712ffvs626fqes2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;If we look at the string carefully we would notice that a set of strings is concatenated with two variables. These variables are &lt;code&gt;gooykadheoj&lt;/code&gt; and &lt;code&gt;roubhaol.joefwoefcheaw&lt;/code&gt;. We already know the value of &lt;code&gt;gooykadheoj&lt;/code&gt;. So what's the value of &lt;code&gt;roubhaol.joefwoefcheaw&lt;/code&gt;?&lt;/p&gt;
&lt;p&gt;I got this value by going back to Visual Basic Editor and selelecting &lt;code&gt;joefwoefcheaw&lt;/code&gt;. The value we need is listed under &lt;code&gt;Text&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img alt="maldoc101-writeup-02" src="https://www.accidentalrebel.com/images/maldoc101-writeup-02.png" /&gt;&lt;/p&gt;
&lt;p&gt;Substituting the values &lt;code&gt;s&lt;/code&gt; and &lt;code&gt;P&lt;/code&gt; I got the following:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;haothkoebtheil = &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqw2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqm2342772g3&amp;amp;*gs7712ffvs626fqgm2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqt2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fq:w2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqin2342772g3&amp;amp;*gs7712ffvs626fq322342772g3&amp;amp;*gs7712ffvs626fq_2342772g3&amp;amp;*gs7712ffvs626fqP2342772g3&amp;amp;*gs7712ffvs626fqr2342772g3&amp;amp;*gs7712ffvs626fqo2342772g3&amp;amp;*gs7712ffvs626fq2342772g3&amp;amp;*gs7712ffvs626fqc2342772g3&amp;amp;*gs7712ffvs626fqes2342772g3&amp;amp;*gs7712ffvs626fqs2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;It still doesn't clear up the gibberish, but at least it's now one big string. This same string is then passed as a parameter to function &lt;code&gt;juuvzouchmiopxeox&lt;/code&gt;. &lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;deulsaocthuul = juuvzouchmiopxeox(haothkoebtheil)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Let's look at the code inside &lt;code&gt;juuvzouchmiopxeox&lt;/code&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;Function juuvzouchmiopxeox(yiajthoavheiw)
    geutyoeytiestheug = yiajthoavheiw
    feaxgeip = Split(geutyoeytiestheug, &amp;quot;2342772g3&amp;amp;*gs7712ffvs626fq&amp;quot;)

    jaquhoiqu = csqw + Join(feaxgeip, eihnx)
    juuvzouchmiopxeox = jaquhoiqu
End Function
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Following the code we could see that the passed string is splitted using the call to the function &lt;code&gt;Split&lt;/code&gt; with the substring &lt;code&gt;2342772g3&amp;amp;*gs7712ffvs626fq&lt;/code&gt;. This simply means that the substring is removed from the input string. The result of &lt;code&gt;Split&lt;/code&gt; is then joined into one string using &lt;code&gt;Join&lt;/code&gt;. There are the variables &lt;code&gt;csqw&lt;/code&gt; and &lt;code&gt;eihnx&lt;/code&gt;, they don't alter the string as these variables are empty. &lt;/p&gt;
&lt;p&gt;At the end of this function the value of the passed string is now:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="n"&gt;winmgmts&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="n"&gt;win32_Process&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Aha! Something that is not gibberish for a change!&lt;/p&gt;
&lt;p&gt;Going back to the caller function, the result of &lt;code&gt;juuvzouchmiopxeox&lt;/code&gt; is saved to &lt;code&gt;deulsaocthuul&lt;/code&gt;.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;    deulsaocthuul = juuvzouchmiopxeox(haothkoebtheil)

    Set tiajriokchaoy = CreateObject(deulsaocthuul)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;After that an object is created out of &lt;code&gt;deaulsaocthuul&lt;/code&gt;, which we know contains &lt;code&gt;winmgmts:win32_Process&lt;/code&gt;. &lt;/p&gt;
&lt;p&gt;Looking at &lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-process"&gt;the microsoft docs&lt;/a&gt; I find out that &lt;code&gt;The Win32_Process WMI class represents a process on an operating system.&lt;/code&gt;. Interesting.&lt;/p&gt;
&lt;h2 id="taking-a-step-back"&gt;Taking a step back&lt;/h2&gt;
&lt;p&gt;At this point there are already a number of questions that we could answer based on what we've done so far. Some are not yet answerable at the moment, however, so nothing left to do but to push forward. But that will be for the next part of this two part series.&lt;/p&gt;
&lt;p&gt;Until then, I'm taking a step back as I marvel at my progress. It wouldn't take long until all the pieces would fall into place.&lt;/p&gt;</content><category term="Malware Analysis"/><category term="re"/><category term="malware_analysis"/><category term="malware"/></entry></feed>