<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccidentalRebel.com</title>
    
    <link href="https://www.accidentalrebel.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="AccidentalRebel.com Atom Feed" />
    
    <link rel="stylesheet" href="./theme/css/main.css">
    
</head>
<body>
    <div class="progress-bar" id="progress"></div>
    
    <header>
        <div class="container">
            <nav>
                <a href="./" class="site-title">AccidentalRebel.com</a>
                <button class="menu-toggle" onclick="toggleMenu()">☰</button>
                <ul class="nav-links" id="navLinks">
                    <li><a href="./archives.html">Archives</a></li>
                    <li><a href="./categories.html">Categories</a></li>
                    <li><a href="./tags.html">Tags</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Comic strip divider -->
    <div class="comic-container">
        <div class="comic-strip"></div>
    </div>

    <main>
        <div class="container">
    <article class="post-item">
        <header class="article-header">
            <h2 class="post-title">
                <a href="./covidscammers-writeup--defcon-rtv-ctf.html">CovidScammers writeup (Defcon RTV CTF)</a>
            </h2>
            <div class="article-meta">
                <time datetime="2020-08-13T16:58:00+08:00">Thu 13 August 2020</time>
                <span>•</span>
                <a href="./category/ctf.html">ctf</a>
            </div>
        </header>

        <div class="article-content">
            <p>I joined the <a href="https://ctf.threatsims.com">Defcon Red Team Village CTF</a> because I was curious about it and I wanted to test out the skills that I have gained playing with CTF sites like <a href="https://overthewire.org/wargames/">overthewire.org</a> and <a href="https://www.vulnhub.com/">vulnhub</a>. I knew that the challenges won't be easy, but thankfully, I was able to join up with other newbies who were willing to give it a go and learn with each other.</p>
<p>Unfortunately, I fell asleep just before the CTF started and when I woke up all the easy challenges were already solved by my team members. There was one easy challenge that was still open on the CovidScammers category, so I quickly got started to solving that.</p>
<h2 id="free-flag-and-binary-1-point">Free Flag (and binary) [1 point]</h2>
<blockquote>
<p>You've been contacted by a high-end but morally ambiguous finance company (unhackable-bitcoin-wallet.com) to investigate a data breach. The box in question is a mail server in their internal network, a sample of the malware found on the system has been pulled and given to you. Your task, should you choose to accept it, is to reverse-engineer the sample and locate, fuzz and exploit the C2 server, and then hack-back to learn about the malicious actor and recover the stolen documents.
Look for the free flag. Get on the scoreboard!</p>
</blockquote>
<p>I admit that in a hurry to get points I did not properly read the description of the challenge. I understood that I'll be downloading and reverse-engineering something. But it did not register on my mind that it's actually malware.</p>
<p>The download was a binary that doesn't do anything when run. My first instict was to use <code>strings</code> to look for the flag, which turned out to be correct.</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-01" src="./images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-01.png" /></p>
<p>The flag is: <code>TS{freeFlagLookAtMe}</code>.</p>
<p>Unfortunately, this challenge was already solved by a team member so I did not get the free flag. The second one, is still open though.</p>
<h2 id="syscalls-5-points">Syscalls [5 points]</h2>
<blockquote>
<p>What syscall is hindering your dynamic analysis? Flag is just the syscall, no brackets or anything.</p>
</blockquote>
<p>If we run the file from within gdb to debug it we get:</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-02" src="./images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-02.png" /></p>
<blockquote>
<p>can't debug this, na na na na...</p>
</blockquote>
<p>So from the description we are looking for a syscall that is hindering the debugging of the binary. If we want to find out what syscalls are called by a program, we could determine that using the <code>strace</code> command.</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-03" src="./images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-03.png" /></p>
<p>Just before the write syscall for the "na na na" message we see:</p>
<blockquote>
<p>ptrace(TRACE_TRACEME) = -1 EPERM (Operation not permitted)</p>
</blockquote>
<p>I'm unfamiliar with <code>ptrace</code> so I researched it and tried to understand how it could prevent debugging. I learned that <code>ptrace</code> can be used as an anti-debugging technique as can be seen <a href="https://www.aldeid.com/wiki/Ptrace-anti-debugging">here</a>.</p>
<p>Sure, enough the flag is: <code>ptrace</code>. </p>
<p>I got 5 points from this and I finally have a contribution to my team! Unfortunately, real life prevented me from continuing with the CTF and I had to bow out early.</p>
<h3 id="sidenote-how-to-bypass-ptrace">Sidenote: How to bypass ptrace?</h3>
<p>How does one bypass this anti-debugging feature? <a href="https://dev.to/denisnutiu/bypassing-ptrace-calls-with-ldpreload-on-linux-12jl">Here's one approach</a> that I tried which should work in theory but doesn't. My guess is that this particular binary has an additional way to prevent debugging, like it spawns a child process and it stays there even if you bypass ptrace. I'd have to look into this further in the future.</p>
<h2 id="shared-secrets-150-points">Shared Secrets [150 points]</h2>
<blockquote>
<p>The malware creates a shared-memory object and stores a flag inside. Recover the flag. Flag has the TS{} format, you'll know when you get it.</p>
</blockquote>
<p>I was able to solve this challenge after the CTF preliminaries ended. By this time I was already well rested and have a clearer mind. It was also at this time that I realized that the file is actually a malware and has already infected my machine. Thankfully, I was running a virtual machine which meant I could just revert back to an old working restore point.</p>
<p>Knowing that the file is a malware, the next step I did was to run <code>rkhunter</code> to look for rootkits and suspcious files. This gave me an interesting finding:</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-04" src="./images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-04.png" /></p>
<p>Opening the suspicious file revealed this: </p>
<blockquote>
<p>KRJXW22FMVYES5CTMVBXERKUNNCWK4CJORJWCRTFFZGXERTSGBSE6IL5</p>
</blockquote>
<p>This is not the flag yet, it needs to be in the "TS{}" format as instructed in the challenge description.</p>
<p>I initially had a hard time figuring out how to decode this. It wasn't <code>base64</code> nor any other popular encoding. Thankfully, there are tools like <a href="https://gchq.github.io/CyberChef/">CyberChef</a> to help with this kind of problem. After some experimentation, the "magic" recipe did the trick and revealed to me that it was actually a <code>base32</code> encoding.</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-05" src="./images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-05.png" /></p>
<p>This gave me the flag: <code>TS{kEepItSeCrETkEepItSaFe.MrFr0dO!}</code></p>
<h2 id="license-and-registration-100-points">License and Registration [100 points]</h2>
<blockquote>
<p>The malware creates a UUID and stores it in a file, what is the name of this file. Provide the SHA1 hash of hte full path as the flag.</p>
</blockquote>
<p>So the description above says that a file is created by the malware and stores data inside of it. I figured that the easiest way to figure out what this created file is to: </p>
<ul>
<li>Restore to a previous restore point before I opened the malware</li>
<li>Run the malware, and then;</li>
<li>Inspect which other files were created at the time of execution. </li>
</ul>
<p>I found out which files were recently created during the last 2 minutes using the following command:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>find<span class="w"> </span>/<span class="w"> </span>-user<span class="w"> </span>kali<span class="w"> </span>-mmin<span class="w"> </span><span class="m">2</span><span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="m">2</span>&gt;<span class="w"> </span>/dev/null
</code></pre></div>

<p>This showed me a lot of files, but after sifting through that I found one file that seesm promising.</p>
<blockquote>
<p>/tmp/.serverauth.tn6aUcM0uM</p>
</blockquote>
<p>To get the flag I did this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;/tmp/.serverauth.tn6aUcM0uM&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sha1sum
</code></pre></div>

<p>Which resulted in this flag: <code>5b4e97047851682649a602ad62ba4af567e352a3</code></p>
<h2 id="to-be-continued">To be continued?</h2>
<p>So I wanted to try and work on the other challenges but it seems that <a href="https://ctf.threatsims.com">the ctf site</a> is currently down. The site redirected to a different non https site and it spooked me so I stopped trying. Good thing that I had NoScript on.</p>
<p>If you want a longer and more pro writeup about the CovidScammers challenges do check out <a href="https://0xdf.gitlab.io/2020/05/04/covid-19-ctf-covidscammers.html">0xdf's writeup about it</a>.</p>
        </div>

        <div class="tags">
            <a href="./tag/ctf.html" class="tag">ctf</a>
            <a href="./tag/writeup.html" class="tag">writeup</a>
            <a href="./tag/malware_analysis.html" class="tag">malware_analysis</a>
            <span class="tag">+1 more</span>
        </div>
    </article>
    <article class="post-item">
        <header class="article-header">
            <h2 class="post-title">
                <a href="./study-notes--mac-spoofing.html">Study notes: MAC Spoofing</a>
            </h2>
            <div class="article-meta">
                <time datetime="2020-08-01T11:07:00+08:00">Sat 01 August 2020</time>
                <span>•</span>
                <a href="./category/cybersecurity.html">cybersecurity</a>
            </div>
        </header>

        <div class="article-content">
            <div class="codehilite"><pre><span></span><code>Study notes are my personal research notes on certain topics that interests me.
</code></pre></div>

<p>Any network capable device has a unique factory-assigned Media Access Control (MAC) address. Users have no way to change the MAC address but it can be done. However, it is possible to mask the MAC address and have it show a different value. This is called MAC spoofing.</p>
<p>There are legitimate uses for MAC spoofing. For example, there may be certain applications that require a particular MAC address to work, or maybe your ISP expects a certain MAC address to connect to the network. MAC spoofing is largely used for illegitimate uses, like circumventing an access control list or getting past a filter on a wireless network.</p>
<h2 id="changing-mac-address-via-ifconfig">Changing MAC Address via ifconfig</h2>
<p>In Linux we could use <code>ifconfig</code> to change the MAC address.</p>
<p>To view the current MAC address:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ifconfig
</code></pre></div>

<p>The current MAC address is <code>08:00:27:59:fb:fa</code>:</p>
<p><img alt="study-notes--mac-spoofing-01" src="./images/study-notes--mac-spoofing-01.png" /></p>
<p>Let's say we want to change the MAC address of our interface (eth0) to <code>00:11:22:33:44:55</code>.</p>
<p>First, deactivate the interface.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ifconfig<span class="w"> </span>eth0<span class="w"> </span>down
</code></pre></div>

<p>Then we specify the mac address that we want to change to.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ifconfig<span class="w"> </span>eth0<span class="w"> </span>hw<span class="w"> </span>ether<span class="w"> </span><span class="m">00</span>:11:22:33:44:55
</code></pre></div>

<p>Reactive the interface:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ifconfig<span class="w"> </span>eth0<span class="w"> </span>up
</code></pre></div>

<p>Run <code>ifconfig</code> again to see the changes.</p>
<p><img alt="study-notes--mac-spoofing-02" src="./images/study-notes--mac-spoofing-02.png" /></p>
<h3 id="note">NOTE:</h3>
<p>These changes are not permanent. The MAC address will return to the original one when the system is restarted!</p>
<h2 id="changing-the-mac-address-via-macchanger">Changing the MAC address via MACChanger</h2>
<p>There are various tools that allows easy changing of MAC addresses. <a href="https://github.com/alobbs/macchanger">MACChanger</a> is one of them.</p>
<p>First, deactivate the interface.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ifconfig<span class="w"> </span>eth0<span class="w"> </span>down
</code></pre></div>

<p>The above below allows you specify the mac address you want to use:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>macchanger<span class="w"> </span>-m<span class="w"> </span><span class="m">00</span>:11:22:33:44:55<span class="w"> </span>eth0
</code></pre></div>

<p>The code below assigns a random MAC address.</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>macchanger<span class="w"> </span>-r<span class="w"> </span>eth0
</code></pre></div>

<p>Reactive the interface:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ifconfig<span class="w"> </span>eth0<span class="w"> </span>up
</code></pre></div>

<h2 id="related-reading">Related reading</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/MAC_spoofing">MAC Spoofing on Wikipedia</a></li>
<li><a href="https://www.giac.org/paper/gsec/3199/mac-spoofing-an-introduction/105315">MAC Spoofing - An introduction</a> </li>
<li><a href="https://www.comparitech.com/net-admin/spoofing-attacks-guide/">A guide to spoofing attacks and how to prevent them</a></li>
</ul>
        </div>

        <div class="tags">
            <a href="./tag/spoofing.html" class="tag">spoofing</a>
            <a href="./tag/cybersecurity.html" class="tag">cybersecurity</a>
        </div>
    </article>
    <article class="post-item">
        <header class="article-header">
            <h2 class="post-title">
                <a href="./chicken-scheme-ffi-examples.html">Chicken-Scheme FFI Examples</a>
            </h2>
            <div class="article-meta">
                <time datetime="2020-06-16T05:58:00+08:00">Tue 16 June 2020</time>
                <span>•</span>
                <a href="./category/dev.html">dev</a>
            </div>
        </header>

        <div class="article-content">
            <p>I'm currently working on refactoring the FFI implementation for <a href="https://github.com/accidentalrebel/rebel-game-engine">the Rebel Game Engine</a>. It was previously written using the <a href="http://wiki.call-cc.org/eggref/5/bind">Bind chicken egg</a> but I wanted to have more control over the implementation by using the low level foreign functions. </p>
<p>To help me better understand I made some examples that has the basic FFI implementations that I'll be needing for my project.</p>
<hr />
<h2 id="foreign-lambda-example">foreign-lambda example</h2>
<p>Let's say we have a structure <code>Vec3</code> and a function <code>Vec3Create</code> that we want to access from chicken-scheme.</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Vec3</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">Vec3</span><span class="p">;</span>

<span class="n">Vec3</span><span class="o">*</span><span class="w"> </span><span class="nf">Vec3Create</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Vec3</span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Vec3</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Vec3</span><span class="p">));</span>
<span class="w">    </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>We could use <a href="https://wiki.call-cc.org/man/5/Module%20(chicken%20foreign)#foreign-lambda"><code>foreign-lambda</code></a> to bind to the function:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nv">vec3_create</span>
<span class="w">  </span><span class="p">(</span><span class="nf">foreign-lambda</span>
<span class="w">    </span><span class="p">(</span><span class="nf">c-pointer</span><span class="w"> </span><span class="p">(</span><span class="nf">struct</span><span class="w"> </span><span class="s">&quot;Vec3&quot;</span><span class="p">))</span><span class="w">   </span><span class="c1">; Return type, a pointer to a struct object of Vec3</span>
<span class="w">    </span><span class="s">&quot;Vec3Create&quot;</span><span class="w">                  </span><span class="c1">; Name fo the function</span>
<span class="w">    </span><span class="nv">float</span><span class="w"> </span><span class="nv">float</span><span class="w"> </span><span class="nv">float</span><span class="p">))</span><span class="w">           </span><span class="c1">; The three parameters (x,y,z) to pass to the function</span>
</code></pre></div>

<p>This would allow us to call the <code>vec3_create</code> function like so:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">vec3_create</span><span class="w"> </span><span class="mf">1.1</span><span class="w"> </span><span class="mf">2.2</span><span class="w"> </span><span class="mf">3.3</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="foreign-lambda-example_1">foreign-lambda* example</h2>
<p>Let's bind another C function <code>Vec3Print</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">Vec3Print</span><span class="p">(</span><span class="n">Vec3</span><span class="w"> </span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Vec3 to print: (%f, %f, %f)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>We could also use <a href="https://wiki.call-cc.org/man/5/Module%20(chicken%20foreign)#foreign-lambda"><code>foreign-lambda*</code></a> (Notice the asterisk). This is similar to <code>foreign-lambda</code> but accepts C code as a string.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nv">vec3_print</span>
<span class="w">  </span><span class="p">(</span><span class="nf">foreign-lambda*</span>
<span class="w">    </span><span class="nv">void</span><span class="w">                          </span><span class="c1">; The return type</span>
<span class="w">    </span><span class="p">(((</span><span class="nf">c-pointer</span><span class="w"> </span><span class="p">(</span><span class="nf">struct</span><span class="w"> </span><span class="s">&quot;Vec3&quot;</span><span class="p">))</span><span class="w"> </span><span class="nv">a0</span><span class="p">))</span><span class="w"> </span><span class="c1">; The parameter to pass, a pointer to a Vec3 object</span>
<span class="w">    </span><span class="s">&quot;Vec3Print(*a0);&quot;</span><span class="p">))</span><span class="w">           </span><span class="c1">; The C code in string from</span>
<span class="w">                                  </span><span class="c1">; Vec3Print accepts a non pointer, we dereference it</span>

<span class="p">(</span><span class="nf">vec3_print</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3_create</span><span class="w"> </span><span class="mf">1.1</span><span class="w"> </span><span class="mf">2.2</span><span class="w"> </span><span class="mf">3.3</span><span class="p">))</span><span class="w">   </span><span class="c1">; Creates a vec3 and prints it</span>
</code></pre></div>

<hr />
<h2 id="inline-c-code-in-foreign-lambda">Inline C code in foreign-lambda*</h2>
<p>Here's another example using <code>foreign-lambda*</code>. This time there is no predefined C function, but instead we define the code inside the lisp function's body.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nv">vec3_zero</span>
<span class="w">  </span><span class="p">(</span><span class="nf">foreign-lambda*</span>
<span class="w">    </span><span class="p">(</span><span class="nf">c-pointer</span><span class="w"> </span><span class="p">(</span><span class="nf">struct</span><span class="w"> </span><span class="s">&quot;Vec3&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">()</span><span class="w">                            </span><span class="c1">; Empty variables</span>
<span class="w">    </span><span class="s">&quot;Vec3* v = (Vec3*)Vec3Create(0.0f, 0.0f, 0.0f); </span>
<span class="s">    C_return(v);&quot;</span><span class="p">))</span><span class="w">               </span><span class="c1">; Instead of &quot;return&quot;, we use &quot;C_return&quot;.</span>

<span class="p">(</span><span class="nf">vec3_print</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3_zero</span><span class="p">))</span><span class="w">          </span><span class="c1">; Calls vec3_zero and prints the returned Vec3</span>
</code></pre></div>

<p>Note that due to obscure technical reasons <code>C_return</code> must be used instead of <code>return</code> when returning a value. More info about this <a href="https://wiki.call-cc.org/man/5/Module%20(chicken%20foreign)#foreign-lambda">here</a>.</p>
<hr />
<h2 id="free-ing-vec3-pointers">Free-ing Vec3 pointers</h2>
<p>Since <code>Vec3Create</code> allocates memory for a Vec3 struct using <code>malloc</code>, it's a good idea to free this when we are done using it. To do this we could bind a function to <code>free</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nv">free</span><span class="w"> </span><span class="p">(</span><span class="nf">foreign-lambda</span><span class="w"> </span><span class="nv">void</span><span class="w"> </span><span class="s">&quot;free&quot;</span><span class="w"> </span><span class="nv">c-pointer</span><span class="p">))</span>

<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">v</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3_zero</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">vec3_print</span><span class="w"> </span><span class="nv">v</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">free</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span>
</code></pre></div>

<hr />
<h2 id="setting-up-getters-and-setters">Setting up getters and setters</h2>
<p>If we want to have access to variables of a struct object. We could do something like this:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="nv">vec3_x</span>
<span class="w">  </span><span class="p">(</span><span class="nf">foreign-lambda*</span>
<span class="w">    </span><span class="nv">float</span>
<span class="w">    </span><span class="p">(((</span><span class="nf">c-pointer</span><span class="w"> </span><span class="p">(</span><span class="nf">struct</span><span class="w"> </span><span class="s">&quot;Vec3&quot;</span><span class="p">))</span><span class="w"> </span><span class="nv">a0</span><span class="p">))</span>
<span class="w">    </span><span class="s">&quot;C_return(a0-&gt;x);&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3_x</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3_create</span><span class="w"> </span><span class="mf">8.8</span><span class="w"> </span><span class="mf">8.8</span><span class="w"> </span><span class="mf">8.8</span><span class="p">)))</span>
</code></pre></div>

<p>Now this is fine but it'll be a pain to specify an accessor for every variable. A better solution is to use the <a href="http://wiki.call-cc.org/eggref/5/foreigners#define-foreign-enum-type"><code>foreigners</code></a> egg which allows the use of macros that will make our lives easier.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">import</span><span class="w"> </span><span class="p">(</span><span class="nf">chicken</span><span class="w"> </span><span class="nv">foreign</span><span class="p">))</span>
<span class="p">(</span><span class="k">import</span><span class="w"> </span><span class="nv">foreigners</span><span class="p">)</span>

<span class="c1">;; Set up the accessors for Vec3 struct</span>
<span class="p">(</span><span class="nf">define-foreign-record-type</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3</span><span class="w"> </span><span class="nv">Vec3</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">float</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">vec3_x</span><span class="w"> </span><span class="nv">vec3_x!</span><span class="p">)</span><span class="w">   </span><span class="c1">; vec3_x is a getter, vec3_x! is a setter</span>
<span class="w">  </span><span class="p">(</span><span class="nf">float</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">vec3_y</span><span class="w"> </span><span class="nv">vec3_y!</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">float</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">vec3_z</span><span class="w"> </span><span class="nv">vec3_z!</span><span class="p">))</span>

<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">v</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3_create</span><span class="w"> </span><span class="mf">4.4</span><span class="w"> </span><span class="mf">5.5</span><span class="w"> </span><span class="mf">6.6</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3_x</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"> </span><span class="c1">; Display value of x</span>
<span class="w">  </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="nf">vec3_x!</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="mf">7.7</span><span class="p">)</span><span class="w">      </span><span class="c1">; Set x to 7.7</span>
<span class="w">  </span><span class="p">(</span><span class="nb">display</span><span class="w"> </span><span class="p">(</span><span class="nf">vec3_x</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span><span class="w"> </span><span class="c1">; Display value of x</span>
<span class="w">  </span><span class="p">(</span><span class="nb">newline</span><span class="p">)</span>

<span class="w">  </span><span class="p">(</span><span class="nf">free</span><span class="w"> </span><span class="nv">v</span><span class="p">))</span>
</code></pre></div>

<hr />
<h2 id="binding-enums">Binding enums</h2>
<p>The <a href="http://wiki.call-cc.org/eggref/5/foreigners#define-foreign-enum-type"><code>foreigners</code></a> egg also allows for the binding of enums using <a href="http://wiki.call-cc.org/eggref/5/foreigners#define-foreign-enum-type"><code>define-foreign-enum-type</code></a>. Say we have an enum declaration <code>Keys</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span><span class="w"> </span><span class="n">Keys</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">UP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="n">RIGHT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="n">DOWN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">  </span><span class="n">LEFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="p">};</span>

<span class="o">:::</span><span class="n">scheme</span>
<span class="p">(</span><span class="n">define</span><span class="o">-</span><span class="n">foreign</span><span class="o">-</span><span class="k">enum</span><span class="o">-</span><span class="n">type</span><span class="w"> </span><span class="p">(</span><span class="n">keys</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">keys</span><span class="o">-&gt;</span><span class="kt">int</span><span class="w"> </span><span class="kt">int</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">up</span><span class="w"> </span><span class="n">keys</span><span class="o">/</span><span class="n">up</span><span class="p">)</span><span class="w"> </span><span class="n">UP</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">right</span><span class="w"> </span><span class="n">keys</span><span class="o">/</span><span class="n">right</span><span class="p">)</span><span class="w"> </span><span class="n">RIGHT</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">down</span><span class="w"> </span><span class="n">keys</span><span class="o">/</span><span class="n">down</span><span class="p">)</span><span class="w"> </span><span class="n">DOWN</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="n">left</span><span class="w"> </span><span class="n">keys</span><span class="o">/</span><span class="n">left</span><span class="p">)</span><span class="w"> </span><span class="n">LEFT</span><span class="p">))</span>

<span class="p">(</span><span class="n">display</span><span class="w"> </span><span class="n">keys</span><span class="o">/</span><span class="n">right</span><span class="p">)</span>
<span class="p">(</span><span class="n">display</span><span class="w"> </span><span class="n">keys</span><span class="o">/</span><span class="n">down</span><span class="p">)</span>
</code></pre></div>

<hr />
<p>These are the basic FFI implementations that I have explored. It should be enough for most uses. The example project with working code can be found <a href="https://github.com/accidentalrebel/chicken-scheme-ffi-example">on Github</a>.</p>
<p>Also, check out <a href="http://wiki.call-cc.org/eggref/5/bind">the chicken-bind egg</a>, it already has all of the code above conveniently in one package. If you don't need full control and just want a simple FFI solution then this is what you need.</p>
        </div>

        <div class="tags">
            <a href="./tag/programming.html" class="tag">programming</a>
            <a href="./tag/dev.html" class="tag">dev</a>
            <a href="./tag/research.html" class="tag">research</a>
            <span class="tag">+1 more</span>
        </div>
    </article>

<nav class="pagination">
        <a href="./index10.html">&laquo; Previous</a>

        <a href="./index.html">1</a>
        <a href="./index2.html">2</a>
        <a href="./index3.html">3</a>
        <a href="./index4.html">4</a>
        <a href="./index5.html">5</a>
        <a href="./index6.html">6</a>
        <a href="./index7.html">7</a>
        <a href="./index8.html">8</a>
        <a href="./index9.html">9</a>
        <a href="./index10.html">10</a>
        <span class="current">11</span>
        <a href="./index12.html">12</a>
        <a href="./index13.html">13</a>
        <a href="./index14.html">14</a>
        <a href="./index15.html">15</a>
        <a href="./index16.html">16</a>

    <a href="./index12.html">Next &raquo;</a>
</nav>
        </div>
    </main>

    <script src="./theme/js/main.js"></script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55068085-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-55068085-2');
    </script>
</body>
</html>