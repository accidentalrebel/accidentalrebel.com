<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>String anti-virus evasion in x64 assembly (Part 1)</title>
  <meta name="author" content="AccidentalRebel">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="String anti-virus evasion in x64 assembly (Part 1) July 08, 2022 in evasion,assembly,av">

  <link rel="canonical" href="./string-av-evasion-in-x64-assembly-part-1.html">

  <link href="./favicon.png" rel="icon">

  <link href="https://www.accidentalrebel.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="AccidentalRebel.com Full Atom Feed" />

  <link href="./theme/css/screen.css"  media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="./theme/css/tomorrow.css"  media="screen, projection" rel="stylesheet" type="text/css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

  
<meta name="twitter:card" content="summary">
<meta property="og:url" content="./string-av-evasion-in-x64-assembly-part-1.html">
<meta name="twitter:site:id" content="https://twitter.com/accidentalrebel">
<meta name="twitter:creator:id" content="accidentalrebel">
<meta property="og:title" content="String anti-virus evasion in x64 assembly (Part 1)">
<meta property="og:description" content="One of the features I implemented for my Remote Access Tool was an anti-virus evasion capability in the form of strings obfuscation. It wou">
<meta property="og:image" content="https://www.accidentalrebel.com/images/string-anti-virus-evasion-in-x64-assembly-part-1-04.png">
<meta name="twitter:image:src" content="https://www.accidentalrebel.com/images/string-anti-virus-evasion-in-x64-assembly-part-1-04.png">


</head>
  <body>

    <div class="container" id="site-title">
      <div class="col-md-8 col-md-offset-2">
	<h1>
	  <a href=".">
	    AccidentalRebel.com
	  </a>
	</h1>
	<div id="profile">
	  <div class="left">
	    <img src="./theme/images/pic.png" />
	  </div>
	  <div class="right">
	    Karlo is a programmer for 10+ years who switched to cyber security. He is currently working as a L2 SOC Analyst and is focusing on malware reverse engineering and development.
	  </div>
	  <div class="clear"></div>
	</div>
	<div id="nav">
	  <ul>
	    <li><a href=".">Home</a></li>
	    <!-- <li><a href="./pages/made.html">My Works</a></li> -->
	    <li class="icon-nav" id="twitter-nav"><a href="https://twitter.com/accidentalrebel">Twitter</a></li>
	    <li class="icon-nav" id="github-nav"><a href="https://github.com/accidentalrebel">Github</a></li>
	    <li class="icon-nav" id="feed-nav"><a href="./feeds/all.atom.xml">RSS</a></li>
	  </ul>
	</div>
      </div>
    </div>

  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
	<article>
          <h1><a href="./string-av-evasion-in-x64-assembly-part-1.html">String anti-virus evasion in x64 assembly (Part 1)</a></h1>
          <div class="meta">
            <time datetime="2022-07-08T12:11:00+08:00">July 08, 2022</time>
            in <span class="categories">
              <a href="./tag/evasion.html">evasion</a>,              <a href="./tag/assembly.html">assembly</a>,              <a href="./tag/av.html">av</a>            </span>
          </div>
        <p>One of the features I implemented for my <a href="https://github.com/accidentalrebel/RATwurst">Remote Access Tool</a> was an anti-virus evasion capability in the form of strings obfuscation. It wouldn't fool an EDR or a reverse engineer but it was quick to implement so I added it. </p>
<p>This was over a year ago. I decided to revisit this feature to try and understand it better and find out if it is actually effective.</p>
<h2 id="what-to-expect">What to expect</h2>
<p>In this two-part blog post I will look into the following:</p>
<ul>
<li>Hiding argument strings</li>
<li>Hiding API call strings</li>
</ul>
<p>THe one you reading now is about the first one. I will be explaining how it's done in C and later convert it to x64 Windows Assembly so we can better understand what's happening under the hood.</p>
<h2 id="hiding-function-argument-strings">Hiding function argument strings</h2>
<p>I got the idea for this AV evasion technique from <a href="https://blog.scrt.ch/2020/06/19/engineering-antivirus-evasion/">this blog post</a>. The author posits that one part of an anti-virus detection capability is through checking for suspicious strings in an executable.</p>
<p>For the purpose of this post, let's pretend that "notepad" is a suspicious string that we don't want be detected by the anti-virus.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;shellapi.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ShellExecute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;notepad&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<blockquote>
<p>You might think that a call to <code>ShellExecute</code> is already a big red flag, and you are right. It is! But we'll talk about hiding API calls on the next post. Let's focus on the parameter for now.</p>
</blockquote>
<p>In the place of the anti-virus, we'll be using the <code>strings</code> command to check for visible strings like so:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-01" src="./images/string-anti-virus-evasion-in-x64-assembly-part-1-01.png" /></p>
<p>As expected, the word "notepad" is easily detected. This is becaues any string that we declare and initialize in a program gets placed in the <code>.data</code> segment in memory by the compiler:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-02" src="./images/string-anti-virus-evasion-in-x64-assembly-part-1-02.png" /></p>
<p>To prevent detection, we need a way for the string to not be present in our compiled executable.</p>
<h2 id="the-solution">The solution</h2>
<p>The solution is to declare the string to be passed as the parameter like so:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">ShellExecute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>And when <code>strings</code> is run, we now see that the "notepad" string is not present anymore.</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-03" src="./images/string-anti-virus-evasion-in-x64-assembly-part-1-03.png" /></p>
<p>How did this happen?</p>
<p>This is because data contained in arrays are placed on the stack instead of the <code>.data</code> segment when declared within a function (And also, as long as it is not declared as static).</p>
<p>To further understand how this happens, let's convert this C program into x64 assembly.</p>
<h2 id="converting-to-x64-assembly">Converting to x64 assembly</h2>
<p>First, we setup our boilerplate code with an entry point and a call to <code>ExitProcess</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">bits</span><span class="w"> </span><span class="mi">64</span><span class="w"></span>
<span class="w">    </span><span class="nf">default</span><span class="w"> </span><span class="no">rel</span><span class="w"></span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>
<span class="w">    </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span><span class="w"></span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span><span class="w"></span>

<span class="nl">main:</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span><span class="w"></span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span><span class="w"></span>
</code></pre></div>

<p>Before we can call <code>ShellExecute</code>, we first need to import the <code>ShellExecuteA</code> symbol using <code>extern</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>
<span class="w">    </span><span class="na">...</span><span class="w"></span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span><span class="w"></span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ShellExecuteA</span><span class="w"></span>
</code></pre></div>

<hr />
<h3 id="aside-why-shellexecutea-and-not-shellexecute">Aside: Why ShellExecuteA and not ShellExecute?</h3>
<blockquote>
<p>Because if you would look in the <a href="https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea">MSDN documentation</a>, you would find that there really isn't a <code>ShellExecute</code> function available. There are <code>ShellExecuteA</code> (For ANSI strings) and <code>ShellExecuteW</code> (For Unicode strings), however. <code>ShellExecute</code> is just a macro for these two functions. We can confirm this by looking at the <code>shellapi.h</code> source code.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifdef UNICODE</span>
<span class="cp">#define ShellExecute  ShellExecuteW</span>
<span class="cp">#else</span>
<span class="cp">#define ShellExecute  ShellExecuteA</span>
<span class="cp">#endif </span><span class="c1">// !UNICODE</span>
</code></pre></div>

<blockquote>
<p>Since assembly does not use header files we can just call <code>ShellExecuteA</code> or <code>ShellExecuteW</code> directly. In this example, we won't be needing unicode support so we're going to be using the former.</p>
</blockquote>
<hr />
<p>Before we call the function in assembly, let's go back and take a look at how we did it in C.</p>
<div class="codehilite"><pre><span></span><code><span class="n">ShellExecute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;notepad&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>We have 5 paremeters to pass to the function. Here's how we can write this in assembly using the Microsoft <a href="https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">x64 calling conventions</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x5</span><span class="w">              </span><span class="c1">; nShowCmd ; SW_SHOW == 0x5</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x0</span><span class="w">              </span><span class="c1">; lpDirectory ; NULL == 0x0</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span><span class="w">               </span><span class="c1">; lpParameters ; Clear register == NULL</span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_notepad</span><span class="p">]</span><span class="w">    </span><span class="c1">; lpFile</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_open</span><span class="p">]</span><span class="w">      </span><span class="c1">; lpOperation</span>

<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span><span class="w">             </span><span class="c1">; hwnd</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ShellExecuteA</span><span class="w">    </span><span class="c1">; Call function</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
</code></pre></div>

<p>We then initialize the strings by adding a data segment section:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.data</span><span class="w"></span>
<span class="w">    </span><span class="nf">msg_open</span><span class="w">    </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">open</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">msg_notepad</span><span class="w"> </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">notepad</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</code></pre></div>

<p>For reference, here is our full code so far:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">bits</span><span class="w"> </span><span class="mi">64</span><span class="w"></span>
<span class="w">    </span><span class="nf">default</span><span class="w"> </span><span class="no">rel</span><span class="w"></span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.data</span><span class="w"></span>
<span class="w">    </span><span class="nf">msg_open</span><span class="w">    </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">open</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="nf">msg_notepad</span><span class="w"> </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">notepad</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>
<span class="w">    </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span><span class="w"></span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span><span class="w"></span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ShellExecuteA</span><span class="w"></span>

<span class="nl">main:</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span><span class="w"></span>

<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x5</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x0</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span><span class="w"></span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_notepad</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_open</span><span class="p">]</span><span class="w"> </span>
<span class="w">    </span><span class="no">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span><span class="w">    </span>

<span class="w">    </span><span class="no">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ShellExecuteA</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span><span class="w"></span>
</code></pre></div>

<p>Take note that this version of the code is still the one where the "notepad" string is detectable.</p>
<p>To hide this string we need to apply the same solution we did to our C code; which is to place the data on the stack so that it would not be placed in the <code>.data</code> segment.</p>
<p>Here is how we did it in C:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">ShellExecute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>And here is how to do it in assembly:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">             </span><span class="c1">; Reserve space on stack for string</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">n</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">0x0</span><span class="w">   </span>
<span class="w">    </span><span class="no">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w">          </span><span class="c1">; Load address of string to r8</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">             </span><span class="c1">; Reclaim space</span>
</code></pre></div>

<p>Here's a summary of the the above code:</p>
<ul>
<li>Since our string is 8 characters long (Including the <code>0x0</code> or <code>NULL</code> terminator), we reserve space on the stack with <code>sub rsp, 8</code>. </li>
<li>Each character is then placed individually in the reserved space using <code>move byte</code> while adding an offset to <code>rsp</code>.</li>
<li>The address pointed to by <code>rsp</code> is then loaded to the <code>r8</code> register (This holds our 3nd parameter).</li>
<li>We reclaim our reserved space using <code>add rsp, 8</code>.</li>
</ul>
<p>After the code above, <code>r8</code> would now point to the location in the stack where our string resides:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-04" src="./images/string-anti-virus-evasion-in-x64-assembly-part-1-04.png" /></p>
<hr />
<h3 id="aside-what-if-we-have-longer-strings">Aside: What if we have longer strings?</h3>
<blockquote>
<p>If we have a longer string like "powershell", then we need to reserve more space on the stack.
Take note, however that when reserving space we need to maintain the <em>stack alignment</em> so we add and subtract by multiples of 8.
The "powershell" string has 11 characters so we use 16.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">w</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">r</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">s</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">9</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">10</span><span class="p">],</span><span class="w"> </span><span class="mi">0x0</span><span class="w"></span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
</code></pre></div>

<hr />
<p>With this final version of the code, "notepad" will not be visible to <code>strings</code> anymore.</p>
<p>Here is our final code:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">bits</span><span class="w"> </span><span class="mi">64</span><span class="w"></span>
<span class="w">    </span><span class="nf">default</span><span class="w"> </span><span class="no">rel</span><span class="w"></span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.data</span><span class="w"></span>
<span class="w">    </span><span class="nf">msg_open</span><span class="w">    </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">open</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.text</span><span class="w"></span>
<span class="w">    </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span><span class="w"></span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span><span class="w"></span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ShellExecuteA</span><span class="w"></span>

<span class="nl">main:</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span><span class="w"></span>

<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x5</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x0</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span><span class="w"></span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">n</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">0x0</span><span class="w">   </span>
<span class="w">    </span><span class="no">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_open</span><span class="p">]</span><span class="w"> </span>
<span class="w">    </span><span class="no">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span><span class="w">    </span>

<span class="w">    </span><span class="no">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ShellExecuteA</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span><span class="w"></span>
</code></pre></div>

<h2 id="hiding-at-scale">Hiding at scale</h2>
<p>Writing the code above can get a little tedious especially if we want to pass a really long string. Thankfully, we can use a macro like the one I've written below:</p>
<div class="codehilite"><pre><span></span><code><span class="err">%</span><span class="nf">macro</span><span class="w">  </span><span class="no">addstr2stack</span><span class="w">    </span><span class="mi">1</span><span class="p">-*</span><span class="w"></span>
<span class="w">    </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">j</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="err">%</span><span class="na">rep</span><span class="w">    </span><span class="err">%0</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="no">i</span><span class="err">+</span><span class="mi">8</span><span class="p">*</span><span class="no">j</span><span class="p">],</span><span class="w"> </span><span class="err">%</span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">i</span><span class="err">+</span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="err">%</span><span class="nf">rotate</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">        </span><span class="err">%</span><span class="nf">if</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="err">&gt;=</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">            </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">j</span><span class="w"> </span><span class="no">j</span><span class="err">+</span><span class="mi">1</span><span class="w"></span>
<span class="w">            </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="err">%</span><span class="nf">endif</span><span class="w"></span>
<span class="w">    </span><span class="err">%</span><span class="nf">endrep</span><span class="w"></span>
<span class="err">%</span><span class="nf">endmacro</span><span class="w"></span>
</code></pre></div>

<p>What the macro does is that it loops through each character and places it into the correct position on the stack.</p>
<p>This macro can then be called like this:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
</code></pre></div>

<p>Here is what the result of the macro looks like in the debugger:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-05" src="./images/string-anti-virus-evasion-in-x64-assembly-part-1-05.png" /></p>
<p>Here is an example with a longer string:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">       </span><span class="c1">; Reserve 16 bytes because string is longer!</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">w</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">r</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">s</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w"></span>
</code></pre></div>

<hr />
<p>So there you have it, we were able to successfully hide strings by changing the way how the data is declared and placed in memory. If you think about it, the technique is very simple.</p>
<p>However, we've only seen it used against the <code>strings</code> command. Can it evade an actual anti-virus? The answer is probably no. In my next post I'll be talking about API call obfuscation that would help hide functions like <code>ShellExecute</code>.</p>
<blockquote>
<p>This code has been uploaded to Github. Also, for any questions or comments, feel free to reach out to me on <a href="https://twitter.com/accidentalrebel">Twitter</a> or <a href="https://www.linkedin.com/in/juan-karlo-licudine/">LinkedIn</a>.</p>
</blockquote>
        <!-- Disqus goes here -->
        <section>
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite">Disqus goes here</div>
	  <script>
	    /**
	     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
	    /*
	     var disqus_config = function () {
	     this.page.url = AccidentalRebel;  // Replace PAGE_URL with your page's canonical URL variable
	     this.page.identifier = string-av-evasion-in-x64-assembly-part-1.html; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	     };
	    */
	    (function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = 'https://accidentalrebel.disqus.com//embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	    })();
	  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </section>
	</article>
      </div>
    </div>
  </div>
    <footer id="footer" class="her-row">
      <div class="container">
        <div class="row">
          <h4>Powered by <a href="http://blog.getpelican.com/">Pelican</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
        </div>
      </div>
    </footer>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55068085-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-55068085-2');
    </script>
  </body>
</html>