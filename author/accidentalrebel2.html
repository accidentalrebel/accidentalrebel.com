<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>AccidentalRebel.com - Articles by AccidentalRebel</title>
  <meta name="author" content="AccidentalRebel">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="canonical" href="..">

  <link href="../favicon.png" rel="icon">

  <link href="http://www.accidentalrebel.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="AccidentalRebel.com Full Atom Feed" />

  <link href="../theme/css/screen.css"  media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="../theme/css/tomorrow.css"  media="screen, projection" rel="stylesheet" type="text/css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>


</head>
  <body>

    <div class="container" id="site-title">
      <div class="col-md-8 col-md-offset-2">
	<h1>
	  <a href="..">
	    AccidentalRebel.com
	  </a>
	</h1>
	<div id="profile">
	  <div class="left">
	    <img src="../theme/images/pic.png" />
	  </div>
	  <div class="right">
	    Juan Karlo Licudine is currently employed as a Cyber Security Engineer where he uses his programming and technical skills in helping companies protect themselves from cyber threats. In his free time, he works on cybersecurity-related programming projects like malware analysis tools and remote access tools. He jumps between the red or blue camps depending on which project currently interests him.
	  </div>
	  <div class="clear"></div>
	</div>
	<div id="nav">
	  <ul>
	    <li><a href="..">Home</a></li>
	    <!-- <li><a href="../pages/made.html">My Works</a></li> -->
	    <li class="icon-nav" id="twitter-nav"><a href="https://twitter.com/accidentalrebel">Twitter</a></li>
	    <li class="icon-nav" id="github-nav"><a href="https://github.com/accidentalrebel">Github</a></li>
	    <li class="icon-nav" id="feed-nav"><a href="./feeds/all.atom.xml">RSS</a></li>
	  </ul>
	</div>
      </div>
    </div>

<div class="container">
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../introducing-shcode2exe.html">Introducing shcode2exe</a></h1>
	<div class="meta">
          <time datetime="2021-02-26T07:34:00+08:00">February 26, 2021</time>
          in <span class="categories">
            <a href="../tag/re.html">re</a>,            <a href="../tag/tools.html">tools</a>,            <a href="../tag/malware_analysis.html">malware_analysis</a>          </span>
	</div>
        <p><p><strong>[Edit: shcode2exe is <a href="https://docs.remnux.org/discover-the-tools/dynamically+reverse-engineer+code/shellcode#shcode-2-exe">now part of Remnux</a>]</strong></p>
<p>I've been playing around with <a href="https://remnux.org/">Remnux</a> and encountered a problem trying to get one of the tools to run properly. The tool is <a href="https://github.com/repnz/shellcode2exe">shellcode2exe</a>, it is used to compile binary shellcode to a file so it can easily be debugged by a debugger.</p>
<p>When I checked out the code, I was surprised to find out how simple it is. Basically, what happens is that the inputted shellcode is added to a barebones assembly file using the <code>incbin</code> assembly instruction. From there, the file is then automatically compiled and linked.</p>
<p>One big problem with the tool is that it needs to use <a href="https://www.winehq.org/">Wine</a> if it needs to run on Linux. I don't want such a huge dependency especially for my own malware analysis lab so I decided to write my own version which have led to the creation of <code>shcode2exe</code>.</p>
<h2 id="shcode2exe">shcode2exe</h2>
<p>While similar in functionality with the original tool, the biggest improvement I made is that it it does not depend on Wine along with other features as listed below:</p>
<ul>
<li>Can accept a shellcode blob or string (String format <code>\x5e\x31</code>)</li>
<li>Can target both 32bit or 64bit Windows architecture. </li>
<li>Cross platform. Works on Linux or Windows.</li>
<li>No dependency on Wine when running on Linux</li>
<li>Tested working with Python v3.3 and above</li>
<li>Tested working on Windows 7 (Non SP1) and above</li>
</ul>
<h2 id="usage">Usage</h2>
<p>Here's the help message for the tool:</p>
<div class="codehilite"><pre><span></span><code><span class="go">usage: shcode2exe.py [-h] [-o OUTPUT] [-s] [-a {32,64}] input</span>

<span class="go">Compile a binary shellcode blob into an exe file. Can target both 32bit or 64bit architecture.</span>

<span class="go">positional arguments:</span>
<span class="go">  input                 The input file containing the shellcode.</span>

<span class="go">optional arguments:</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -o OUTPUT, --output OUTPUT</span>
<span class="go">                        Set output exe file.</span>
<span class="go">  -s, --string          Set if input file contains shellcode in string format.</span>
<span class="go">  -a {32,64}, --architecture {32,64}</span>
<span class="go">                        The windows architecture to use</span>
</code></pre></div>

<p>Here's how to load a file with shellcode in the format of a string</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>cat test.txt
<span class="go">\x5e\x31\xc0\xb0\x24\xcd\x80\xb0\x24\xcd\x80\xb0\x58\xbb\xad\xde\xe1\xfe\xb9\x69\x19\x12\x28\xba\x67\x45\x23\x01\xcd\x80</span>
<span class="gp">$ </span>./shcode2exe.py -s -o test-string.exe test.bin
</code></pre></div>

<p>Load a file with shellcode in the format of a blob</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>./shcode2exe.py -o test-blob.exe test.bin
</code></pre></div>

<p>Use 64 bit architecture for the output (32 bit is the default)</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>./shcode2exe.py -o test-blob.exe -a <span class="m">64</span> test.bin
<span class="gp">$ </span>file test-blob.exe
<span class="go">test-blob.exe: PE32+ executable (console) x86-64 (stripped to external PDB), for MS Windows</span>
</code></pre></div>

<h2 id="next-steps">Next steps</h2>
<p>I decided to reach out to the people behind Remnux to ask if they could consider my tool as a replacement on their platform. It would be great if they would, but it's okay too if they don't, I made it for my own use anyway. (Update 2021-02-07: It's now <a href="https://github.com/REMnux/salt-states/issues/169">under review</a>)</p>
<p>For more information about the tool and it's code, go to <a href="https://github.com/accidentalrebel/shcode2exe">it's Github page</a>. If you have any comments or suggestions on how to improve it, feel free to tell me via Github issues or dm me at <a href="https://twitter.com/accidentalrebel">@accidentalrebel</a>.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../introducing-shcode2exe.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../ioli-crackme-0x01.html">IOLI Crackme 0x01</a></h1>
	<div class="meta">
          <time datetime="2021-02-20T17:34:00+08:00">February 20, 2021</time>
          in <span class="categories">
            <a href="../tag/re.html">re</a>,            <a href="../tag/crackme.html">crackme</a>          </span>
	</div>
        <p><p>I am continuing my reverse engineering review by tackling the <em>IOLI crackmes</em> by <a href="https://twitter.com/pof">@pof</a>. These are beginner friendly challenges that is perfect for newbies or for those who want to review the basics like me. Check out my writeup for 0x00 <a href="../ioli-crackme-0x00.html">here</a>.</p>
<h1 id="getting-the-password">Getting the password</h1>
<p>Of course, the first thing we do is run the program.</p>
<p><img alt="ioli-crackme-0x01-01" src="../images/ioli-crackme-0x01-01.png" /></p>
<p>Just like last time, we opened up the program in IDA and focused on the part of the code that does the comparing of passwords.</p>
<p><img alt="ioli-crackme-0x01-02" src="../images/ioli-crackme-0x01-02.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="nf">cmp</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">],</span> <span class="mi">149</span><span class="no">Ah</span>
<span class="nf">jz</span> <span class="no">short</span> <span class="no">loc_40137c</span>
</code></pre></div>

<p>This seems easy enough. </p>
<p>Initially I entered <code>149A</code> as the password but this turned out to be incorrect. The reason for this is because <code>scanf</code> was passed a format of <em>"%d"</em>.</p>
<div class="codehilite"><pre><span></span><code><span class="nf">mov</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">18</span><span class="no">h</span><span class="err">+</span><span class="no">Format</span><span class="p">],</span> <span class="no">offset</span> <span class="no">aD</span> <span class="c1">; &quot;%d&quot;</span>
<span class="nf">call</span> <span class="no">_scanf</span>
</code></pre></div>

<p>This means that the input it expects is actually a decimal integer. So converting <code>149A</code> to decimal results in <code>5274</code>, which is the correct password.</p>
<p><img alt="ioli-crackme-0x01-03" src="../images/ioli-crackme-0x01-03.png" /></p>
<h1 id="patching-the-executables">Patching the executables</h1>
<p>Patching the executable is actually the same process as <a href="../ioli-crackme-0x00.html">my writeup for 0x00</a>.</p>
<h1 id="passing-arguments-to-functions">Passing arguments to functions</h1>
<p>Since the crackme was cracked relatively quickly I want to review and highlight how arguments are passed to functions. </p>
<p>The format of the <code>scanf</code> function in C is like so:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span> <span class="nf">scanf</span> <span class="p">(</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">format</span><span class="p">,</span> <span class="p">...</span> <span class="p">);</span>
</code></pre></div>

<p>Here's an example of how it is used:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="n">scanf</span> <span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
</code></pre></div>

<p>If we look at the 0x01 program we could see how the arguments are passed to the <em>_scanf</em> function by placing the data to send on top of the stack.</p>
<div class="codehilite"><pre><span></span><code><span class="nf">lea</span> <span class="no">eax</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_4</span><span class="p">]</span>
<span class="nf">mov</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">18</span><span class="no">h</span><span class="err">+</span><span class="no">var_14</span><span class="p">],</span> <span class="no">eax</span>
<span class="nf">mov</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">18</span><span class="no">h</span><span class="err">+</span><span class="no">Format</span><span class="p">],</span> <span class="no">offset</span> <span class="no">aD</span><span class="c1">;  &quot;%d&quot;</span>
<span class="nf">call</span> <span class="no">_scanf</span>
</code></pre></div>

<p><code>lea eax, [ebp+var_4]</code> gets the address of <em>var_4</em>, this is the memory location where scanf would put the inputted data. This is then added to the stack with <code>mov [esp+18h+var_14]</code>.</p>
<p><code>offset aD</code> gets the address of <code>aD</code> which contains the string <em>"%d"</em>. This is the <em>format</em> parameter that <em>scanf</em> expects. This is then added to the stack with <code>mov [esp+18h+Format]</code>.</p>
<p>With the two parameters added to the stack, it can now be used by the <em>scanf</em> function when <code>call _scanf</code> is executed.</p>
<p>I'm not sure if I was able to explain that properly. At the very least, you should have been able to have a basic idea of how variables are passed to functions. Take note, however, that there are other calling conventions for functions which meants that the passing of arguments can also differ.</p>
<h1 id="on-to-the-next-challenge">On to the next challenge...</h1>
<p>This is the second challenge out of 10 in the IOLI series of challenges. So far the challenges are still very easy, which is fine because it's still good for practice. I look forward to the next one.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../ioli-crackme-0x01.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../ioli-crackme-0x00.html">IOLI Crackme 0x00</a></h1>
	<div class="meta">
          <time datetime="2021-02-16T21:55:00+08:00">February 16, 2021</time>
          in <span class="categories">
            <a href="../tag/re.html">re</a>,            <a href="../tag/crackme.html">crackme</a>          </span>
	</div>
        <p><p>I am re-familiarizing myself with reverse engineering again by going through some simple crackme challenges. This one is called the IOLI Crackmes by pof. The goal is to find the correct password and also to patch it so that it can accept any input and still show that it's correct.</p>
<h2 id="getting-the-password">Getting the password</h2>
<p>Running the program shows a password prompt. </p>
<p><img alt="ioli-crackme-0x00-03" src="../images/ioli-crackme-0x00-03.png" /></p>
<p>Of course, randomly entering passwords is going to be a waste of time so I opened up IDA to look at its code.</p>
<p>I knew that whatever password I enter in the program would be checked against the actual password. This is the part of the program that I should focus on so I scanned the code and found this:</p>
<p><img alt="ioli-crackme-0x00-02" src="../images/ioli-crackme-0x00-02.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="nf">mov</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="err">+</span><span class="no">Str2</span><span class="p">],</span> <span class="no">offset</span> <span class="no">Str2</span><span class="c1">; &quot;250382&quot;</span>
<span class="nf">mov</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">38</span><span class="no">h</span><span class="err">+</span><span class="no">Format</span><span class="p">],</span> <span class="no">eax</span><span class="c1">; </span>
<span class="nf">call</span> <span class="no">_strcmp</span>
</code></pre></div>

<p>And just from these few lines alone I already knew what the password is. IDA Pro was helpful enough to add a comment that <code>offset Str2</code> equates to <code>250382</code>. Surely enough, this number was the password.</p>
<p><img alt="ioli-crackme-0x00-04" src="../images/ioli-crackme-0x00-04.png" /></p>
<h2 id="patching-the-executable">Patching the executable</h2>
<p>The next part of the challenge is to patch the executable so that it can accept any input and would still allow us through.</p>
<p>Looking at the graph view, we want the program to always go to the node on the right which has the "Password OK" message. </p>
<p><img alt="ioli-crackme-0x00-05" src="../images/ioli-crackme-0x00-05.png" /></p>
<p>The line that we could change to allow us to do this would be this one:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">jz</span> <span class="no">short</span> <span class="no">loc_40138A</span>
</code></pre></div>

<p>The <code>jz</code> can be changed to a <code>jmp</code> command by changing the op code. Opening up the "Patch Bytes" window while the line is highlighted would show us this:</p>
<p><img alt="ioli-crackme-0x00-06" src="../images/ioli-crackme-0x00-06.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="mf">74</span> <span class="mf">0</span><span class="n">E</span> <span class="n">C7</span> <span class="mf">04</span> <span class="mf">24</span> <span class="mf">2</span><span class="n">E</span> <span class="mf">40</span> <span class="mf">40</span> <span class="mf">00</span> <span class="n">E8</span> <span class="n">A8</span> <span class="mf">19</span> <span class="mf">00</span> <span class="mf">00</span> <span class="n">EB</span> <span class="mf">0</span><span class="n">C</span>
</code></pre></div>

<p>The opcode related to <code>jz short loc_40138A</code> is the first two btyes <code>74 0E</code>. <code>74</code> is the "Jump short if equal" opcode and <code>0E</code> is the relative jump distance. Changing <code>74</code> to <code>EB</code> converts it to the "Jump" opcode effectively making the line <code>jmp short loc_40138A</code>.</p>
<p><img alt="ioli-crackme-0x00-07" src="../images/ioli-crackme-0x00-07.png" /></p>
<p>After saving, IDA will automatically upgrade the graph. It will now show us that the flow of the program now jumps to the right node directly.</p>
<p><img alt="ioli-crackme-0x00-08" src="../images/ioli-crackme-0x00-08.png" /></p>
<p>All that is left to do is to patch the executable via "Edit &gt; Patch Program &gt; Apply patches to input file..." and run the program. From here, any entered password would automatically get accepted.</p>
<p><img alt="ioli-crackme-0x00-09" src="../images/ioli-crackme-0x00-09.png" /></p>
<h2 id="on-to-the-next-challenge">On to the next challenge...</h2>
<p>This is the first out of the 10 challenges from this set. Since this is the first one, it is only natural for it to be very easy. It's still a good refresher for me especially since the last time I did any reversing was from a few years ago. I look forward to the next challenges, I do hope that they would ramp up in difficulty and also teach me new things for me to improve.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../ioli-crackme-0x00.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../hunt-the-kingdom-ctf-challenge.html">Hunt the Kingdom CTF Challenge</a></h1>
	<div class="meta">
          <time datetime="2020-10-05T11:13:00+08:00">October 05, 2020</time>
          in <span class="categories">
            <a href="../tag/ctf.html">ctf</a>,            <a href="../tag/cybersecurity.html">cybersecurity</a>          </span>
	</div>
        <p><blockquote>
<p>TLDR: Participated in a blue team CTF, had a lot of fun, looking forward for more</p>
</blockquote>
<p>Yesterday I participated in the <a href="https://www.facebook.com/guidemtraining">GuideM "Hunt the Kingdom" CTF challenge</a>. It served as the final activity at the end of the <em>"Cyber Defense and Threat Hunting"</em> course.</p>
<p>I was looking forward to this CTF, especially after my awesome experience with the <a href="../covidscammers-writeup--defcon-rtv-ctf.html">Red Team Village CTF at Defcon</a>. This one is centered on the Blue Team side, and I was curious as to how it will play out.</p>
<h2 id="the-preparation">The Preparation</h2>
<p>I took one whole day to study and prepare. I went through all our slides and have written down the important concepts and commands to an org file. This is important because I wanted them to be easily searchable, which helped a lot during the challenge.</p>
<p>I also did research about the Hunt the Kingdom challenge itself. There weren't much information online about it but there were <a href="https://www.facebook.com/guidemtraining/photos/a.142012317191141/229536238438748/">some social media posts</a> that contained screenshots on how the challenge looked like. These gave me a lot of information on what to expect.</p>
<p><img alt="hunt-the-kingdom-ctf-challenge-01" src="../images/hunt-the-kingdom-ctf-challenge-01.jpg" /></p>
<div class="codehilite"><pre><span></span><code>It&#39;s OSINT in practice :P
</code></pre></div>

<p>For example, with the screenshot above I learned how the UI looked like, that there were categories that we could switch to, leaderboards, how a question is structured, and that "areas" on the map can get added, enabled, and disabled during the game. The last part is particularly important as it means that not all questions are available from the start and some can get disabled during the game.</p>
<p>Thanks to the above research I felt confident that I could hit the ground running as soon as the game started. I picked my name (AccidentalRebel, of course) and my emblem and I was ready for the hunt.</p>
<p><img alt="hunt-the-kingdom-ctf-challenge-02" src="../images/hunt-the-kingdom-ctf-challenge-02.png" /></p>
<div class="codehilite"><pre><span></span><code>Yes, that&#39;s the blue tank from Advance Wars, because I&#39;m part of the &quot;blue team&quot;.
</code></pre></div>

<h2 id="the-hunt">The Hunt</h2>
<p>When the hunt started my approach was to focus on the easy problems first. Getting them out of the way early would allow me to rack up points and just focus on the hard ones afterwards. This did the trick and I was able to maintain an early lead.</p>
<p>During the mid-game my computer hanged from all the switching between VMs (There were 3 VMs that we needed to use to solve the problems). <em>Note to self: get a beefier PC</em>. I got a bit frustrated by this but decided that instead of waiting for Windows to boot I could use the time to take a break and got lunch. </p>
<p><img alt="hunt-the-kingdom-ctf-challenge-03" src="../images/hunt-the-kingdom-ctf-challenge-03.53" /></p>
<p>I came back to the game all full and refreshed, but sadly, I have already lost my lead. I felt a bit disappointed by this but I continued to push through. I removed the leaderboards to minimize distractions which helped. No need to pressure myself, I told myself. Although, I admit that I did peek from time to time.</p>
<p>With the renewed focus I was able to keep my standing in the top 3. The leader of the pack during the end-game was <em>BoyHack3r</em>, a worthy opponent who was always a few points ahead of me. </p>
<p>There was one question that has a lot of points that only has one solve. I knew that if I could get that it would give me enough points to snatch back 1st place. It wasn't an easy problem though so I changed my approach by slowing down which helped me understand the questions better. A few minutes later I was back at first place.</p>
<p>I've never done a celebratory fist pump before, this was the first time.</p>
<h2 id="the-final-minutes">The Final Minutes</h2>
<p>I was able to maintain first place position by continuously answering questions until I was left with just four questions. These four are problems that no one has solved yet. The activity on the leaderboards have lessened which I took to mean that the others were stuck like me. I was at 13740 points, BoyHack3r at 13590, and Overwatch at 13460. If any of them managed to solve just one out of these four problems then they'll easily overtake me.</p>
<p>I wasn't going to let that happen though. At 5 minutes left I continued solving the one that I had the most progress with. But it wasn't enough and I ran out of time. The others didn't get their lucky break either which finally cemented the scores on the boards.</p>
<p><img alt="hunt-the-kingdom-ctf-challenge-04" src="../images/hunt-the-kingdom-ctf-challenge-04.PNG" /></p>
<p>After 6 hours of back-breaking hunting I was finally able to breathe a sigh of relief. </p>
<h2 id="the-end">The End</h2>
<p>I rarely engage in any competitive activity so my competitive side rarely comes out. This CTF definitely brought it out and gave me the push to take the challenge seriously. I didn't do it for the prizes though. I did it because I wanted to prove to myself that I have what it takes, especially since I don't have a formal background in CyberSecurity. While a CTF is not an accurate qualification of being part of a blue team, it does show a participant's ability to work and solve problems under pressure.</p>
<p>I want to give a shoutout to <a href="https://www.facebook.com/guidemtraining">GuideM</a> for guiding us throughout the course and for the extremely fun CTF challenge. Also to <em>BoyHack3r</em>, <em>Overwatch</em>, and <em>:]</em> for making me sweat bullets.</p>
<p>This is another big step for me into the world of cybersecurity and I do hope I could learn more and improve. I look forward to the next CTF!</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../hunt-the-kingdom-ctf-challenge.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../my-experience-manufacturing-printed-circuit-boards.html">My experience with manufacturing printed circuit boards</a></h1>
	<div class="meta">
          <time datetime="2020-10-01T07:19:00+08:00">October 01, 2020</time>
          in <span class="categories">
            <a href="../tag/pcbs.html">pcbs</a>,            <a href="../tag/electronics.html">electronics</a>          </span>
	</div>
        <p><p>I've done a lot of electronics projects already, all of them were painstakingly hand-soldered on a perfboard. I actually like this approach for quick prototyping, and plus, I've also grown fond of how "raw" it looks like. In spite of this, I've always been curious and interested in having my own printed PCB. I remember designing one for my <a href="https://hackaday.io/project/164144-tiro-vibrating-watch/log/161430-current-state-and-next-steps">TIRO vibrating watch</a> but I never pushed through with it because I wasn't confident with what I've made.</p>
<p><img alt="my-experience-manufacturing-printed-circuit-boards-01" src="../images/my-experience-manufacturing-printed-circuit-boards-01.jpg" /></p>
<div class="codehilite"><pre><span></span><code>I really like the raw, almost electronic-punk look of my work
</code></pre></div>

<p>A couple of months ago I got an email from <a href="https://www.pcbway.com/">PCBWay</a> asking if I was interested in trying out their PCB manufacturing service. The email from PCBWay re-ignited this interest in having a PCB made. The problem is I didn't have a PCB design that I built myself that I knew was going to work. My best option was the "ESPBoy project".</p>
<p>The <a href="https://hackaday.io/project/164830-espboy-the-ultimate-multi-gadget">ESPBoy</a> is a project by <a href="https://hackaday.io/ESPboy.edu">RomanS</a> that is touted to be the ultimate multi-gadget. RomanS sent me a kit a long time ago (Thank's again, RomanS). I have assembled and <a href="https://www.youtube.com/watch?v=GIrp5Vpr2Ns&amp;feature=emb_title">made a tutorial video</a> for it which means that I know that it works and have a very good idea of how it is laid out.</p>
<p>With that decided, having the PCB made was a very easy and quick process. I just uploaded the gerber file on the PCBWay website, waited for the review of the PCB to be finished, and in a few hours I clicked the submit button and it was off to the printers.</p>
<p>Fast forward a few weeks later and the package with the printed pcbs arrived.</p>
<p><img alt="my-experience-manufacturing-printed-circuit-boards-02" src="../images/my-experience-manufacturing-printed-circuit-boards-02.jpg" /></p>
<div class="codehilite"><pre><span></span><code>And yes, I changed the color to red just so they would look different.
</code></pre></div>

<p>I must say that I am very impressed with the quality of the PCBs. The material feels really solid and the lines so fine and accurate. I've seen and held PCB etchings before, and this is like lightyears ahead in terms of quality. The same can be said with my hand soldered perfboards, of course.</p>
<p>Sadly, these PCBs have been sitting in storage because I haven't found the time due to the baby. Thankfully, my schedule is slowly opening up recently and I plan to build one ESPBoy in the next coming weeks. I plan to remove the parts from the old one and put it on this. This newer PCB design has new features like the ability to connect to an app store (yeah, seriously) and I'm really curious to try it out.</p>
<p>I also might consider having another PCB made, but this time with my own design. I'm thinking I might go ahead and have my TIRO watch made, or maybe something even simpler. We'll see.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../my-experience-manufacturing-printed-circuit-boards.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../covidscammers-writeup--defcon-rtv-ctf.html">CovidScammers writeup (Defcon RTV CTF)</a></h1>
	<div class="meta">
          <time datetime="2020-08-13T16:58:00+08:00">August 13, 2020</time>
          in <span class="categories">
            <a href="../tag/ctf.html">ctf</a>,            <a href="../tag/writeup.html">writeup</a>,            <a href="../tag/malware_analysis.html">malware_analysis</a>,            <a href="../tag/defcon.html">defcon</a>          </span>
	</div>
        <p><p>I joined the <a href="https://ctf.threatsims.com">Defcon Red Team Village CTF</a> because I was curious about it and I wanted to test out the skills that I have gained playing with CTF sites like <a href="https://overthewire.org/wargames/">overthewire.org</a> and <a href="https://www.vulnhub.com/">vulnhub</a>. I knew that the challenges won't be easy, but thankfully, I was able to join up with other newbies who were willing to give it a go and learn with each other.</p>
<p>Unfortunately, I fell asleep just before the CTF started and when I woke up all the easy challenges were already solved by my team members. There was one easy challenge that was still open on the CovidScammers category, so I quickly got started to solving that.</p>
<h2 id="free-flag-and-binary-1-point">Free Flag (and binary) [1 point]</h2>
<blockquote>
<p>You've been contacted by a high-end but morally ambiguous finance company (unhackable-bitcoin-wallet.com) to investigate a data breach. The box in question is a mail server in their internal network, a sample of the malware found on the system has been pulled and given to you. Your task, should you choose to accept it, is to reverse-engineer the sample and locate, fuzz and exploit the C2 server, and then hack-back to learn about the malicious actor and recover the stolen documents.
Look for the free flag. Get on the scoreboard!</p>
</blockquote>
<p>I admit that in a hurry to get points I did not properly read the description of the challenge. I understood that I'll be downloading and reverse-engineering something. But it did not register on my mind that it's actually malware.</p>
<p>The download was a binary that doesn't do anything when run. My first instict was to use <code>strings</code> to look for the flag, which turned out to be correct.</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-01" src="../images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-01.png" /></p>
<p>The flag is: <code>TS{freeFlagLookAtMe}</code>.</p>
<p>Unfortunately, this challenge was already solved by a team member so I did not get the free flag. The second one, is still open though.</p>
<h2 id="syscalls-5-points">Syscalls [5 points]</h2>
<blockquote>
<p>What syscall is hindering your dynamic analysis? Flag is just the syscall, no brackets or anything.</p>
</blockquote>
<p>If we run the file from within gdb to debug it we get:</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-02" src="../images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-02.png" /></p>
<blockquote>
<p>can't debug this, na na na na...</p>
</blockquote>
<p>So from the description we are looking for a syscall that is hindering the debugging of the binary. If we want to find out what syscalls are called by a program, we could determine that using the <code>strace</code> command.</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-03" src="../images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-03.png" /></p>
<p>Just before the write syscall for the "na na na" message we see:</p>
<blockquote>
<p>ptrace(TRACE_TRACEME) = -1 EPERM (Operation not permitted)</p>
</blockquote>
<p>I'm unfamiliar with <code>ptrace</code> so I researched it and tried to understand how it could prevent debugging. I learned that <code>ptrace</code> can be used as an anti-debugging technique as can be seen <a href="https://www.aldeid.com/wiki/Ptrace-anti-debugging">here</a>.</p>
<p>Sure, enough the flag is: <code>ptrace</code>. </p>
<p>I got 5 points from this and I finally have a contribution to my team! Unfortunately, real life prevented me from continuing with the CTF and I had to bow out early.</p>
<h3 id="sidenote-how-to-bypass-ptrace">Sidenote: How to bypass ptrace?</h3>
<p>How does one bypass this anti-debugging feature? <a href="https://dev.to/denisnutiu/bypassing-ptrace-calls-with-ldpreload-on-linux-12jl">Here's one approach</a> that I tried which should work in theory but doesn't. My guess is that this particular binary has an additional way to prevent debugging, like it spawns a child process and it stays there even if you bypass ptrace. I'd have to look into this further in the future.</p>
<h2 id="shared-secrets-150-points">Shared Secrets [150 points]</h2>
<blockquote>
<p>The malware creates a shared-memory object and stores a flag inside. Recover the flag. Flag has the TS{} format, you'll know when you get it.</p>
</blockquote>
<p>I was able to solve this challenge after the CTF preliminaries ended. By this time I was already well rested and have a clearer mind. It was also at this time that I realized that the file is actually a malware and has already infected my machine. Thankfully, I was running a virtual machine which meant I could just revert back to an old working restore point.</p>
<p>Knowing that the file is a malware, the next step I did was to run <code>rkhunter</code> to look for rootkits and suspcious files. This gave me an interesting finding:</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-04" src="../images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-04.png" /></p>
<p>Opening the suspicious file revealed this: </p>
<blockquote>
<p>KRJXW22FMVYES5CTMVBXERKUNNCWK4CJORJWCRTFFZGXERTSGBSE6IL5</p>
</blockquote>
<p>This is not the flag yet, it needs to be in the "TS{}" format as instructed in the challenge description.</p>
<p>I initially had a hard time figuring out how to decode this. It wasn't <code>base64</code> nor any other popular encoding. Thankfully, there are tools like <a href="https://gchq.github.io/CyberChef/">CyberChef</a> to help with this kind of problem. After some experimentation, the "magic" recipe did the trick and revealed to me that it was actually a <code>base32</code> encoding.</p>
<p><img alt="giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-05" src="../images/giving-malware-to-a-noob--defcon-rtv-ctf-covidscammers-writeup-05.png" /></p>
<p>This gave me the flag: <code>TS{kEepItSeCrETkEepItSaFe.MrFr0dO!}</code></p>
<h2 id="license-and-registration-100-points">License and Registration [100 points]</h2>
<blockquote>
<p>The malware creates a UUID and stores it in a file, what is the name of this file. Provide the SHA1 hash of hte full path as the flag.</p>
</blockquote>
<p>So the description above says that a file is created by the malware and stores data inside of it. I figured that the easiest way to figure out what this created file is to: </p>
<ul>
<li>Restore to a previous restore point before I opened the malware</li>
<li>Run the malware, and then;</li>
<li>Inspect which other files were created at the time of execution. </li>
</ul>
<p>I found out which files were recently created during the last 2 minutes using the following command:</p>
<div class="codehilite"><pre><span></span><code>$ find / -user kali -mmin <span class="m">2</span> -type f <span class="m">2</span>&gt; /dev/null
</code></pre></div>

<p>This showed me a lot of files, but after sifting through that I found one file that seesm promising.</p>
<blockquote>
<p>/tmp/.serverauth.tn6aUcM0uM</p>
</blockquote>
<p>To get the flag I did this:</p>
<div class="codehilite"><pre><span></span><code>$ <span class="nb">echo</span> -n <span class="s2">&quot;/tmp/.serverauth.tn6aUcM0uM&quot;</span> <span class="p">|</span> sha1sum
</code></pre></div>

<p>Which resulted in this flag: <code>5b4e97047851682649a602ad62ba4af567e352a3</code></p>
<h2 id="to-be-continued">To be continued?</h2>
<p>So I wanted to try and work on the other challenges but it seems that <a href="https://ctf.threatsims.com">the ctf site</a> is currently down. The site redirected to a different non https site and it spooked me so I stopped trying. Good thing that I had NoScript on.</p>
<p>If you want a longer and more pro writeup about the CovidScammers challenges do check out <a href="https://0xdf.gitlab.io/2020/05/04/covid-19-ctf-covidscammers.html">0xdf's writeup about it</a>.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../covidscammers-writeup--defcon-rtv-ctf.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../study-notes--mac-spoofing.html">Study notes: MAC Spoofing</a></h1>
	<div class="meta">
          <time datetime="2020-08-01T11:07:00+08:00">August 01, 2020</time>
          in <span class="categories">
            <a href="../tag/spoofing.html">spoofing</a>,            <a href="../tag/cybersecurity.html">cybersecurity</a>          </span>
	</div>
        <p><div class="codehilite"><pre><span></span><code>Study notes are my personal research notes on certain topics that interests me.
</code></pre></div>

<p>Any network capable device has a unique factory-assigned Media Access Control (MAC) address. Users have no way to change the MAC address but it can be done. However, it is possible to mask the MAC address and have it show a different value. This is called MAC spoofing.</p>
<p>There are legitimate uses for MAC spoofing. For example, there may be certain applications that require a particular MAC address to work, or maybe your ISP expects a certain MAC address to connect to the network. MAC spoofing is largely used for illegitimate uses, like circumventing an access control list or getting past a filter on a wireless network.</p>
<h2 id="changing-mac-address-via-ifconfig">Changing MAC Address via ifconfig</h2>
<p>In Linux we could use <code>ifconfig</code> to change the MAC address.</p>
<p>To view the current MAC address:</p>
<div class="codehilite"><pre><span></span><code>$ ifconfig
</code></pre></div>

<p>The current MAC address is <code>08:00:27:59:fb:fa</code>:</p>
<p><img alt="study-notes--mac-spoofing-01" src="../images/study-notes--mac-spoofing-01.png" /></p>
<p>Let's say we want to change the MAC address of our interface (eth0) to <code>00:11:22:33:44:55</code>.</p>
<p>First, deactivate the interface.</p>
<div class="codehilite"><pre><span></span><code>$ ifconfig eth0 down
</code></pre></div>

<p>Then we specify the mac address that we want to change to.</p>
<div class="codehilite"><pre><span></span><code>$ ifconfig eth0 hw ether <span class="m">00</span>:11:22:33:44:55
</code></pre></div>

<p>Reactive the interface:</p>
<div class="codehilite"><pre><span></span><code>$ ifconfig eth0 up
</code></pre></div>

<p>Run <code>ifconfig</code> again to see the changes.</p>
<p><img alt="study-notes--mac-spoofing-02" src="../images/study-notes--mac-spoofing-02.png" /></p>
<h3 id="note">NOTE:</h3>
<p>These changes are not permanent. The MAC address will return to the original one when the system is restarted!</p>
<h2 id="changing-the-mac-address-via-macchanger">Changing the MAC address via MACChanger</h2>
<p>There are various tools that allows easy changing of MAC addresses. <a href="https://github.com/alobbs/macchanger">MACChanger</a> is one of them.</p>
<p>First, deactivate the interface.</p>
<div class="codehilite"><pre><span></span><code>$ ifconfig eth0 down
</code></pre></div>

<p>The above below allows you specify the mac address you want to use:</p>
<div class="codehilite"><pre><span></span><code>$ macchanger -m <span class="m">00</span>:11:22:33:44:55 eth0
</code></pre></div>

<p>The code below assigns a random MAC address.</p>
<div class="codehilite"><pre><span></span><code>$ macchanger -r eth0
</code></pre></div>

<p>Reactive the interface:</p>
<div class="codehilite"><pre><span></span><code>$ ifconfig eth0 up
</code></pre></div>

<h2 id="related-reading">Related reading</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/MAC_spoofing">MAC Spoofing on Wikipedia</a></li>
<li><a href="https://www.giac.org/paper/gsec/3199/mac-spoofing-an-introduction/105315">MAC Spoofing - An introduction</a> </li>
<li><a href="https://www.comparitech.com/net-admin/spoofing-attacks-guide/">A guide to spoofing attacks and how to prevent them</a></li>
</ul>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../study-notes--mac-spoofing.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../chicken-scheme-ffi-examples.html">Chicken-Scheme FFI Examples</a></h1>
	<div class="meta">
          <time datetime="2020-06-16T05:58:00+08:00">June 16, 2020</time>
          in <span class="categories">
            <a href="../tag/programming.html">programming</a>,            <a href="../tag/dev.html">dev</a>,            <a href="../tag/research.html">research</a>,            <a href="../tag/code.html">code</a>          </span>
	</div>
        <p><p>I'm currently working on refactoring the FFI implementation for <a href="https://github.com/accidentalrebel/rebel-game-engine">the Rebel Game Engine</a>. It was previously written using the <a href="http://wiki.call-cc.org/eggref/5/bind">Bind chicken egg</a> but I wanted to have more control over the implementation by using the low level foreign functions. </p>
<p>To help me better understand I made some examples that has the basic FFI implementations that I'll be needing for my project.</p>
<hr />
<h2 id="foreign-lambda-example">foreign-lambda example</h2>
<p>Let's say we have a structure <code>Vec3</code> and a function <code>Vec3Create</code> that we want to access from chicken-scheme.</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">Vec3</span> <span class="p">{</span>
    <span class="kt">float</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Vec3</span><span class="p">;</span>

<span class="n">Vec3</span><span class="o">*</span> <span class="nf">Vec3Create</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">y</span><span class="p">,</span> <span class="kt">float</span> <span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Vec3</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">Vec3</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Vec3</span><span class="p">));</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
    <span class="n">v</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>We could use <a href="https://wiki.call-cc.org/man/5/Module%20(chicken%20foreign)#foreign-lambda"><code>foreign-lambda</code></a> to bind to the function:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define </span><span class="nv">vec3_create</span>
  <span class="p">(</span><span class="nf">foreign-lambda</span>
    <span class="p">(</span><span class="nf">c-pointer</span> <span class="p">(</span><span class="nf">struct</span> <span class="s">&quot;Vec3&quot;</span><span class="p">))</span>   <span class="c1">; Return type, a pointer to a struct object of Vec3</span>
    <span class="s">&quot;Vec3Create&quot;</span>                  <span class="c1">; Name fo the function</span>
    <span class="nv">float</span> <span class="nv">float</span> <span class="nv">float</span><span class="p">))</span>           <span class="c1">; The three parameters (x,y,z) to pass to the function</span>
</code></pre></div>

<p>This would allow us to call the <code>vec3_create</code> function like so:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">vec3_create</span> <span class="mf">1.1</span> <span class="mf">2.2</span> <span class="mf">3.3</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="foreign-lambda-example_1">foreign-lambda* example</h2>
<p>Let's bind another C function <code>Vec3Print</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span> <span class="nf">Vec3Print</span><span class="p">(</span><span class="n">Vec3</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Vec3 to print: (%f, %f, %f)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>We could also use <a href="https://wiki.call-cc.org/man/5/Module%20(chicken%20foreign)#foreign-lambda"><code>foreign-lambda*</code></a> (Notice the asterisk). This is similar to <code>foreign-lambda</code> but accepts C code as a string.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define </span><span class="nv">vec3_print</span>
  <span class="p">(</span><span class="nf">foreign-lambda*</span>
    <span class="nv">void</span>                          <span class="c1">; The return type</span>
    <span class="p">(((</span><span class="nf">c-pointer</span> <span class="p">(</span><span class="nf">struct</span> <span class="s">&quot;Vec3&quot;</span><span class="p">))</span> <span class="nv">a0</span><span class="p">))</span> <span class="c1">; The parameter to pass, a pointer to a Vec3 object</span>
    <span class="s">&quot;Vec3Print(*a0);&quot;</span><span class="p">))</span>           <span class="c1">; The C code in string from</span>
                                  <span class="c1">; Vec3Print accepts a non pointer, we dereference it</span>

<span class="p">(</span><span class="nf">vec3_print</span> <span class="p">(</span><span class="nf">vec3_create</span> <span class="mf">1.1</span> <span class="mf">2.2</span> <span class="mf">3.3</span><span class="p">))</span>   <span class="c1">; Creates a vec3 and prints it</span>
</code></pre></div>

<hr />
<h2 id="inline-c-code-in-foreign-lambda">Inline C code in foreign-lambda*</h2>
<p>Here's another example using <code>foreign-lambda*</code>. This time there is no predefined C function, but instead we define the code inside the lisp function's body.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define </span><span class="nv">vec3_zero</span>
  <span class="p">(</span><span class="nf">foreign-lambda*</span>
    <span class="p">(</span><span class="nf">c-pointer</span> <span class="p">(</span><span class="nf">struct</span> <span class="s">&quot;Vec3&quot;</span><span class="p">))</span>
    <span class="p">()</span>                            <span class="c1">; Empty variables</span>
    <span class="s">&quot;Vec3* v = (Vec3*)Vec3Create(0.0f, 0.0f, 0.0f); </span>
<span class="s">    C_return(v);&quot;</span><span class="p">))</span>               <span class="c1">; Instead of &quot;return&quot;, we use &quot;C_return&quot;.</span>

<span class="p">(</span><span class="nf">vec3_print</span> <span class="p">(</span><span class="nf">vec3_zero</span><span class="p">))</span>          <span class="c1">; Calls vec3_zero and prints the returned Vec3</span>
</code></pre></div>

<p>Note that due to obscure technical reasons <code>C_return</code> must be used instead of <code>return</code> when returning a value. More info about this <a href="https://wiki.call-cc.org/man/5/Module%20(chicken%20foreign)#foreign-lambda">here</a>.</p>
<hr />
<h2 id="free-ing-vec3-pointers">Free-ing Vec3 pointers</h2>
<p>Since <code>Vec3Create</code> allocates memory for a Vec3 struct using <code>malloc</code>, it's a good idea to free this when we are done using it. To do this we could bind a function to <code>free</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define </span><span class="nv">free</span> <span class="p">(</span><span class="nf">foreign-lambda</span> <span class="nv">void</span> <span class="s">&quot;free&quot;</span> <span class="nv">c-pointer</span><span class="p">))</span>

<span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">v</span> <span class="p">(</span><span class="nf">vec3_zero</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">vec3_print</span> <span class="nv">v</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">free</span> <span class="nv">v</span><span class="p">))</span>
</code></pre></div>

<hr />
<h2 id="setting-up-getters-and-setters">Setting up getters and setters</h2>
<p>If we want to have access to variables of a struct object. We could do something like this:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define </span><span class="nv">vec3_x</span>
  <span class="p">(</span><span class="nf">foreign-lambda*</span>
    <span class="nv">float</span>
    <span class="p">(((</span><span class="nf">c-pointer</span> <span class="p">(</span><span class="nf">struct</span> <span class="s">&quot;Vec3&quot;</span><span class="p">))</span> <span class="nv">a0</span><span class="p">))</span>
    <span class="s">&quot;C_return(a0-&gt;x);&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">display </span><span class="p">(</span><span class="nf">vec3_x</span> <span class="p">(</span><span class="nf">vec3_create</span> <span class="mf">8.8</span> <span class="mf">8.8</span> <span class="mf">8.8</span><span class="p">)))</span>
</code></pre></div>

<p>Now this is fine but it'll be a pain to specify an accessor for every variable. A better solution is to use the <a href="http://wiki.call-cc.org/eggref/5/foreigners#define-foreign-enum-type"><code>foreigners</code></a> egg which allows the use of macros that will make our lives easier.</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nf">import</span> <span class="p">(</span><span class="nf">chicken</span> <span class="nv">foreign</span><span class="p">))</span>
<span class="p">(</span><span class="nf">import</span> <span class="nv">foreigners</span><span class="p">)</span>

<span class="c1">;; Set up the accessors for Vec3 struct</span>
<span class="p">(</span><span class="nf">define-foreign-record-type</span> <span class="p">(</span><span class="nf">vec3</span> <span class="nv">Vec3</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">float</span> <span class="nv">x</span> <span class="nv">vec3_x</span> <span class="nv">vec3_x!</span><span class="p">)</span>   <span class="c1">; vec3_x is a getter, vec3_x! is a setter</span>
  <span class="p">(</span><span class="nf">float</span> <span class="nv">y</span> <span class="nv">vec3_y</span> <span class="nv">vec3_y!</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">float</span> <span class="nv">z</span> <span class="nv">vec3_z</span> <span class="nv">vec3_z!</span><span class="p">))</span>

<span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">v</span> <span class="p">(</span><span class="nf">vec3_create</span> <span class="mf">4.4</span> <span class="mf">5.5</span> <span class="mf">6.6</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">display </span><span class="p">(</span><span class="nf">vec3_x</span> <span class="nv">v</span><span class="p">))</span> <span class="c1">; Display value of x</span>
  <span class="p">(</span><span class="nf">newline</span><span class="p">)</span>

  <span class="p">(</span><span class="nf">vec3_x!</span> <span class="nv">v</span> <span class="mf">7.7</span><span class="p">)</span>      <span class="c1">; Set x to 7.7</span>
  <span class="p">(</span><span class="nb">display </span><span class="p">(</span><span class="nf">vec3_x</span> <span class="nv">v</span><span class="p">))</span> <span class="c1">; Display value of x</span>
  <span class="p">(</span><span class="nf">newline</span><span class="p">)</span>

  <span class="p">(</span><span class="nf">free</span> <span class="nv">v</span><span class="p">))</span>
</code></pre></div>

<hr />
<h2 id="binding-enums">Binding enums</h2>
<p>The <a href="http://wiki.call-cc.org/eggref/5/foreigners#define-foreign-enum-type"><code>foreigners</code></a> egg also allows for the binding of enums using <a href="http://wiki.call-cc.org/eggref/5/foreigners#define-foreign-enum-type"><code>define-foreign-enum-type</code></a>. Say we have an enum declaration <code>Keys</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="k">enum</span> <span class="n">Keys</span> <span class="p">{</span>
  <span class="n">UP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">RIGHT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">DOWN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
  <span class="n">LEFT</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="o">:::</span><span class="n">scheme</span>
<span class="p">(</span><span class="n">define</span><span class="o">-</span><span class="n">foreign</span><span class="o">-</span><span class="k">enum</span><span class="o">-</span><span class="n">type</span> <span class="p">(</span><span class="n">keys</span> <span class="kt">int</span><span class="p">)</span>
  <span class="p">(</span><span class="n">keys</span><span class="o">-&gt;</span><span class="kt">int</span> <span class="kt">int</span><span class="o">-&gt;</span><span class="n">keys</span><span class="p">)</span>
  <span class="p">((</span><span class="n">up</span> <span class="n">keys</span><span class="o">/</span><span class="n">up</span><span class="p">)</span> <span class="n">UP</span><span class="p">)</span>
  <span class="p">((</span><span class="n">right</span> <span class="n">keys</span><span class="o">/</span><span class="n">right</span><span class="p">)</span> <span class="n">RIGHT</span><span class="p">)</span>
  <span class="p">((</span><span class="n">down</span> <span class="n">keys</span><span class="o">/</span><span class="n">down</span><span class="p">)</span> <span class="n">DOWN</span><span class="p">)</span>
  <span class="p">((</span><span class="n">left</span> <span class="n">keys</span><span class="o">/</span><span class="n">left</span><span class="p">)</span> <span class="n">LEFT</span><span class="p">))</span>

<span class="p">(</span><span class="n">display</span> <span class="n">keys</span><span class="o">/</span><span class="n">right</span><span class="p">)</span>
<span class="p">(</span><span class="n">display</span> <span class="n">keys</span><span class="o">/</span><span class="n">down</span><span class="p">)</span>
</code></pre></div>

<hr />
<p>These are the basic FFI implementations that I have explored. It should be enough for most uses. The example project with working code can be found <a href="https://github.com/accidentalrebel/chicken-scheme-ffi-example">on Github</a>.</p>
<p>Also, check out <a href="http://wiki.call-cc.org/eggref/5/bind">the chicken-bind egg</a>, it already has all of the code above conveniently in one package. If you don't need full control and just want a simple FFI solution then this is what you need.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../chicken-scheme-ffi-examples.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../switching-from-c-c---to-c.html">#5 - Switching from C/C++ to C</a></h1>
	<div class="meta">
          <time datetime="2020-05-19T17:59:00+08:00">May 19, 2020</time>
          in <span class="categories">
            <a href="../tag/dev.html">dev</a>,            <a href="../tag/game_engine.html">game_engine</a>          </span>
	</div>
        <p><p>After the recent changes to the <a href="../following-lispy-conventions.html">lisp side of my engine</a>, I took some time to review the C/C++ side. You'll notice that I have written C/C++ and that's because my codebase uses both of them. </p>
<p>When I started my project, I initially intended for it to use just pure C, as this is the one I'm more familiar with. But over time some C++ features crept in. Features like namespacess, bools, and function overloading proved to be useful so I kept using them. Now my code uses C concepts with new nifty C++ features.</p>
<p>Now, I could have just continued with this approach. It works, after all. But I wondered if I should just stick to C and drop C++ altogether. My thinking is that sticking with just one language would make the code simpler as I only have to use it's subset of features. I know it's not a solid reason but I figured it's better to act now while it is still early.</p>
<p><img alt="switching-from-c-c---to-c-01" src="../images/switching-from-c-c---to-c-01.png" /></p>
<p>For the most part, dropping C++ was easy. Most of the difficulty I encountered was making sure the changes worked on all three supported platforms. There was a situation when <a href="https://github.com/accidentalrebel/rebel-game-engine/commits/cglm-switch-fix">I thought I was done</a> only to find it doesn't work on Mac and Windows. I had to <a href="https://github.com/accidentalrebel/rebel-game-engine/commits/cglm-switch-fix">slowly re-apply</a> the changes just to see where exactly things went wrong.</p>
<p>What's funny is that I learned that I was using a lot more C++ features than I thought. Namespaces and default arguments are some that really surprised me. I always assumed they were supported on both languages. This just proves to me that I still have a lot to learn with these languages.</p>
<p>I also took the chance during the transition to switch from <a href="https://glm.g-truc.net/0.9.9/index.html">GLM</a>, an OpenGL Mathematics lirary using C++, to <a href="https://github.com/recp/cglm">CGLM</a> a similar library that uses C. It is claimed that the latter is more optimized and, with it being in C, is easier to integrate with my codebase.</p>
<p>While these changes did not do much in terms of progress, I am happy that my codebase now feels tighter and more coherent. I'm hoping to work on something engine-related next.</p>
<p>If you are interested to check out my still-under-construction game engine, you can do so <a href="https://github.com/accidentalrebel/Rebel-Game-Engine">here</a>.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../switching-from-c-c---to-c.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="../following-lispy-conventions.html">#4 - Following Lispy conventions</a></h1>
	<div class="meta">
          <time datetime="2020-05-15T07:00:00+08:00">May 15, 2020</time>
          in <span class="categories">
            <a href="../tag/dev.html">dev</a>,            <a href="../tag/game_engine.html">game_engine</a>          </span>
	</div>
        <p><p><img alt="following-lispy-conventions-01" src="../images/following-lispy-conventions-01.png" /></p>
<p>I was adding new Lisp functions to <a href="https://github.com/accidentalrebel/Rebel-Game-Engine">my game engine</a> when I noticed that I had functions that had a naming scheme that were inconsistent with others. For example, I had ones that create objects like <em>sprite_create</em> and <em>shader_create</em> but this one function I named <em>make_vec3</em>. I proceeded to rename <em>make_vec3</em> to <em>vec3_create</em>. Not only is it consistent with other names but it made me realize that having a pattern of object_verb makes it easy to parse the function and what it does. </p>
<p>This made me wonder if there are other ways I could improve which led me to this page <a href="http://community.schemewiki.org/?variable-naming-convention">about variable naming conventions</a> for Scheme. I learned that the language employs a rather effective yet simple naming convention for functions and variables. I've noticed them before but never really thought about their usefulness. </p>
<p>For example, adding a <em>?</em> prefix easily indicates that the function, when called, will always return a boolean value. I looked at my code and I had the function <em>is_key_down</em>. Changing it to <em>key_down?</em> looked weird at first but I liked how it made the function name shorter and the <em>?</em> prefix made it easy to spot and parse.</p>
<p>Okay, cool! What's next?</p>
<p>Adding a <em>!</em> indicates a function that mutates data. Most commonly used for setting a variable. I saw I had variables like <em>set_vec3_x</em>, to which I changed to <em>vec3_x!</em>.</p>
<p>This went on as I continue to find improvements. Here's a list of all the naming convention changes that I've made:</p>
<table>
<thead>
<tr>
<th align="center"><strong>The change</strong></th>
<th align="center"><strong>From</strong></th>
<th align="center"><strong>To</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><em>:</em> infix for namespaces.</td>
<td align="center">vec3_create</td>
<td align="center">vec3:create</td>
</tr>
<tr>
<td align="center"><em>?</em> postfix for boolean functions</td>
<td align="center">key_down?</td>
<td align="center">key:down?</td>
</tr>
<tr>
<td align="center"><em>!</em> postfix for destructive functions</td>
<td align="center">set_camera_position</td>
<td align="center">camera:position!</td>
</tr>
<tr>
<td align="center"><em>%</em> postfix for low level functions</td>
<td align="center">free</td>
<td align="center">free%</td>
</tr>
<tr>
<td align="center"><em>%</em> prefix and postfix for low level variables</td>
<td align="center">shader-pointer</td>
<td align="center">%shader-pointer%</td>
</tr>
<tr>
<td align="center"><em>*</em> prefix and postfix for global variables</td>
<td align="center">cube-shader</td>
<td align="center">*cube-shader*</td>
</tr>
</tbody>
</table>
<p>Again, these new changes felt weird at first but I quickly became accustomed the more of these functions I changed. The code became easier to scan as there are now key characters for my eyes to easily latch onto. Something to appreciate especially with multi-level nested expressions.</p>
<p>Here's how the code now looks like with the new functions:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="k">define </span><span class="nv">MOVEMENT_SPEED</span> <span class="mf">0.001</span><span class="p">)</span>

<span class="p">(</span><span class="k">define </span><span class="nv">*cube*</span><span class="p">)</span>
<span class="p">(</span><span class="k">define </span><span class="nv">*cube-shader*</span><span class="p">)</span>
<span class="p">(</span><span class="k">define </span><span class="nv">*cube-positions*</span><span class="p">)</span>

<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">init</span><span class="p">)</span>
  <span class="p">(</span><span class="k">set! </span><span class="nv">*cube*</span>
    <span class="p">(</span><span class="nf">cube:create</span> <span class="s">&quot;assets/textures&quot;</span> <span class="s">&quot;awesomeface.png&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="k">set! </span><span class="nv">*cube-shader*</span>
    <span class="p">(</span><span class="nf">shader:create</span> <span class="s">&quot;shaders/simple-3d.vs&quot;</span> <span class="s">&quot;shaders/simple.fs&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="k">set! </span><span class="nv">*cube-positions*</span>
    <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">vec3:create</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">vec3:create</span> <span class="mf">1.25</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">vec3:create</span> <span class="mf">-1.25</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">update</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">window:clear</span><span class="p">)</span>

  <span class="p">(</span><span class="k">let* </span><span class="p">((</span><span class="nf">main-camera</span> <span class="p">(</span><span class="nf">camera:main</span><span class="p">))</span>
     <span class="p">(</span><span class="nf">current-projection</span> <span class="p">(</span><span class="nf">camera:projection</span> <span class="nv">main-camera</span><span class="p">))</span>
     <span class="p">(</span><span class="nf">camera-pos</span> <span class="p">(</span><span class="nf">camera:position</span> <span class="nv">main-camera</span><span class="p">)))</span>

    <span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">key:up?</span> <span class="nv">KEY_C</span><span class="p">)</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">current-projection</span> <span class="nv">PERSPECTIVE</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">camera:projection!</span> <span class="nv">main-camera</span> <span class="nv">ORTHOGRAPHIC</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">camera:projection!</span> <span class="nv">main-camera</span> <span class="nv">PERSPECTIVE</span><span class="p">)))</span>

    <span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">key:down?</span> <span class="nv">KEY_A</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">vec3:x!</span> <span class="nv">camera-pos</span>
          <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">vec3:x</span> <span class="nv">camera-pos</span><span class="p">)</span> <span class="nv">MOVEMENT_SPEED</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">key:down?</span> <span class="nv">KEY_E</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">vec3:x!</span> <span class="nv">camera-pos</span>
          <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">vec3:x</span> <span class="nv">camera-pos</span><span class="p">)</span> <span class="nv">MOVEMENT_SPEED</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">key:down?</span> <span class="nv">KEY_COMMA</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">vec3:z!</span> <span class="nv">camera-pos</span>
          <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">vec3:z</span> <span class="nv">camera-pos</span><span class="p">)</span> <span class="nv">MOVEMENT_SPEED</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">when</span> <span class="p">(</span><span class="nf">key:down?</span> <span class="nv">KEY_O</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">vec3:z!</span> <span class="nv">camera-pos</span>
          <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">vec3:z</span> <span class="nv">camera-pos</span><span class="p">)</span> <span class="nv">MOVEMENT_SPEED</span><span class="p">))))</span>

  <span class="p">(</span><span class="nf">for-each</span>
   <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">position</span><span class="p">)</span>
     <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">%tint%</span> <span class="p">(</span><span class="nf">vec3:create%</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">)))</span>
       <span class="p">(</span><span class="nf">cube:draw</span> <span class="nv">*cube*</span> <span class="nv">position</span> <span class="mi">1</span> <span class="mi">1</span> <span class="nv">%tint%</span> <span class="nv">*cube-shader*</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">free%</span> <span class="nv">%tint%</span><span class="p">)))</span>
   <span class="nv">*cube-positions*</span><span class="p">)</span>

  <span class="p">(</span><span class="nf">window:swap</span><span class="p">))</span>
</code></pre></div>

<p>I also changed my C functions to reflect a <em>NamespaceVerb</em> convention. I could have used <em>namespace::Verb</em> but the <a href="http://wiki.call-cc.org/eggref/5/bind">FFI that I use</a> to communicate with C cannot parse C namespaces. So instead of <em>Shader::Create</em>, I am left with <em>ShaderCreate</em>. This is unfortunate, but I'm fine with it since the lisp scripting side of the engine will be the most prominently used (Plus, <a href="https://www.raylib.com/examples.html">Raylib also uses this convention</a> for their functions).</p>
<p>I am happy that I was able to do these changes early. Because of this, readability of my code has increased, something I worried about when I first started implementing scripting.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="../following-lispy-conventions.html">Read on →</a> -->
      </article>
    </div>
  </div>
</div>
<div class="pagination">
<p class="paginator">
        <a href="../author/accidentalrebel.html">&#8647;</a>
        <a href="../author/accidentalrebel.html">&laquo;</a>
    Page 2 / 4
        <a href="../author/accidentalrebel3.html">&raquo;</a>
        <a href="../author/accidentalrebel4.html">&#8649;</a>
</p>
</div>
    <footer id="footer" class="her-row">
      <div class="container">
        <div class="row">
          <h4>Powered by <a href="http://blog.getpelican.com/">Pelican</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
        </div>
      </div>
    </footer>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55068085-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-55068085-2');
    </script>
  </body>
</html>