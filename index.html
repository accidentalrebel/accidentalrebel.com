<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>AccidentalRebel.com</title>
  <meta name="author" content="AccidentalRebel">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="canonical" href=".">

  <link href="./favicon.png" rel="icon">

  <link href="http://www.accidentalrebel.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="AccidentalRebel.com Full Atom Feed" />

  <link href="./theme/css/screen.css"  media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="./theme/css/tomorrow.css"  media="screen, projection" rel="stylesheet" type="text/css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>


</head>
  <body>

    <div class="container" id="site-title">
      <div class="col-md-8 col-md-offset-2">
	<h1>
	  <a href=".">
	    AccidentalRebel.com
	  </a>
	</h1>
	<div id="profile">
	  <div class="left">
	    <img src="./theme/images/pic.png" />
	  </div>
	  <div class="right">
	    My name is Karlo and I'm currently employed as a Cyber Security Engineer. I have an interest in threat hunting and malware analysis. I also work on cyber-security related programming projects like malware analysis tools and remote access tools.
	  </div>
	  <div class="clear"></div>
	</div>
	<div id="nav">
	  <ul>
	    <li><a href=".">Home</a></li>
	    <!-- <li><a href="./pages/made.html">My Works</a></li> -->
	    <li class="icon-nav" id="twitter-nav"><a href="https://twitter.com/accidentalrebel">Twitter</a></li>
	    <li class="icon-nav" id="github-nav"><a href="https://github.com/accidentalrebel">Github</a></li>
	    <li class="icon-nav" id="feed-nav"><a href="./feeds/all.atom.xml">RSS</a></li>
	  </ul>
	</div>
      </div>
    </div>

<div class="container">
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./cyber-corp-case-2-writeup-part-2.html">Cyber Corp Case 2 Writeup - Part 2</a></h1>
	<div class="meta">
          <time datetime="2021-10-30T12:00:00+08:00">October 30, 2021</time>
          in <span class="categories">
            <a href="./tag/threat-hunting.html">threat-hunting</a>,            <a href="./tag/cyberdefenders.html">cyberdefenders</a>          </span>
	</div>
        <p><p>The <a href="https://cyberdefenders.org/labs/75">second case of the CyberCorp challenge</a> on <a href="https://cyberdefenders.org/">CyberDefenders.org</a> is all about threat hunting. Created by <a href="https://twitter.com/BlackMatter23">@BlackMatter23</a> and his team, this challenge is based on a real-world attack so it is perfect for gaining practical experience on threat hunting.</p>
<p>This writeup is part 2 out of multiple parts. You could read <a href="threat-hunting-from-home-cyber-corp-wmi-persistence">Part 1 here</a>.</p>
<h2 id="checking-dns-requests">Checking DNS Requests</h2>
<blockquote>
<p>Question 6. Specify the domain name of the resource from which the files mentioned in question 5 were supposedly downloaded as a result of malicious code execution.</p>
</blockquote>
<p>This one is easy. Using the same daterange from the previous question, I changed the query to <code>event_type:DNSReq</code> (where "DNSReq" is short for "DNS Requests").</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-01" src="./images/cyber-corp-case-2-writeup-part-2-01.png" /></p>
<p>We could easily see a DNS record being queried, which is our answer to this question.</p>
<h2 id="finding-the-encoded-executable-code">Finding the encoded executable code</h2>
<blockquote>
<p>Question 7. The first file downloaded (as a result of executing the code in question 5) contained encoded executable code (PE), which after downloading was recorded in the registry. Specify an MD5 hash of the original representation of that code (PE).</p>
</blockquote>
<p>I changed the query to <code>registry</code> hoping to see what events it will give me. Surprisingly, the very first one seems to be what we need. </p>
<p><img alt="cyber-corp-case-2-writeup-part-2-02" src="./images/cyber-corp-case-2-writeup-part-2-02.png" /></p>
<p>Looking at this log I saw that it has a base64 encoded data under <code>reg_value_data</code> which is partially listed below:</p>
<blockquote>
<p>H4sIAAAAAAAEAO1YX0wcRRz+7XEUCuWOkhCJGl3IRiGpV...</p>
</blockquote>
<p>I sent this data to <a href="https://gchq.github.io/CyberChef">CyberChef</a> for decoding. Thankfully the <code>rule_name</code> field also informed me that the data is "gzipped", this allowed me to pick the correct recipes for decoding. The output is a malicious executable based on the <code>MZ</code> "magic-number" at the beginning of the file.</p>
<p>I downloaded the decoded data and then got the SHA256 hash of that file. This gave me the answer to the question.</p>
<h2 id="side-quest-investigating-the-malware">Side Quest: Investigating the malware</h2>
<p>I wanted to learn more about the malicious executable from the previous question so I decided to reverse engineer it, even though it was not part of the challenge.</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-03" src="./images/cyber-corp-case-2-writeup-part-2-03.png" /></p>
<p>Some interesting things about the file include the imported functions from kernel32 listed below:</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-04" src="./images/cyber-corp-case-2-writeup-part-2-04.png" /></p>
<p>And also a string for <code>rundll32.exe</code>. Looking for the usage of this string from within the code reveals this code segment:</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-06" src="./images/cyber-corp-case-2-writeup-part-2-06.png" /></p>
<p>Stepping through the code I was able to figure out that this executable is executing a process hollowing technique (<a href="https://attack.mitre.org/techniques/T1055/012/">T1055.012</a>). What it does is that it injects the code pointed to by <code>unk_180003000</code> into <code>rundll32.exe</code> and it would run that code instead of the original rundll32 code. You can find out more technical info about it <a href="https://airbus-cyber-security.com/following-process-hollowing-ollydbg/">here</a>. </p>
<p>And of course, a screenshot of the technique using my visualization tool <a href="https://github.com/accidentalrebel/vATTACK">vATT&amp;Ck</a>.</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-13" src="./images/cyber-corp-case-2-writeup-part-2-13.png" /></p>
<h2 id="the-second-downloaded-file">The second downloaded file</h2>
<blockquote>
<p>Question 8. The second file downloaded (as a result of code execution, which we talked about in question 5) was a script, that was set up to autostart via WMI Subscription. Specify the SHA256 hash of this script.</p>
</blockquote>
<p>I already knew of the script that is set to start via WMI subscription from a previous question, and that is <code>C:\\Users\\john.goldberg\\AppData\\Roaming\\Microsoft\\Office\\MSO1033.ps1</code>. So I immediately crafted my query to the one below:</p>
<blockquote>
<p>"MSO1033.ps1" AND event_type:FileCreate</p>
</blockquote>
<p>While the above query shows events where the <code>MSO1033.ps1</code> was being created. There was no associated hash in the logs. This forced me to look elsewhere by updating the query to:</p>
<blockquote>
<p>"MSO1033.ps1" AND (event_type:FileCreate OR event_type:FileOpen)</p>
</blockquote>
<p>And from here it showed me an event associated with <code>MSO1033.ps1</code> that also has a sha256 hash.</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-07" src="./images/cyber-corp-case-2-writeup-part-2-07.png" /></p>
<h2 id="the-most-difficult-question">The most difficult question</h2>
<blockquote>
<p>Question 9. The script, mentioned in question 8, spawned one of the legitimate system processes and injected into its memory a malicious code that was read and decoded from the registry (this code was mentioned in question 7). This malicious code migrated through a chain of code injections to the address space of another legitimate process, where it continued to run without further migration.
For this answer, provide the next data, separated by a comma without spaces:</p>
<ul>
<li>
<p>PID of the initial legitimate system process, which was spawned by the script and where this script launched in-memory execution of malicious code;</p>
</li>
<li>
<p>PID of the target process, to which malicious code migrated from the initial process and in the context of which attacker performed different post-exploitation activity</p>
</li>
</ul>
</blockquote>
<p>Out of all the questions in this challenge, this is the question that took me a long time to figure out. The question has a lot of threads of information that it is easy to fall into a trap of chasing a lead that doesn't go anywhere. </p>
<p>When all of my ideas were exhausted, I decided to give in and look for a hint. Thankfully, Vikas from the CyberDefender's Discord group shared one.</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-08" src="./images/cyber-corp-case-2-writeup-part-2-08.png" /></p>
<p>Initially the line "if you happen to see the PS script there are mentions of PID spoofing" did not immediately register with me, but after thinking about it some more I realized that it meant that the "PID spoofing" is written inside the script itself! This script is <code>MSO1033.ps1</code> which was part of the previous questions.</p>
<p>And so I updated my query with the one below:</p>
<blockquote>
<p>"MSO1033.ps1" AND event_type:ScriptExecution AND enrich.ioa.max_severity:*</p>
</blockquote>
<p>Which showed the following results:</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-09" src="./images/cyber-corp-case-2-writeup-part-2-09.png" /></p>
<p>The reason why the following events are interesting is that they contain the script inside the <code>script_text</code> value. Since the script is too long the events are split of into 7 events as indicated by the <code>[1 of 7]</code> in the description. I then copied all the <code>script_text</code> entries and placed them into one file so I can easily review the code.</p>
<p>The hint mentioned something about <code>pid spoofing</code> so I searched for the word <code>spoof</code> in the code and found this part right here.</p>
<div class="codehilite"><pre><span></span><code><span class="no">[int]</span><span class="nv">$ppid</span> <span class="p">=</span> <span class="nb">Get-Process</span> <span class="n">-Name</span> <span class="s2">&quot;winlogon&quot;</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-expand</span> <span class="n">ID</span>
<span class="nv">$spawnTo</span> <span class="p">=</span> <span class="s2">&quot;c:\Windows\System32\dwm.exe&quot;</span>
<span class="nv">$currdir</span> <span class="p">=</span> <span class="s2">&quot;c:\Windows\System32&quot;</span>
<span class="nv">$cmdline</span> <span class="p">=</span> <span class="s2">&quot;dwm.exe&quot;</span>
<span class="nv">$sInfo</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">StartupInfo</span>
<span class="nv">$sInfoEx</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">STARTUPINFOEX</span>
<span class="nv">$pInfo</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">PROCESS_INFORMATION</span>
<span class="nv">$SecAttr</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">SECURITY_ATTRIBUTES</span>
<span class="nv">$SecAttr</span><span class="p">.</span><span class="n">nLength</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">SizeOf</span><span class="p">(</span><span class="nv">$SecAttr</span><span class="p">)</span>
<span class="nv">$sInfo</span><span class="p">.</span><span class="n">cb</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">SizeOf</span><span class="p">(</span><span class="nv">$sInfoEx</span><span class="p">)</span>
<span class="nv">$lpSize</span> <span class="p">=</span> <span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span>
<span class="nv">$sInfoEx</span><span class="p">.</span><span class="n">StartupInfo</span> <span class="p">=</span> <span class="nv">$sInfo</span>
<span class="nv">$hSpoofParent</span> <span class="p">=</span> <span class="no">[Kernel32]</span><span class="p">::</span><span class="n">OpenProcess</span><span class="p">(</span><span class="n">0x1fffff</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$ppid</span><span class="p">)</span>
<span class="nv">$lpValue</span> <span class="p">=</span> <span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span>
<span class="nv">$lpValue</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">AllocHGlobal</span><span class="p">(</span><span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Size</span><span class="p">)</span>
<span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">WriteIntPtr</span><span class="p">(</span><span class="nv">$lpValue</span><span class="p">,</span> <span class="nv">$hSpoofParent</span><span class="p">)</span>
<span class="nv">$result1</span> <span class="p">=</span> <span class="no">[Kernel32]</span><span class="p">::</span><span class="n">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">,</span> <span class="n">1</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="no">[ref]</span><span class="nv">$lpSize</span><span class="p">)</span>
<span class="nv">$sInfoEx</span><span class="p">.</span><span class="n">lpAttributeList</span> <span class="p">=</span> <span class="no">[System.Runtime.InteropServices.Marshal]</span><span class="p">::</span><span class="n">AllocHGlobal</span><span class="p">(</span><span class="nv">$lpSize</span><span class="p">)</span>
<span class="nv">$result1</span> <span class="p">=</span> <span class="no">[Kernel32]</span><span class="p">::</span><span class="n">InitializeProcThreadAttributeList</span><span class="p">(</span><span class="nv">$sInfoEx</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> <span class="n">1</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="no">[ref]</span><span class="nv">$lpSize</span><span class="p">)</span>
<span class="nv">$result1</span> <span class="p">=</span> <span class="no">[Kernel32]</span><span class="p">::</span><span class="n">UpdateProcThreadAttribute</span><span class="p">(</span><span class="nv">$sInfoEx</span><span class="p">.</span><span class="n">lpAttributeList</span><span class="p">,</span> 
                                                 <span class="n">0</span><span class="p">,</span> 
                                                 <span class="n">0x00020000</span><span class="p">,</span>
                                                 <span class="nv">$lpValue</span><span class="p">,</span> 
                                                 <span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Size</span><span class="p">,</span> 
                                                 <span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">,</span> 
                                                 <span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">)</span> 
<span class="nv">$result1</span> <span class="p">=</span> <span class="no">[Kernel32]</span><span class="p">::</span><span class="n">CreateProcess</span><span class="p">(</span><span class="nv">$spawnTo</span><span class="p">,</span> 
                                     <span class="nv">$cmdline</span><span class="p">,</span> 
                                     <span class="no">[ref]</span><span class="nv">$SecAttr</span><span class="p">,</span> 
                                     <span class="no">[ref]</span><span class="nv">$SecAttr</span><span class="p">,</span> 
                                     <span class="n">0</span><span class="p">,</span>
                                     <span class="n">0x08080004</span><span class="p">,</span>
                                     <span class="no">[IntPtr]</span><span class="p">::</span><span class="n">Zero</span><span class="p">,</span> 
                                     <span class="nv">$currdir</span><span class="p">,</span> 
                                     <span class="no">[ref]</span> <span class="nv">$sInfoEx</span><span class="p">,</span> 
                                     <span class="no">[ref]</span> <span class="nv">$pInfo</span><span class="p">)</span>
</code></pre></div>

<p>Reading the code we could see a couple of interesting things:</p>
<ul>
<li>A call to <code>CreateProcess</code> function with a reference to <code>$spawnTo</code></li>
<li><code>$spawnTo</code> set to <code>c:\Windows\System32\dwm.exe</code></li>
<li>The line with <code>$hSpoofParent</code> using the variable <code>$ppid</code></li>
<li><code>$ppid</code> is set to a process with the name <code>winlogon</code></li>
</ul>
<p>My research on the above findings pointed me to the Parent PID Spoofing technique (<a href="https://attack.mitre.org/techniques/T1134/004/">T1134.004</a>). This is used for evading detection by spoofing the PID to a different process. What is happening in this case is that <code>dwm.exe</code> would now appear to be a child process of <code>winlogon.exe</code> instead of the powershell script. Brilliant!</p>
<p>Also, not shown in snippet above, the registry key for <code>AppXs42fd12c3po92dynnq2r142fs12qhvsmvv</code> is also read and decoded. This means that our executable file that contains the <code>rundll32.exe</code> string is also involved in this. Later on it will be revealed what this is for.</p>
<p>Now that we know what the script does, we can now search for any mention of <code>winlogon.exe</code> and <code>dwm.exe</code> using the query below:</p>
<blockquote>
<p>(winlogon.exe OR dwm.exe) AND enrich.ioa.max_severity:* AND event_type:ProcessCreate</p>
</blockquote>
<p>This, however, showed more than one result.</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-10" src="./images/cyber-corp-case-2-writeup-part-2-10.png" /></p>
<p>Which among these is the PID pair that the challenge author is looking for? </p>
<p>Looking at all the multiple events, it seems that the script has been executed multiple times so it's hard to determine which is the correct event. All of them executed successfully, but I found that only one of them was able create the <code>rundll32.exe</code> process.</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-12" src="./images/cyber-corp-case-2-writeup-part-2-12.png" /></p>
<p>The process id of the <code>dwm.exe</code> in the screenshot above shows <code>8876</code>. Using this information, we can go back to the previous query and find exactly which PID pairs that we need to answer the question.</p>
<h2 id="getting-the-malicious-ip">Getting the malicious IP</h2>
<blockquote>
<p>Question 10. The malicious code run by the script is a Reverse Shell. Identify the IP address and port number of its command center.</p>
</blockquote>
<p>Aha! So the malicious code that we inspected before, the one that does process hollowing, is now running inside <code>rundll32.exe</code> and is running as a reverse shell! </p>
<p>I already knew the process ID of our malicious <code>rundll32.exe</code> so we include that in our query: </p>
<blockquote>
<p>8344 AND event_type:NetworkConnection</p>
</blockquote>
<p>This will reveal an event with the process chain of <code>dwm.exe</code> &gt; <code>rundll32.exe</code> which also establishes a connection to an external IP. This is our answer to this question.</p>
<p><img alt="cyber-corp-case-2-writeup-part-2-11" src="./images/cyber-corp-case-2-writeup-part-2-11.png" /></p>
<h2 id="understanding-the-sequence-of-events">Understanding the sequence of events</h2>
<p>For the benefit of everyone (including me), I have outlined the timeline of events below to serve as reference just in case you get confused and overwhelmed:</p>
<ul>
<li>Jun 22, 2021 @ 07:25:47.000 - WMI Subscription</li>
<li>Jun 22, 2021 @ 07:41:15.000 - <code>MSO1033.ps1</code> (7324) was executed</li>
<li>Jun 22, 2021 @ 07:41:55.000 - <code>winlogon.exe</code> (1160) is now the spoofed parent process of <code>dwm.exe</code> (8876) instead of <code>MSO1033.ps1</code></li>
<li>Jun 22, 2021 @ 07:41:56.000 - <code>dwm.exe</code> (8876) creates the process <code>rundll32.exe</code> (8344), which is hollowed out and now runs as a reverse shell</li>
<li>Jun 22, 2021 @ 07:41:56.000 - <code>rundll32.exe</code> (8344) establishes connection to malicious IP</li>
</ul>
<hr />
<p>Hopefully, I was able to make everything clear. Expect the next part of this writeup very soon. </p>
<p>The next couple of questions deals with lateral movement and interactions with the domain controller so it would be very interesting to go through my findings in detail.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./cyber-corp-case-2-writeup-part-2.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./threat-hunting-from-home-cyber-corp-wmi-persistence.html">Cyber Corp Case 2 Writeup - Part 1</a></h1>
	<div class="meta">
          <time datetime="2021-10-30T12:00:00+08:00">October 30, 2021</time>
          in <span class="categories">
            <a href="./tag/threat-hunting.html">threat-hunting</a>,            <a href="./tag/cyberdefenders.html">cyberdefenders</a>          </span>
	</div>
        <p><p>The <a href="https://cyberdefenders.org/labs/75">second case of the CyberCorp challenge</a> on <a href="https://cyberdefenders.org/">CyberDefenders.org</a> is all about threat hunting. Created by <a href="https://twitter.com/BlackMatter23">@BlackMatter23</a> and his team, this challenge is based on a real-world attack so it is perfect for gaining practical experience on threat hunting.</p>
<p>This writeup is part one out of multiple parts as I will be detailing my thought process and the steps I took for each question.</p>
<p>Edit: <a href="cyber-corp-case-2-writeup-part-2">Part 2</a> is now out.</p>
<h2 id="understanding-wmi-persistence">Understanding WMI Persistence</h2>
<blockquote>
<p>Quesiton 1. The Threat Hunting process usually starts with the analyst making a hypothesis about a possible compromise vector or techniques used by an attacker. In this scenario, your initial hypothesis is as follows: "The attacker used the WMI subscription mechanism to obtain persistence within the infrastructure". Verify this hypothesis and find the name of the WMI Event Consumer used by the attacker to maintain his foothold.</p>
</blockquote>
<p>So the question tells us that the attacker used WMI subscription to gain persistence in our network.</p>
<p>The very first thing I did was to check the Mitre ATT&amp;CK wiki for information about this attack. My search led me to the "<a href="https://attack.mitre.org/techniques/T1546/003/">Event Triggered Execution: Windows Management Instrumentation Event Subscription</a>" with technique ID <code>T1546.003</code>. And, of course, I fired up <a href="https://github.com/accidentalrebel/vATTACK">my vATT&amp;CK tool</a> to better visualize the technique and it's related information.</p>
<p><img alt="cyber-corp-case-2-writeup-01" src="./images/cyber-corp-case-2-writeup-01.png" /></p>
<h2 id="testing-wmi-persistence-in-my-homelab">Testing WMI Persistence in my homelab</h2>
<p>Now that I understand the concept I then checked <a href="https://github.com/redcanaryco/atomic-red-team/blob/36d49de4c8b00bf36054294b4a1fcbab3917d7c5/atomics/T1546.003/T1546.003.md">the technique's entry</a> in the Atomic Red Team's repository of adversary emulation techniques. The nice thing about Atomic Red Team is that they have easy-to-follow step-by-step instructions on how to emulate Mitre ATT&amp;CK techniques.</p>
<p>I took the code on the page and ran it in <a href="building-my-virtual-cybersecurity-home-lab">my homelab</a>. I then fired up Windows Event Viewer and looked for entries with event log ID "5681 (WMI activity)". The entry that I found contains the information below:</p>
<div class="codehilite"><pre><span></span><code><span class="k">Namespace</span> <span class="o">=</span> <span class="o">//</span><span class="p">.</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">subscription</span><span class="err">;</span> <span class="n">Eventfilter</span> <span class="o">=</span> <span class="n">AtomicRedTeam</span><span class="o">-</span><span class="n">WMIPersistence</span><span class="o">-</span><span class="n">Example</span> <span class="p">(</span><span class="n">refer</span> <span class="k">to</span> <span class="n">its</span> <span class="n">activate</span> <span class="n">eventid</span><span class="p">:</span><span class="mi">5859</span><span class="p">)</span><span class="err">;</span> <span class="n">Consumer</span> <span class="o">=</span> <span class="n">CommandLineEventConsumer</span><span class="o">=</span><span class="s">&quot;AtomicRedTeam-WMIPersistence-Example&quot;</span><span class="err">;</span> <span class="n">PossibleCause</span> <span class="o">=</span> <span class="n">Binding</span> <span class="n">EventFilter</span><span class="p">:</span> 
<span class="n">instance</span> <span class="k">of</span> <span class="n">__EventFilter</span>
<span class="p">{</span>
    <span class="n">CreatorSID</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span><span class="err">;</span>
    <span class="n">EventNamespace</span> <span class="o">=</span> <span class="s">&quot;root\\CimV2&quot;</span><span class="err">;</span>
    <span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;AtomicRedTeam-WMIPersistence-Example&quot;</span><span class="err">;</span>
    <span class="n">Query</span> <span class="o">=</span> <span class="s">&quot;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39; AND TargetInstance.SystemUpTime &gt;= 240 AND TargetInstance.SystemUpTime &lt; 325&quot;</span><span class="err">;</span>
    <span class="n">QueryLanguage</span> <span class="o">=</span> <span class="s">&quot;WQL&quot;</span><span class="err">;</span>
<span class="p">}</span><span class="err">;</span>
<span class="n">Perm</span><span class="p">.</span> <span class="n">Consumer</span><span class="p">:</span> 
<span class="n">instance</span> <span class="k">of</span> <span class="n">CommandLineEventConsumer</span>
<span class="p">{</span>
    <span class="n">CommandLineTemplate</span> <span class="o">=</span> <span class="s">&quot;C:\\Windows\\System32\\notepad.exe&quot;</span><span class="err">;</span>
    <span class="n">CreatorSID</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span><span class="err">;</span>
    <span class="n">Name</span> <span class="o">=</span> <span class="s">&quot;AtomicRedTeam-WMIPersistence-Example&quot;</span><span class="err">;</span>
<span class="p">}</span><span class="err">;</span>
</code></pre></div>

<p>Since I have Sysmon logging enabled, I also double checked the logs using the Sysmon event ID's below:</p>
<ul>
<li>Event ID 19: WmiEvent (WmiEventFilter activity detected)</li>
<li>Event ID 20: WmiEvent (WmiEventConsumer activity detected)</li>
<li>Event ID 21: WmiEvent (WmiEventConsumerToFilter activity</li>
</ul>
<p><img alt="cyber-corp-case-2-writeup-02" src="./images/cyber-corp-case-2-writeup-02.png" /></p>
<p>As we can see, Sysmon separates the WMIEvents into the different types of WmiEvent activities.</p>
<h2 id="building-the-query-for-the-kibana-search">Building the Query for the Kibana search</h2>
<p>Now that I know what the important IOCs are, I could now create the query to answer the first question of the challenge.</p>
<ul>
<li>5861</li>
<li>("QueryLanguage = " AND "Consumer = ")</li>
</ul>
<p>When the above information are combined, I get the query <code>5861 OR ("QueryLanguage = " AND "Consumer = ")</code>. Putting this in the Kibana search shows us the one and only entry:</p>
<p><img alt="cyber-corp-case-2-writeup-03" src="./images/cyber-corp-case-2-writeup-03.png" /></p>
<p>From there we could easily see the name of the WMI Event Consumer.</p>
<h2 id="looking-for-the-wmi-subscriber">Looking for the WMI subscriber</h2>
<blockquote>
<p>Question 2. In the previous step, you looked for traces of the attacker's persistence in the compromised system through a WMI subscription mechanism. Now find the process that installed the WMI subscription. Answer the question by specifying the PID of that process and the name of its executable file, separated by a comma without spaces.</p>
</blockquote>
<p>Reading the question above, I knew that I needed to look for a process that has happened prior to the WMI subscription. And so, I've set the date range to reflect this.</p>
<p><img alt="cyber-corp-case-2-writeup-04" src="./images/cyber-corp-case-2-writeup-04.png" /></p>
<p>I wasn't so sure what to look for next so I just looked out for anything suspicious. Thankfully there is the <code>enrich.ioa.*</code> set of fields where enrichment is done that indicate suspiciousness. I've set a filter to show entries that have <code>enrich.ioa.max_severity</code> to <code>exists</code>. This means it'll only show events that are either <code>high</code>, <code>medium</code>, or <code>low</code>.</p>
<p>These showed some very interesting events:</p>
<p><img alt="cyber-corp-case-2-writeup-05" src="./images/cyber-corp-case-2-writeup-05.png" /></p>
<p>It seems like <code>winword.exe</code> is connecting to an external IP. Very suspicious. Searching the IP <code>188.135.15.49</code> on VirusTotal reveals that it is indeed malicious.</p>
<p><img alt="cyber-corp-case-2-writeup-06" src="./images/cyber-corp-case-2-writeup-06.png" /></p>
<p>If we look at more of the events we will find that there are a lot of malicious activity with the <code>proc_cmdline</code> that contains the value:</p>
<blockquote>
<p>"C:\Program Files (x86)\Microsoft Office\Office16\WINWORD.EXE" /n "C:!Work\Marketing\Docs\OPEC\OPEC crude oil production.docx" /o ""</p>
</blockquote>
<p>Having seen all of that we can now safely assume that this is the process that we are looking for. Entering the <code>proc_id</code> along with the proc's file name satisfies question number 2.</p>
<h2 id="looking-for-the-extracted-archive">Looking for the extracted archive</h2>
<blockquote>
<p>Question 3. The process described in the previous question was used to open a file extracted from the archive that user received by email. Specify a SHA256 hash of the file extracted and opened from the archive.</p>
</blockquote>
<p>The question said something about a file being opened, and so I added the filters <code>event_type: FileOpen</code> and <code>proc_file_path: C:\Program Files (x86)\Microsoft Office\Office16\WINWORD.EXE</code> to see what files were opened using Word.exe prior to the WMI subscription. This however showed a lot of files.</p>
<p><img alt="cyber-corp-case-2-writeup-07" src="./images/cyber-corp-case-2-writeup-07.png" /></p>
<p>The question also mentioned that the opened file was extracted from an archive received by email. So I added the query <code>*zip* OR *rar*</code> to find outif there are any "zip" or "rar" files that were processed.</p>
<p>Sure enough, there was, and one particular really stood out. </p>
<blockquote>
<p>Process 'c:\program files (x86)\microsoft office\office16\outlook.exe' created file 'c:\users\john.goldberg\appdata\local\microsoft\windows\inetcache\content.outlook\dfn3sfep\report.zip'</p>
</blockquote>
<p>This tells us that the archive <code>report.zip</code> was opened via email using the program <code>outlook.exe</code>.</p>
<p>But what was the generated file when the archive was opened? Looking through the results we could also see one entry that had the <code>enrich.chain</code> with the value of: </p>
<blockquote>
<p>'c:\windows\explorer.exe' ➔ 'c:\program files (x86)\microsoft office\office16\winword.exe' ➔ 'c:\users\john.goldberg\appdata\local\temp\temp1_report.zip\market forecast emea.docx'`. </p>
</blockquote>
<p>"Market forecaste emea.docx" was opened via "winword.exe" and we could also see that the temporary folder for it is <code>temp1_report.zip</code>. Entering the hash for this "docx" file was the correct answer for this question.</p>
<h2 id="finding-the-actual-malicious-file">Finding the actual malicious file</h2>
<blockquote>
<p>Question 4. The file mentioned in question 3, is not malicious in and of itself, but when it is opened, another file is downloaded from the Internet that already contains the malicious code. Answer the question by specifying the address, from which this file was downloaded, and the SHA256 hash of the downloaded file, separated by commas without spaces.</p>
</blockquote>
<p>If we think about it, we can make the date range smaller by starting our range from when the Zip is extracted and from when the WMI subscription happened. </p>
<p><img alt="cyber-corp-case-2-writeup-08" src="./images/cyber-corp-case-2-writeup-08.png" /></p>
<p>There are three "action" keywords specified in the question that I knew I could filter for. This led me to using the query below:</p>
<blockquote>
<p>event_type:NetworkConnection OR event_type:FileOpen OR event_type:FileCreate</p>
</blockquote>
<p>What I'm looking for is an event where there is a "NetworkConnection" and a "FileCreate" event (these two signifies another file is downlaoded from the internet), the "FileOpen" is when the file has been opened and therefore triggered the WMI subscription.</p>
<p>As you can see in the image below, we have a series of events that shows us the three events that we are looking for in the previous paragraph. But because their timestamps are the same, they are all jumbled.</p>
<p><img alt="cyber-corp-case-2-writeup-09" src="./images/cyber-corp-case-2-writeup-09.png" /></p>
<p>The way to see if the events happened in the order that we want (Network Connection &gt; FileCreate &gt; FileOpen), then what we can do is to view the surrounding documents on one of the events and see from there. From the image below, we see that the ordering of the events is indeed correct.</p>
<p><img alt="cyber-corp-case-2-writeup-10" src="./images/cyber-corp-case-2-writeup-10.png" /></p>
<p>The above tells us two of the answers that we need to answer the 4th question. The IP on the network connection and the hash of the file that was opened.</p>
<h2 id="finding-the-tricky-technique">Finding the tricky technique</h2>
<blockquote>
<p>Question 5. The malicious code from the file, mentioned in question 4, directly installed a WMI subscription, which we started our hunting with, and also downloaded several files from the Internet to the compromised host. For file downloading, the attacker used a tricky technique that gave him the opportunity to hide the real process, which initiated the corresponding network activity. Specify the SHA256 hash of the operating system component whose functionality was used by the attacker to download files from the Internet.</p>
</blockquote>
<p>So the event that the question is looking for happened after the WMI subscription. I've updated the date range to reflect this.</p>
<p><img alt="cyber-corp-case-2-writeup-part-1-11" src="./images/cyber-corp-case-2-writeup-part-1-11.png" /></p>
<p>Initially, I tried doing the same approach as I did before where I would pick up certain "action" keywords from the question. Something similar to the query below:</p>
<blockquote>
<p>(event_type:NetworkConnection OR event_type:FileCreate) AND enrich.ioa.max_severity:*</p>
</blockquote>
<p>Sadly, no matter where I looked it doesn't seem to be what the question is looking for.</p>
<p>And so, I had to start my search from scratch but this time only focusing on any entries after the WMI subscription that have an existing value in <code>enrich.ioa.max_severity</code>. This approach worked and it showed me this very interesting entry marked as <code>win_unusual_ie_com_dll_host_process</code>.</p>
<p><img alt="cyber-corp-case-2-writeup-part-1-12" src="./images/cyber-corp-case-2-writeup-part-1-12.png" /></p>
<p>So apparently, "winword.exe" loaded the library "iexproxy.dll", which allowed it to use "iexplore.exe" in downloading several files from the internet. This technique is unfamiliar to me and researching about it only showed <a href="https://cyberpolygon.com/materials/hunting-for-advanced-tactics-techniques-and-procedures-ttps/">an article from Cyber Polygon</a>. I'll try to explore this in the future, but at least for now. I have the answer to the question.</p>
<hr />
<p>This is part 1 for my writeup for this challenge. Expect the next part which would have the answer to question that a lot of people have difficulty answering, which is #9. Until then!</p>
<p>Edit: <a href="cyber-corp-case-2-writeup-part-2">Part 2</a> is now out.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./threat-hunting-from-home-cyber-corp-wmi-persistence.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./new-tool-preview-vattack.html">New Tool Preview: vATT&CK</a></h1>
	<div class="meta">
          <time datetime="2021-10-18T20:33:00+08:00">October 18, 2021</time>
          in <span class="categories">
            <a href="./tag/tools.html">tools</a>,            <a href="./tag/cybersecurity.html">cybersecurity</a>          </span>
	</div>
        <p><p>I have released a new cybersecurity-related tool called <a href="https://github.com/accidentalrebel/vATTACK">vATT&amp;CK (Visual ATT&amp;CK)</a>. It is a relationship visualizer for the Mitre ATT&amp;CK framework.</p>
<p><img alt="new-tool-preview-vattack-01" src="./images/new-tool-preview-vattack-01.png" /></p>
<p>What the tool does is that it makes a visual map of the searched technique and all the related information. You can watch a video of the tool in action <a href="https://www.youtube.com/watch?v=xCc7aAqbSNI">here</a>.</p>
<p>Each node will be colored depending on it's category. The color legends is as follows:</p>
<ul>
<li>Pink - Related subtechniques</li>
<li>Orange - Malware that uses the searched technique</li>
<li>Red - Groups that uses the searched technique</li>
<li>Blue - Tools that use the searched technique</li>
<li>Yellow - Mitigations</li>
</ul>
<p>This tool is still in development. I plan to add a number of improvements such as:</p>
<ul>
<li>Ability to click on nodes and then update the visual map</li>
<li>Ability to search not just by technique, but also by other categories</li>
</ul>
<p>I also plan on releasing a live demo of the tool very soon in the hopes of getting feedback from the community. </p>
<p>For now, if you are interested in the project, you could visit the <a href="https://github.com/accidentalrebel/vATTACK">tool's Github project page</a> or contact me for any comments or suggestions.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./new-tool-preview-vattack.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./ioli-crackme-0x04.html">IOLI Crackme 0x04</a></h1>
	<div class="meta">
          <time datetime="2021-09-29T10:34:00+08:00">September 29, 2021</time>
          in <span class="categories">
            <a href="./tag/re.html">re</a>,            <a href="./tag/crackme.html">crackme</a>          </span>
	</div>
        <p><p>I am continuing my reverse engineering review by tackling the <em>IOLI crackmes</em> by <a href="https://twitter.com/pof">@pof</a>. These are beginner friendly challenges that is perfect for newbies or for those who want to review the basics like me. Check out my writeups for <a href="./ioli-crackme-0x00.html">0x00</a>, <a href="./ioli-crackme-0x01.html">0x01</a>, <a href="./ioli-crackme-0x02.html">0x02</a>, and <a href="./ioli-crackme-0x03.html">0x03</a>.</p>
<h1 id="getting-the-password">Getting the password</h1>
<p>Loading the program in IDA revealed something new. There is now a <code>_check</code> function that when opened looks more complicated than the previous challenges.</p>
<p><img alt="ioli-crackme-0x04-01" src="./images/ioli-crackme-0x04-01.png" /></p>
<p>The one thing that I immediately noticed is the call to the <code>_strlen</code> function similar to the previous challenge. This means that the length of the input string plays another important role.</p>
<p>One curious thing is the condition that leads to the "Password Incorrect" block, as shown below.</p>
<p><img alt="ioli-crackme-0x04-02" src="./images/ioli-crackme-0x04-02.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="nf">call</span> <span class="no">_strlen</span>
<span class="nf">cmp</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_C</span><span class="p">],</span> <span class="no">eax</span>
<span class="nf">jnb</span> <span class="no">short</span> <span class="no">loc_401387</span>
</code></pre></div>

<p>From the looks of it, the check will fail if <code>var_C</code> (Which is our <code>var_counter</code> from the previous challenge) reaches the length of the entered string. If you think about it, this means that it doesn't matter how long the string that the user inputs. What's important is the content.</p>
<p>To find out what the correct content the program expects, we need to look at the other block of code.</p>
<p><img alt="ioli-crackme-0x04-03" src="./images/ioli-crackme-0x04-03.png" /></p>
<p>The code uses the same approach as the previous challenge where <code>var_counter</code> is used to loop through individual characters in the input string.</p>
<p>The part that is new is the use of the <code>_sscanf</code> function which is defined as:</p>
<blockquote>
<p>"sscanf reads data from s and stores them according to parameter format into the locations given by the additional arguments, as if scanf was used, but reading from s instead of the standard input (stdin)."</p>
</blockquote>
<p>Looking at how the function <code>_sscanf</code> is used, it gets each character in the input string and converts them to decimal integers. This means that the password can only contain the numbers <em>0 through 9</em>. The reason for this is because the result is added to another value at the line <code>add [eax], edx</code>.</p>
<p>This <em>"other value"</em> is the converted integer value from previous loops. This means that the algorithm adds each number from the input string after every loop. For example, an input string of <code>123</code> translates to <code>1+2+3</code> where the computed sum is saved to <code>var_8</code>.</p>
<p>Finally, there is the line <code>cmp [ebp+var_8], 0Fh</code>, which tells us that the program expects the computed sum to be equal to <code>0Fh</code> or <code>15</code>. So as long as we enter numbers that would equal to <code>15</code> when combined, then we are good.</p>
<p><img alt="ioli-crackme-0x04-" src="./images/ioli-crackme-0x04-.png" /></p>
<h1 id="patching-the-executables">Patching the executables</h1>
<p>Patching the executable is different this time around. If on previous challenges we patched the program by changing an conditional opcode to a jmp (<code>74</code> to <code>EB</code>), for this one we only need to change the conditional to a <code>no op</code> instruction (<code>00</code>).</p>
<p><img alt="ioli-crackme-0x04-05" src="./images/ioli-crackme-0x04-05.png" /></p>
<p>As you can see, the line <code>cmp [ebp+var_8]</code> and the conditional branch disappears allowing us to go directly to the <em>"Password OK"</em> part of the code.</p>
<p><img alt="ioli-crackme-0x04-06" src="./images/ioli-crackme-0x04-06.png" /></p>
<h1 id="on-to-the-next-challenge">On to the next challenge...</h1>
<p>I liked this challenge mostly because it changed the passwords the program expects. The first time I tackled this challenge I used purely static analysis. I thought I got the answer only to realize that I was wrong by debugging the code. We have 5 more challenges to go!</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./ioli-crackme-0x04.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./building-my-virtual-cybersecurity-home-lab.html">Building my Virtual Cybersecurity Home Lab</a></h1>
	<div class="meta">
          <time datetime="2021-09-05T20:33:00+08:00">September 05, 2021</time>
          in <span class="categories">
            <a href="./tag/malware.html">malware</a>,            <a href="./tag/dev.html">dev</a>          </span>
	</div>
        <p><p>I have recently realized that one part of cybersecurity that I am lacking basic knowledge on is networking. I honestly did not think it was important when I was starting. It was the reason why I skipped Network+ so I could take Security+ directly. </p>
<p>Now I know better.</p>
<p>Ever since my realization, I have taken steps to patch the holes in my knowledge. I've started taking courses and bought books. But one thing that has made the most impact is me building my very own "homelab".</p>
<p>I first came to know of the concept of homelabs <a href="https://www.reddit.com/r/homelab/">from Reddit</a>. To those unfamiliar, it is the practice of building a networked environment to gain practical knowledge in networking and IT. One way to do this is by making a virtual network.</p>
<p>And so, over the past month, I have been building my very own virtual homelab with a focus on integrating cybersecurity products.</p>
<h1 id="the-lab">The Lab</h1>
<p>The network diagram below shows the current implementation of my lab. I will be discussing each part to give an idea of their purpose (<a href="./images/building-my-virtual-cybersecurity-home-lab-00.png">Click here for a bigger version</a>).</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-01" src="./images/building-my-virtual-cybersecurity-home-lab-01.png" /></p>
<p>At the heart of the network is a firewall running <a href="https://www.pfsense.org/">pfSense</a>. Its purpose is to ensure that each sub-network is separated and protected, and also to protect my virtual host from any malware outbreaks. This machine also serves as a DHCP and NTP server to all the machines in the network.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-13" src="./images/building-my-virtual-cybersecurity-home-lab-13.png" /></p>
<h1 id="the-target-network">The Target Network</h1>
<p>On the right side of the diagram is the "Target" network where workstations and vulnerable servers reside. These are the machines that I use to attack with exploits and malware.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-02" src="./images/building-my-virtual-cybersecurity-home-lab-02.png" /></p>
<p>I have Metasploitable 2 and Metasploitable 3 machines that have various services turned on to play around with. I can learn about specific attacks by exploiting this machine, but I can also don my defenders hat and learn about how to secure them.</p>
<p>The Windows and Linux machines will serve as typical workstations for various experiments.</p>
<p>One of the perks of my job is that I get to play with different cybersecurity solutions. I currently have access to a few that I am able to use on my lab for testing.</p>
<p>One solution that I am using right now is an EDR (Endpoint Detection and Response) (Sorry, I can't reveal which). Each machine has an EDR agent deployed which monitors for any malicious activities on the host. It has an anti-virus feature, anti-ransomware, and fileless attack monitoring. It's awesome stuff but I have yet to maximize this.</p>
<p>An IDS (intrusion Detection System) running <a href="https://www.snort.org/">Snort</a> monitors the traffic for any malicious activity. Signatures are constantly updated to ensure that I can detect the latest types of attack. If it finds anything important, it then sends an alert to a SIEM (running <a href="https://www.splunk.com/">Splunk</a>) on the Management network.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-11" src="./images/building-my-virtual-cybersecurity-home-lab-11.png" /></p>
<h1 id="the-management-network">The Management Network</h1>
<p>On the left side of the diagram is the Managemnet network. This is where the management part of the EDR, IDS, and the SIEM can be accessed from my virtual host.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-03" src="./images/building-my-virtual-cybersecurity-home-lab-03.png" /></p>
<p>There's nothing special about this network, I do want to note though that I find it interesting the Snort IDS has two interfaces. One is used for access to the management page, and the other is for sniffing traffic on the Attacker network.</p>
<h1 id="the-operations-network">The Operations Network</h1>
<p>At the bottom side of the diagram is the "Operations" network.</p>
<p>A machine running Kali is placed here. I can launch attacks from this machine towards the vulnerable machines on the Target network. This machine also has OpenVAS scanner that helps in discovering vulnerabilities on the target machines.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-04" src="./images/building-my-virtual-cybersecurity-home-lab-04.png" /></p>
<p>A windows machine serves as my malware analysis lab. It contains a lot of malware analysis tools to aid with investigations. </p>
<p>This machine is then connected to a <a href="https://remnux.org/">Remnux</a> Linux machine. All traffic from the Windows machine is port forwarded by Remnux. From here I can run Wireshark to inspect the traffic coming from the Windows malware lab and it can also spoof the network responses to influence the behavior of malware. If the Remnux machine is turned off, then the Windows machine is effectively cut off from the whole network. It's a really neat setup that <a href="https://www.ariefprabowo.com/en/malware-analysis-en/personal-notes-building-a-malware-analysis-lab-environment/">I learned here</a>.</p>
<h1 id="the-present">The Present</h1>
<p>While the main intent of the network is to learn networking and implementing cybersecurity products, I can also investigate malware and learn about exploits by launching attacks. So it has a lot of multiple uses, which is perfect for someone like me who gets interested in different aspects of cybersecurity.</p>
<p>My host machine currently has 32GB, 8 cores, and a total of 1.75TB which may seem a lot but is not powerful enough for all the machines to run at the same time. As a workaround, I just open the machines that I need for a particular exercise.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-05" src="./images/building-my-virtual-cybersecurity-home-lab-05.png" /></p>
<p>For example, if I want to investigate malware then I only need the firewall, Remnux, and the windows malware lab open. But if I want to attack and run an exploit, while making sure that it gets detected, then I need the firewall, EDR, IPS, SIEM, Kali, and the target machine to be open at the same time. This easily consumes around 20GB+!</p>
<h1 id="the-future">The Future</h1>
<p>Working on this homelab has taught me a lot of practical knowledge. It helped solidify a lot of networking concepts I've learned througout the years.</p>
<p>I'm not stopping here though. I also plan to upgrade the Target network so it would better resemble an enterprise network. For example, setting up an active directory, an internal DNS server, and maybe even a mail server (why not?). This is so I could play around in detecting and remediating more varied enterprise-level scenarios.</p>
<p>I am also hoping I could get access to more cybersecurity products so I could play around with them. A SOAR (Security Orchestration and Response) would be a nice addition that would work really well.</p>
<p>But, of course, before I could do any of the above I first need to upgrade my RAM and add more cores!</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./building-my-virtual-cybersecurity-home-lab.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./making-a-rat.html">Making a RAT</a></h1>
	<div class="meta">
          <time datetime="2021-07-13T14:56:00+08:00">July 13, 2021</time>
          in <span class="categories">
            <a href="./tag/malware.html">malware</a>,            <a href="./tag/dev.html">dev</a>          </span>
	</div>
        <p><p>A Remote Access Tool (RAT) is used to remotely access a computer. It has legitimate uses but it can also be used for malicious purposes. I've seen it used in malware I've analyzed and I've always been curious as to how it works.</p>
<p>I was following along the <a href="https://handmadehero.org/">Handmade Hero project</a> <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> when the topic about dynamic DLL loading came up. This is a process of dynamically loading a DLL at runtime which is useful if you want your program to check if a DLL is present in a system before loading it.</p>
<p>Two of the system calls that were discussed were LoadLibrary and GetProcAddress. These were familiar to me as I've seen them used on malware shellcode I analyzed in the past. I later learned that this is also used as an anti-virus evasion technique. I found this interesting.</p>
<p>Having learned how to do runtime DLL loading myself I decided to give it a try. And of course, a RAT is perfect for this.</p>
<p><img alt="making-a-rat-01" src="./images/making-a-rat-01.png" /></p>
<h2 id="planning-the-ratchitecture">Planning the RATchitecture</h2>
<p>A lot of famous RATs are packed with features like the ability to log keystrokes, take screenshots, and turn on a webcam. I just want mine to be simple and have basic functionality like:</p>
<ul>
<li>Execute command line commands remotely</li>
<li>Download a file to the client</li>
<li>Exfiltrate data via file upload</li>
</ul>
<p>You can already do a lot of things even with the above basic functions. You can download a payload to the client, run it via remote command and then upload the results. You can even update the RAT itself using the same process!</p>
<p>As an extra, I also wanted it to be stealthy. I am aware however that this is something that is not easily done. There are myriads of security defenses and I don't think I have the time and energy to have my RAT to be up-to-date with the latest evasion techniques. Having basic anti-debugging and anti-sandbox checks is enough for me.</p>
<p>I've never made a RAT before but thankfully there are a lot of great resources online that helped me a lot:</p>
<ul>
<li><a href="https://github.com/quantumcore/paradoxiaRAT">ParadoxiaRat</a> is my main resource and has done a lot of the features I wanted to implement.</li>
<li><a href="https://github.com/yatt-ze/The-Collection/tree/master/Source%20Codes/Botnets/DarkRat%20Loader/derkrut">DarkRAT</a> is a leaked source code that gave me an idea of how a RAT used in the wild looks like</li>
<li><a href="https://github.com/vxunderground/WinAPI-Tricks">VXUnderground's WinAPI tricks</a> taught me that there are alternative ways to do certain things to avoid detection</li>
</ul>
<p>As for the name of the project, I decided on "RATwurst" after the german sausage, Bratwurst. Don't ask me why. I just thought it's funny that it had the letters RAT in it.</p>
<p><img alt="making-a-rat-02" src="./images/making-a-rat-02.png" /></p>
<h2 id="the-nitty-gratty-details">The nitty gRATty details</h2>
<p>The client is written in ANSI C because it's the language I prefer. Since I am only targeting Windows I chose MSVC for the compiler. Which is great because it allows me to use Visual Studio for debugging.</p>
<p>The server, on the other hand, is written in Python because I wanted another excuse to practice with it. Choosing Python has been a good choice though because of the excellent low level <a href="https://docs.python.org/3/library/socket.html">socket</a> and <a href="https://docs.python.org/3/library/cmd.html">cmd</a> libraries.</p>
<p>Sockets are used for communication between client and server. I've applied basic XOR obfuscation to the data to mask the traffic. The client and server can handle sending of strings and even executables over the network.</p>
<p>When RATwurst is first executed. It does some anti-sandbox checks via process enumeration. It checks if there are more than 15 processe that are running and if there are virtualization tools present like <code>vmware.exe</code>. It will also setup an auto-run registry entry for persistence. And also move the executable to Windows' temp folder and re-run it from there.</p>
<p>Anti-debbuging checks are littered throughout the code which checks the amount of time it takes to reach from one part of the code to the next. This is used to detect if someone is stepping through the code, increasing the delay between code execution.</p>
<p>When no shenanigans is detected then it'll proceed to work as intended. </p>
<p><img alt="making-a-rat-02" src="./images/making-a-rat-02.png" /></p>
<h2 id="for-edurational-purposes-only">For eduRATional purposes only</h2>
<p>I've made the source of my project <a href="https://github.com/accidentalrebel/ratwurst">available on Github</a>. The aim is to share what I've learned so that others can learn too.</p>
<p>I am aware of news of RAT authors having been arrested because of their work. They actively sought to gain money from their creation, I, of course, have no such plans.</p>
<p>To make sure that I save myself from any legal problems, I've placed a disclaimer that I am not responsible for any misuse. While I am skeptical that a piece of text would prevent any legal action towards me, I do see other projects having their own disclaimers so I decided to do the same.</p>
<p>I've also submitted my creation to a multi-scanner service like VirusTotal. This would help distribute my RATs signature to anti-virus companies so it can easily be detected when used in the wild.<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
<h2 id="a-ratisfying-learning-experience">A RATisfying learning experience</h2>
<p>Making this project has been a lot of fun. </p>
<p>The most useful thing that I learned is the client and server communication via sockets. I've dabbled with it before but only in this project have I actually sent actual data back and forth.</p>
<p>I am also happy that I got to use more Windows APIs. It's fun to play around with what's available and it is opening my mind as to what other things I can make in the future.</p>
<p>And of course, this project has given me a good insight into the techniques used by malware. Learning about them is not enough until you've built one yourself.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Handmade here is a project by Casey Muratori where a game is created from scratch live on stream, has been going on for 6+ years, it's awesome&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Multi-scanners help to easily distribute virus signatures to security services. An opposite to this are "no-distribute" sacnners. More info about this <a href="https://www.bleepingcomputer.com/news/security/75-percent-of-malware-uploaded-on-no-distribute-scanners-is-unknown-to-researchers/">here</a>.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./making-a-rat.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./finding-phished-passwords-on-a-scam-site.html">Finding phished passwords on a scam site</a></h1>
	<div class="meta">
          <time datetime="2021-05-01T20:56:00+08:00">May 01, 2021</time>
          in <span class="categories">
            <a href="./tag/phishing.html">phishing</a>          </span>
	</div>
        <p><p>Since my last post about <a href="investigating-an-fb-phishing-site">my investigations of a Facebook phishing site</a>, I have received several messages from friends asking me to check out other suspected phishing/scam sites. One of the most alarming out of them was this one where I was able to find the file where the scammer stores the phished usernames and passwords.</p>
<p><img alt="finding-phished-passwords-from-a-scam-site-01" src="./images/finding-phished-passwords-from-a-scam-site-01.png" /></p>
<p>This particular phishing site conducts its operations like this:</p>
<ul>
<li>An ad is shown on Facebook, promising free coupons for famous fast food restaurants</li>
<li>Clicking on the ad takes the user to a fake Facebook login page hosted on <em>blogger.com</em></li>
<li>Login page then sends phished username and passwords to a PHP file hosted on <em>000webhost</em></li>
</ul>
<p>The phished passwords are then stored in a <code>.txt</code> file (blatantly named, <code>victims.txt</code>), which is publicly accessible on an open directory. Getting to this directory involved following the scripts and the URLs used by the scammers. It's not that hard to find as long as you know where to look.</p>
<p>What's scary is that the size of this text file kept on getting bigger. I knew I had to act quickly.</p>
<h2 id="stopping-the-scammers">Stopping the scammers</h2>
<p>Unfortunately, with phishing sites like these, there's not much we could do but report it to the relevant hosting providers. The problem is that sometimes it may take some time before the site gets reviewed, which is excruciating because the longer the wait, the more people fall victim. Some might even just ignore your report altogether!</p>
<p>I reported the fake login page to Blogger.com and did not receive any response at all. I understand that Blogger.com is a big platform and I bet they receive numerous reports like this. I guess this is why the scammer used this platform as they know they won't be taken down too quickly. Their profile even listed two sites that both had fake login pages. </p>
<p><img alt="finding-phished-passwords-from-a-scam-site-04" src="./images/finding-phished-passwords-from-a-scam-site-04.png" /></p>
<p>Thankfully, <em>000webhost</em> got back to me and eventually took down the page that hosted the PHP and text files.</p>
<p><img alt="finding-phished-passwords-from-a-scam-site-03" src="./images/finding-phished-passwords-from-a-scam-site-03.png" /></p>
<p>You'd think that this is a victory. But sadly, setting up a new phishing site is rather easy so within a few hours there is already a new one. Of course, I reported this new site too. Only for a new one to pop up later...</p>
<p>You can see how this can become an endless cat and mouse game.</p>
<h2 id="stopping-from-other-sources">Stopping from other sources</h2>
<p>One way that could be effective to stop the scammer's operations is by reporting the Facebook advertisement that is used to lure users to the phishing site. Unfortunately, my friend who shared this with me did not get a chance to snap a screenshot of the ad. If he did then it would probably have more impact on stopping their operations. Maybe the Facebook abuse team can trace the payment details used to pay for the ad, and maybe block it. </p>
<p><img alt="finding-phished-passwords-from-a-scam-site-02" src="./images/finding-phished-passwords-from-a-scam-site-02.png" /></p>
<p>If you know anyone who may have seen a Facebook advertisement that offers free coupon codes for fast food restaurants that might be pointing to a suspicious login page, then please do contact me!</p>
<h2 id="awareness-is-the-key">Awareness is the key</h2>
<p>As of this posting, the landing page is still up while the page that hosts the PHP and victims file is down. I'm sure it'll be back up soon. All I was able to do was delay their operations. A minor inconvenience for them.</p>
<p><img alt="finding-phished-passwords-from-a-scam-site-05" src="./images/finding-phished-passwords-from-a-scam-site-05.png" /></p>
<p>This is why out of everything, spreading awareness is the best countermeasure. If people are more aware of phishing sites and how to avoid them then that would greatly diminish their impact. This is why I continue to post and write about phishing sites. Seeing the number of victims rising like that made me act knowing that I at least have the power to prevent things from escalating.</p>
<p>And you have the power too, dear reader. Educate your family and friends by warning them or by showing them my posts. Remember, awareness is our best defense!</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./finding-phished-passwords-on-a-scam-site.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./emprisa-maldoc-writeup..html">Emprisa Maldoc Writeup</a></h1>
	<div class="meta">
          <time datetime="2021-04-30T05:58:00+08:00">April 30, 2021</time>
          in <span class="categories">
            <a href="./tag/writeup.html">writeup</a>          </span>
	</div>
        <p><blockquote>
<p>This is a writeup for <a href="the-emprisa-maldoc-challenge">Emprisa maldoc challenge</a> that I made for <a href="https://cyberdefenders.org/">CyberDefenders.org</a>. You can play it <a href="https://cyberdefenders.org/labs/56">here</a>.</p>
</blockquote>
<p>The very first thing that I do when confronted with a malicious document is to run it in a malware lab. This particular document, however, would not exhibit anything malicious on recent versions of Word.</p>
<p>A quick search of the hash on malware sandboxes would reveal that the document makes use of the <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-18822">CVE-2017-18822 vulnerability</a>. This is a vulnerability that became known and was promptly patched around November of 2017.</p>
<p>The above details give us a hint on how to trigger the document, which is to run the maldoc on a version of Microsoft Word that doesn't have the patches that fix the vulnerability. The easiest way to do this is to boot up a new VM with a fresh install of Windows 7 and with updates disabled.</p>
<p>This new environment is where the document would trigger once double-clicked. After a bit of loading, a pop-up would later appear greeting the analyst with congratulations (this is a stand-in for a malicious payload for this challenge), but of course, it is clear that we are not done yet.</p>
<p><img alt="emprisa-maldoc-writeup-01" src="./images/emprisa-maldoc-writeup-01.png" /></p>
<p>Tools such as <a href="https://processhacker.sourceforge.io/">Process Hacker</a> will reveal a new process named <code>EQNEDT32.EXE</code> getting spawned right after opening the document. Those who have read through the CVE details would know that this is the expected behavior, as the vulnerability uses this process to run malicious code. In this case, the exploit downloads a file from the internet and automatically runs it.</p>
<p>Another tool such as <a href="https://sourceforge.net/projects/regshot/">Regshot</a> would reveal newly created files. It can determine these by taking a snapshot before the malicious document is opened, then taking another one after the downloaded payload gets triggered, and finally comparing the two snapshots and listing the differences. It's an invaluable tool to have.</p>
<p><img alt="emprisa-maldoc-writeup-02" src="./images/emprisa-maldoc-writeup-02.png" /></p>
<p>Running <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/rtfdump.py">rtfdump.py</a> would then reveal some telling details about our maldoc, like for example, magic signatures and object streams.</p>
<p>Upon close inspection of the hexdump of the largest object stream (still via rtfdump), one would see a sequence of NOPs (aka a NOPsled) in certain parts. A NOPsled such as this usually indicates the possible start of shellcode. Carving this part of the shellcode and running it on an emulator such as <a href="https://github.com/fireeye/speakeasy">speakeasy</a> or <a href="http://sandsprite.com/blogs/index.php?uid=7&amp;pid=152">scdbg</a> won't work properly, however.</p>
<p><img alt="emprisa-maldoc-writeup-03" src="./images/emprisa-maldoc-writeup-03.png" /></p>
<p>The output shows the first line to be <code>LoadLibrary</code>, and then there's an error after that. This indicates that maybe there's a problem with the shellcode. </p>
<p>On further inspection, a little more further down there is another set of seemingly readable strings. This could indicate another shellcode. Or, maybe, a continuation of the first one? In between these supposed two shellcodes is a readable string that seems out of place in between the gibberish. Carving the two shellcodes and then combining them would now work when run on an emulator.</p>
<p><img alt="emprisa-maldoc-writeup-04" src="./images/emprisa-maldoc-writeup-04.png" /></p>
<p>If the previous solution was not immediately clear to you then there is another approach to the above. And that is to step through the <code>EQNEDT32</code> process as soon as it runs. However, attaching to this process is tricky as it triggers only for a split second and then exits. To debug this, a debugger should be automatically connected as soon as the process starts. Check out <a href="https://pentestlab.blog/2020/01/13/persistence-image-file-execution-options-injection/">this post</a> for details on how to do this.</p>
<p>Once attached, the painstaking process of debugging begins. Thankfully, we have an idea of what code is being loaded into memory. And this is the shellcode that has a NOPSled during our analysis with rtfdump.py above. Looking for this sequence and then putting a breakpoint where the memory location is accessed would stop the program just before the shellcode is run. Once the breakpoint triggered, we could step through the shellcode and find out what exactly the shellcode does and which Libraries are being called.</p>
<p>From here, we could also backtrack from where the shellcode is called to figure out how the exploit is triggered via a buffer overflow. This requires a bit of knowledge in reverse engineering. An alternative is to <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-18822">check out the CVE details</a> in search for the tool that was likely used to make the exploit, and then examining the code.</p>
<p>After all of that, you should have everything that you need to answer all the questions in the challenge. You may have noticed that I have not revealed the answers outright. You still have to find it on your own. However, I do hope that by walking you through the process, I have helped you understand how to get there.</p>
<blockquote>
<p>If you have more questions, or want to tell me what you think of the challenge, feel free to leave a comment below or send me a mesage at @accidentalrebel. </p>
</blockquote>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./emprisa-maldoc-writeup..html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./investigating-an-fb-phishing-site.html">Investigating an FB phishing site</a></h1>
	<div class="meta">
          <time datetime="2021-04-24T05:58:00+08:00">April 24, 2021</time>
          in <span class="categories">
            <a href="./tag/phishing.html">phishing</a>          </span>
	</div>
        <p><p>Last April 21, people were posting warnings about a suspicious Facebook post where your account will supposedly get hacked when you click it. From the discussions, I gathered that it is a classic phishing site scam. A very effective one too, because as soon as an account gets compromised the attacker logs in and tags the friends in the account allowing it to spread further. The news of this got big that even the PH CERT issued <a href="https://www.facebook.com/Ncertgovph/posts/1879686332199270">a security advisory on it</a>.</p>
<p><img alt="checking-the-fb-phishing-site-02" src="./images/checking-the-fb-phishing-site-02.jpg" /></p>
<h1 id="i-was-just-curious-i-swear">I was just curious, I swear!</h1>
<p>I wanted to see the phishing site for myself but I was unlucky and did not get tagged by anyone. So I reached out to people who did and I eventually got to this page shown below:</p>
<p><img alt="checking-the-fb-phishing-site-01" src="./images/checking-the-fb-phishing-site-01.png" /></p>
<p>To a trained eye, one could easily see the obvious red flags. But how can one notice them if there is a very attention-catching image in the middle beckoning to be clicked? It's a very simple tactic yet very effective. Clicking this link leads to an external website with an even more tantalizing image masquerading as a video. </p>
<p><img alt="checking-the-fb-phishing-site-03" src="./images/checking-the-fb-phishing-site-03.png" /></p>
<p>Clicking play on that video would then lead to a fake Facebook login page. We all know what's next after that. </p>
<p><img alt="checking-the-fb-phishing-site-06" src="./images/checking-the-fb-phishing-site-06.png" /></p>
<p>Of course, the very best course of action when a phishing site is discovered is to report it. I, however, was curious so I decided to poke around first.</p>
<h1 id="the-poking-begins">The poking begins</h1>
<p>Using my knowledge in OSINT (Open Source Intelligence) and pentesting, I poked around to see what I could learn from these set of pages.</p>
<p>One thing that immediately became obvious was that these "set of pages" were hosted on separate domains. The page with the video points to one domain, and the login page to another (that is even protected by DDNS (Dynamic DNS) via No-IP). </p>
<p><img alt="investigating-an-fb-phishing-site-08" src="./images/investigating-an-fb-phishing-site-08.png" /></p>
<p>I also noticed that the way that the two pages were built was different. The coding style is not the same, different frameworks were used, plus the robots.txt of the login page was more restrictive. </p>
<p>Why are they in separate domains? Wouldn't it be cheaper to just have both pages on the same domain? </p>
<p>My hunch is that maybe the two sites were made by different people. One guy made the landing page then a different one made the login page. Or maybe the login page is an out-of-the-box solution you pay for or rent if you want to set up your own phishing scam? A PhAAS (Phishing-as-a-Service)?</p>
<p><img alt="investigating-an-fb-phishing-site-09" src="./images/investigating-an-fb-phishing-site-09.png" /></p>
<p>During my reconnaissance, I also noticed that the URLs for the login page were changed a few times over a few hours. It's possible that the pages were being taken down thanks to the reports and the malicious actors were just making new instances and redirecting to it to make sure that the operation continues.</p>
<h1 id="ang-nhap-hoac-ang">Đăng nhập hoặc đăng</h1>
<p>Another thing I noticed is references to various Vietnamese terms and websites. Both pages have directories using the word "homnay", Vietnamese for the word "today". The source code also has a link to the news website "tuoitre.vn". </p>
<p><img alt="checking-the-fb-phishing-site-04" src="./images/checking-the-fb-phishing-site-04.png" /></p>
<p>The Google Analytics ID used can also be found in previously tagged but now-defunct Phishing websites with references to Vietnam. It's entirely possible that these phishing sites initially targeted Vietnamese users but eventually got to Philippine users via the tagging spreading mechanism.</p>
<p><img alt="checking-the-fb-phishing-site-05" src="./images/checking-the-fb-phishing-site-05.png" /></p>
<p>Or maybe it's a deliberate ploy to make it seem that the origin of the phish is Vietnamese. Just to throw off those of us snooping around.</p>
<h1 id="and-then-it-was-gone">And then it was gone</h1>
<p>I was tempted to make a dummy Facebook account and send the login details to the phishing site. The idea was to see how long before an account gets accessed after submitting the credentials and if the tagging of friends is automated or done manually. But sadly I ran out of free time and by the time I came back to it the login page was already completely offline. The landing page is still up though.</p>
<p>This investigation has taught me a lot about phishing sites. It's different from investigating malware but it's easy to see the similarities in intent and approaches. I might try investigating more in the future. I'm curious to find out what the usual <em>modus operandi</em> is and also how the general populace can better protect themselves from it. </p>
<p>This particular site may be down now, but I bet there will be more in the future. As long as there are people to fall for scams like these, this type of attack will continue.</p>
<blockquote>
<p>If you want to know more or discuss the details about the phishing site, I would be happy to exchange notes. Drop me a line on Twitter @accidentalrebel.</p>
</blockquote>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./investigating-an-fb-phishing-site.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./the-emprisa-maldoc-challenge.html">The Emprisa Maldoc Challenge</a></h1>
	<div class="meta">
          <time datetime="2021-04-04T16:37:00+08:00">April 04, 2021</time>
          in <span class="categories">
            <a href="./tag/maldoc.html">maldoc</a>,            <a href="./tag/ctf.html">ctf</a>          </span>
	</div>
        <p><p>I was inspired to make my own CTF challenge after finishing <a href="{filename}/maldoc101-writeup-part-1">Maldoc101</a> found at <a href="https://cyberdefenders.org/">Cyberdefenders.org</a>. The challenge I made is called <a href="https://cyberdefenders.org/labs/56">Emprisa Maldoc</a> and it is now up on their website. </p>
<p>Emprisa is based on a malicious document that I downloaded blindly from a malware sandbox. It used a relatively old but still interesting exploit that is still in use today. After researching more about it I came across a tool that can generate a malicious doc using the same exact exploit. This is when I got the idea to turn it into a challenge.</p>
<p><img alt="the-emprisa-maldoc-challenge-01" src="./images/the-emprisa-maldoc-challenge-01.png" /></p>
<p>The challenge has 14 questions with increasing and varying difficulty. The challenge is targeted towards intermediate analysts who already have experience examining maldocs before. The goal is to reinforce the use of common malware analysis tools, but at the same time, teach players new things and techniques. It involves flexing muscles related to open source intelligence, examining shellcodes, and debugging processes. </p>
<p>I don't want to spoil too much but if you are for it, you can give it a go <a href="https://cyberdefenders.org/labs/51">here</a>. It was hella fun to make and I do hope that it is also as fun to solve!</p>
<hr />
<p>Official write-up with hints coming soon.</p>
<p>I would like to extend my thanks to the team behind CyberDefenders.org. They accepted my submission, reviewed it, and worked with me in improving it. And also to <a href="https://twitter.com/jstrosch">Josh Stroschein</a> for making Maldoc101 and being kind enough to entertain me with my questions related to making challenges.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./the-emprisa-maldoc-challenge.html">Read on →</a> -->
      </article>
    </div>
  </div>
</div>
<div class="pagination">
<p class="paginator">
    Page 1 / 4
        <a href="./index2.html">&raquo;</a>
        <a href="./index4.html">&#8649;</a>
</p>
</div>
    <footer id="footer" class="her-row">
      <div class="container">
        <div class="row">
          <h4>Powered by <a href="http://blog.getpelican.com/">Pelican</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
        </div>
      </div>
    </footer>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55068085-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-55068085-2');
    </script>
  </body>
</html>