<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>AccidentalRebel.com</title>
  <meta name="author" content="AccidentalRebel">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="canonical" href=".">

  <link href="./favicon.png" rel="icon">

  <link href="http://www.accidentalrebel.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="AccidentalRebel.com Full Atom Feed" />

  <link href="./theme/css/screen.css"  media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="./theme/css/tomorrow.css"  media="screen, projection" rel="stylesheet" type="text/css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>


</head>
  <body>

    <div class="container" id="site-title">
      <div class="col-md-8 col-md-offset-2">
	<h1>
	  <a href=".">
	    AccidentalRebel.com
	  </a>
	</h1>
	<div id="profile">
	  <div class="left">
	    <img src="./theme/images/pic.png" />
	  </div>
	  <div class="right">
	    Juan Karlo Licudine is currently employed as a Cyber Security Engineer where he uses his programming and technical skills in helping companies protect themselves from cyber threats. In his free time, he works on cybersecurity-related programming projects like malware analysis tools and remote access tools. He jumps between the red or blue camps depending on which project currently interests him.
	  </div>
	  <div class="clear"></div>
	</div>
	<div id="nav">
	  <ul>
	    <li><a href=".">Home</a></li>
	    <!-- <li><a href="./pages/made.html">My Works</a></li> -->
	    <li class="icon-nav" id="twitter-nav"><a href="https://twitter.com/accidentalrebel">Twitter</a></li>
	    <li class="icon-nav" id="github-nav"><a href="https://github.com/accidentalrebel">Github</a></li>
	    <li class="icon-nav" id="feed-nav"><a href="./feeds/all.atom.xml">RSS</a></li>
	  </ul>
	</div>
      </div>
    </div>

<div class="container">
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./building-my-virtual-cybersecurity-home-lab.html">Building my Virtual Cybersecurity Home Lab</a></h1>
	<div class="meta">
          <time datetime="2021-09-05T20:33:00+08:00">September 05, 2021</time>
          in <span class="categories">
            <a href="./tag/malware.html">malware</a>,            <a href="./tag/dev.html">dev</a>          </span>
	</div>
        <p><p>I have recently realized that one part of cybersecurity that I am lacking basic knowledge on is networking. I honestly did not think it was important when I was starting. It was the reason why I skipped Network+ so I could take Security+ directly. </p>
<p>Now I know better.</p>
<p>Ever since my realization, I have taken steps to patch the holes in my knowledge. I've started taking courses and bought books. But one thing that has made the most impact is me building my very own "homelab".</p>
<p>I first came to know of the concept of homelabs <a href="https://www.reddit.com/r/homelab/">from Reddit</a>. To those unfamiliar, it is the practice of building a networked environment to gain practical knowledge in networking and IT. One way to do this is by making a virtual network.</p>
<p>And so, over the past month, I have been building my very own virtual homelab with a focus on integrating cybersecurity products.</p>
<h1 id="the-lab">The Lab</h1>
<p>The network diagram below shows the current implementation of my lab. I will be discussing each part to give an idea of their purpose (<a href="./images/building-my-virtual-cybersecurity-home-lab-00.png">Click here for a bigger version</a>).</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-01" src="./images/building-my-virtual-cybersecurity-home-lab-01.png" /></p>
<p>At the heart of the network is a firewall running <a href="https://www.pfsense.org/">pfSense</a>. Its purpose is to ensure that each sub-network is separated and protected, and also to protect my virtual host from any malware outbreaks. This machine also serves as a DHCP and NTP server to all the machines in the network.</p>
<h1 id="the-target-network">The Target Network</h1>
<p>On the right side of the diagram is the "Target" network where workstations and vulnerable servers reside. These are the machines that I use to attack with exploits and malware.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-02" src="./images/building-my-virtual-cybersecurity-home-lab-02.png" /></p>
<p>I have Metasploitable 2 and Metasploitable 3 machines that have various services turned on to play around with. I can learn about specific attacks by exploiting this machine, but I can also don my defenders hat and learn about how to secure them.</p>
<p>The Windows and Linux machines will serve as typical workstations for various experiments.</p>
<p>One of the perks of my job is that I get to play with different cybersecurity solutions. I currently have access to a few that I am able to use on my lab for testing.</p>
<p>One solution that I am using right now is an EDR (Endpoint Detection and Response) (Sorry, I can't reveal which). Each machine has an EDR agent deployed which monitors for any malicious activities on the host. It has an anti-virus feature, anti-ransomware, and fileless attack monitoring. It's awesome stuff but I have yet to maximize this.</p>
<p>An IDS (intrusion Detection System) running <a href="https://www.snort.org/">Snort</a> monitors the traffic for any malicious activity. Signatures are constantly updated to ensure that I can detect the latest types of attack. If it finds anything important, it then sends an alert to a SIEM (running <a href="https://www.splunk.com/">Splunk</a>) on the Management network.</p>
<h1 id="the-management-network">The Management Network</h1>
<p>On the left side of the diagram is the Managemnet network. This is where the management part of the EDR, IDS, and the SIEM can be accessed from my virtual host.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-03" src="./images/building-my-virtual-cybersecurity-home-lab-03.png" /></p>
<h1 id="the-operations-network">The Operations Network</h1>
<p>At the bottom side of the diagram is the "Operations" network.</p>
<p>A machine running Kali is placed here. I can launch attacks from this machine towards the vulnerable machines on the Target network. This machine also has OpenVAS scanner that helps in discovering vulnerabilities on the target machines.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-04" src="./images/building-my-virtual-cybersecurity-home-lab-04.png" /></p>
<p>A windows machine serves as my malware analysis lab. It contains a lot of malware analysis tools to aid with investigations. </p>
<p>This machine is then connected to a Remnux Linux machine. All traffic from the Windows machine is port forwarded by Remnux. From here I can run Wireshark to inspect the traffic coming from the Windows malware lab and it can also spoof the network responses to influence the behavior of malware. If the Remnux machine is turned off, then the Windows machine is effectively cut off from the whole network. It's a really neat setup that <a href="https://www.ariefprabowo.com/en/malware-analysis-en/personal-notes-building-a-malware-analysis-lab-environment/">I learned here</a>.</p>
<h1 id="the-present">The Present</h1>
<p>While the main intent of the network is to learn networking and implementing cybersecurity products, I can also investigate malware and learn about exploits by launching attacks. So it has a lot of multiple uses, which is perfect for someone like me who gets interested in different aspects of cybersecurity.</p>
<p>My host machine currently has 32GB, 8 cores, and a total of 1.75TB which may seem a lot but is not powerful enough for all the machines to run at the same time. As a workaround, I just open the machines that I need for a particular exercise.</p>
<p><img alt="building-my-virtual-cybersecurity-home-lab-05" src="./images/building-my-virtual-cybersecurity-home-lab-05.png" /></p>
<p>For example, if I want to investigate malware then I only need the firewall, Remnux, and the windows malware lab open. But if I want to attack and run an exploit, while making sure that it gets detected, then I need the firewall, EDR, IPS, SIEM, Kali, and the target machine to be open at the same time. This easily consumes around 20GB+!</p>
<h1 id="the-future">The Future</h1>
<p>Working on this homelab has taught me a lot of practical knowledge. It helped solidify a lot of networking concepts I've learned througout the years.</p>
<p>I'm not stopping here though. I plan to upgrade the Target network so it would better resemble an enterprise network. For example, setting up an active directory, an internal DNS server, and maybe even a mail server (why not?). This is so I could play around in detecting and remediating more varied enterprise-level scenarios.</p>
<p>I am also hoping I could get access to more cybersecurity products so I could play around with them. A SOAR (Security Orchestration and Response) would be a nice addition that would work really well.</p>
<p>But, of course, before I could do any of the above I first need to upgrade my RAM and add more cores!</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./building-my-virtual-cybersecurity-home-lab.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./making-a-rat.html">Making a RAT</a></h1>
	<div class="meta">
          <time datetime="2021-07-13T14:56:00+08:00">July 13, 2021</time>
          in <span class="categories">
            <a href="./tag/malware.html">malware</a>,            <a href="./tag/dev.html">dev</a>          </span>
	</div>
        <p><p>A Remote Access Tool (RAT) is used to remotely access a computer. It has legitimate uses but it can also be used for malicious purposes. I've seen it used in malware I've analyzed and I've always been curious as to how it works.</p>
<p>I was following along the <a href="https://handmadehero.org/">Handmade Hero project</a> <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> when the topic about dynamic DLL loading came up. This is a process of dynamically loading a DLL at runtime which is useful if you want your program to check if a DLL is present in a system before loading it.</p>
<p>Two of the system calls that were discussed were LoadLibrary and GetProcAddress. These were familiar to me as I've seen them used on malware shellcode I analyzed in the past. I later learned that this is also used as an anti-virus evasion technique. I found this interesting.</p>
<p>Having learned how to do runtime DLL loading myself I decided to give it a try. And of course, a RAT is perfect for this.</p>
<p><img alt="making-a-rat-01" src="./images/making-a-rat-01.png" /></p>
<h2 id="planning-the-ratchitecture">Planning the RATchitecture</h2>
<p>A lot of famous RATs are packed with features like the ability to log keystrokes, take screenshots, and turn on a webcam. I just want mine to be simple and have basic functionality like:</p>
<ul>
<li>Execute command line commands remotely</li>
<li>Download a file to the client</li>
<li>Exfiltrate data via file upload</li>
</ul>
<p>You can already do a lot of things even with the above basic functions. You can download a payload to the client, run it via remote command and then upload the results. You can even update the RAT itself using the same process!</p>
<p>As an extra, I also wanted it to be stealthy. I am aware however that this is something that is not easily done. There are myriads of security defenses and I don't think I have the time and energy to have my RAT to be up-to-date with the latest evasion techniques. Having basic anti-debugging and anti-sandbox checks is enough for me.</p>
<p>I've never made a RAT before but thankfully there are a lot of great resources online that helped me a lot:</p>
<ul>
<li><a href="https://github.com/quantumcore/paradoxiaRAT">ParadoxiaRat</a> is my main resource and has done a lot of the features I wanted to implement.</li>
<li><a href="https://github.com/yatt-ze/The-Collection/tree/master/Source%20Codes/Botnets/DarkRat%20Loader/derkrut">DarkRAT</a> is a leaked source code that gave me an idea of how a RAT used in the wild looks like</li>
<li><a href="https://github.com/vxunderground/WinAPI-Tricks">VXUnderground's WinAPI tricks</a> taught me that there are alternative ways to do certain things to avoid detection</li>
</ul>
<p>As for the name of the project, I decided on "RATwurst" after the german sausage, Bratwurst. Don't ask me why. I just thought it's funny that it had the letters RAT in it.</p>
<p><img alt="making-a-rat-02" src="./images/making-a-rat-02.png" /></p>
<h2 id="the-nitty-gratty-details">The nitty gRATty details</h2>
<p>The client is written in ANSI C because it's the language I prefer. Since I am only targeting Windows I chose MSVC for the compiler. Which is great because it allows me to use Visual Studio for debugging.</p>
<p>The server, on the other hand, is written in Python because I wanted another excuse to practice with it. Choosing Python has been a good choice though because of the excellent low level <a href="https://docs.python.org/3/library/socket.html">socket</a> and <a href="https://docs.python.org/3/library/cmd.html">cmd</a> libraries.</p>
<p>Sockets are used for communication between client and server. I've applied basic XOR obfuscation to the data to mask the traffic. The client and server can handle sending of strings and even executables over the network.</p>
<p>When RATwurst is first executed. It does some anti-sandbox checks via process enumeration. It checks if there are more than 15 processe that are running and if there are virtualization tools present like <code>vmware.exe</code>. It will also setup an auto-run registry entry for persistence. And also move the executable to Windows' temp folder and re-run it from there.</p>
<p>Anti-debbuging checks are littered throughout the code which checks the amount of time it takes to reach from one part of the code to the next. This is used to detect if someone is stepping through the code, increasing the delay between code execution.</p>
<p>When no shenanigans is detected then it'll proceed to work as intended. </p>
<p><img alt="making-a-rat-02" src="./images/making-a-rat-02.png" /></p>
<h2 id="for-edurational-purposes-only">For eduRATional purposes only</h2>
<p>I've made the source of my project <a href="https://github.com/accidentalrebel/ratwurst">available on Github</a>. The aim is to share what I've learned so that others can learn too.</p>
<p>I am aware of news of RAT authors having been arrested because of their work. They actively sought to gain money from their creation, I, of course, have no such plans.</p>
<p>To make sure that I save myself from any legal problems, I've placed a disclaimer that I am not responsible for any misuse. While I am skeptical that a piece of text would prevent any legal action towards me, I do see other projects having their own disclaimers so I decided to do the same.</p>
<p>I've also submitted my creation to a multi-scanner service like VirusTotal. This would help distribute my RATs signature to anti-virus companies so it can easily be detected when used in the wild.<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup></p>
<h2 id="a-ratisfying-learning-experience">A RATisfying learning experience</h2>
<p>Making this project has been a lot of fun. </p>
<p>The most useful thing that I learned is the client and server communication via sockets. I've dabbled with it before but only in this project have I actually sent actual data back and forth.</p>
<p>I am also happy that I got to use more Windows APIs. It's fun to play around with what's available and it is opening my mind as to what other things I can make in the future.</p>
<p>And of course, this project has given me a good insight into the techniques used by malware. Learning about them is not enough until you've built one yourself.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Handmade here is a project by Casey Muratori where a game is created from scratch live on stream, has been going on for 6+ years, it's awesome&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Multi-scanners help to easily distribute virus signatures to security services. An opposite to this are "no-distribute" sacnners. More info about this <a href="https://www.bleepingcomputer.com/news/security/75-percent-of-malware-uploaded-on-no-distribute-scanners-is-unknown-to-researchers/">here</a>.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./making-a-rat.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./finding-phished-passwords-on-a-scam-site.html">Finding phished passwords on a scam site</a></h1>
	<div class="meta">
          <time datetime="2021-05-01T20:56:00+08:00">May 01, 2021</time>
          in <span class="categories">
            <a href="./tag/phishing.html">phishing</a>          </span>
	</div>
        <p><p>Since my last post about <a href="investigating-an-fb-phishing-site">my investigations of a Facebook phishing site</a>, I have received several messages from friends asking me to check out other suspected phishing/scam sites. One of the most alarming out of them was this one where I was able to find the file where the scammer stores the phished usernames and passwords.</p>
<p><img alt="finding-phished-passwords-from-a-scam-site-01" src="./images/finding-phished-passwords-from-a-scam-site-01.png" /></p>
<p>This particular phishing site conducts its operations like this:</p>
<ul>
<li>An ad is shown on Facebook, promising free coupons for famous fast food restaurants</li>
<li>Clicking on the ad takes the user to a fake Facebook login page hosted on <em>blogger.com</em></li>
<li>Login page then sends phished username and passwords to a PHP file hosted on <em>000webhost</em></li>
</ul>
<p>The phished passwords are then stored in a <code>.txt</code> file (blatantly named, <code>victims.txt</code>), which is publicly accessible on an open directory. Getting to this directory involved following the scripts and the URLs used by the scammers. It's not that hard to find as long as you know where to look.</p>
<p>What's scary is that the size of this text file kept on getting bigger. I knew I had to act quickly.</p>
<h2 id="stopping-the-scammers">Stopping the scammers</h2>
<p>Unfortunately, with phishing sites like these, there's not much we could do but report it to the relevant hosting providers. The problem is that sometimes it may take some time before the site gets reviewed, which is excruciating because the longer the wait, the more people fall victim. Some might even just ignore your report altogether!</p>
<p>I reported the fake login page to Blogger.com and did not receive any response at all. I understand that Blogger.com is a big platform and I bet they receive numerous reports like this. I guess this is why the scammer used this platform as they know they won't be taken down too quickly. Their profile even listed two sites that both had fake login pages. </p>
<p><img alt="finding-phished-passwords-from-a-scam-site-04" src="./images/finding-phished-passwords-from-a-scam-site-04.png" /></p>
<p>Thankfully, <em>000webhost</em> got back to me and eventually took down the page that hosted the PHP and text files.</p>
<p><img alt="finding-phished-passwords-from-a-scam-site-03" src="./images/finding-phished-passwords-from-a-scam-site-03.png" /></p>
<p>You'd think that this is a victory. But sadly, setting up a new phishing site is rather easy so within a few hours there is already a new one. Of course, I reported this new site too. Only for a new one to pop up later...</p>
<p>You can see how this can become an endless cat and mouse game.</p>
<h2 id="stopping-from-other-sources">Stopping from other sources</h2>
<p>One way that could be effective to stop the scammer's operations is by reporting the Facebook advertisement that is used to lure users to the phishing site. Unfortunately, my friend who shared this with me did not get a chance to snap a screenshot of the ad. If he did then it would probably have more impact on stopping their operations. Maybe the Facebook abuse team can trace the payment details used to pay for the ad, and maybe block it. </p>
<p><img alt="finding-phished-passwords-from-a-scam-site-02" src="./images/finding-phished-passwords-from-a-scam-site-02.png" /></p>
<p>If you know anyone who may have seen a Facebook advertisement that offers free coupon codes for fast food restaurants that might be pointing to a suspicious login page, then please do contact me!</p>
<h2 id="awareness-is-the-key">Awareness is the key</h2>
<p>As of this posting, the landing page is still up while the page that hosts the PHP and victims file is down. I'm sure it'll be back up soon. All I was able to do was delay their operations. A minor inconvenience for them.</p>
<p><img alt="finding-phished-passwords-from-a-scam-site-05" src="./images/finding-phished-passwords-from-a-scam-site-05.png" /></p>
<p>This is why out of everything, spreading awareness is the best countermeasure. If people are more aware of phishing sites and how to avoid them then that would greatly diminish their impact. This is why I continue to post and write about phishing sites. Seeing the number of victims rising like that made me act knowing that I at least have the power to prevent things from escalating.</p>
<p>And you have the power too, dear reader. Educate your family and friends by warning them or by showing them my posts. Remember, awareness is our best defense!</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./finding-phished-passwords-on-a-scam-site.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./emprisa-maldoc-writeup..html">Emprisa Maldoc Writeup</a></h1>
	<div class="meta">
          <time datetime="2021-04-30T05:58:00+08:00">April 30, 2021</time>
          in <span class="categories">
            <a href="./tag/writeup.html">writeup</a>          </span>
	</div>
        <p><blockquote>
<p>This is a writeup for <a href="the-emprisa-maldoc-challenge">Emprisa maldoc challenge</a> that I made for <a href="https://cyberdefenders.org/">CyberDefenders.org</a>. You can play it <a href="https://cyberdefenders.org/labs/56">here</a>.</p>
</blockquote>
<p>The very first thing that I do when confronted with a malicious document is to run it in a malware lab. This particular document, however, would not exhibit anything malicious on recent versions of Word.</p>
<p>A quick search of the hash on malware sandboxes would reveal that the document makes use of the <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-18822">CVE-2017-18822 vulnerability</a>. This is a vulnerability that became known and was promptly patched around November of 2017.</p>
<p>The above details give us a hint on how to trigger the document, which is to run the maldoc on a version of Microsoft Word that doesn't have the patches that fix the vulnerability. The easiest way to do this is to boot up a new VM with a fresh install of Windows 7 and with updates disabled.</p>
<p>This new environment is where the document would trigger once double-clicked. After a bit of loading, a pop-up would later appear greeting the analyst with congratulations (this is a stand-in for a malicious payload for this challenge), but of course, it is clear that we are not done yet.</p>
<p><img alt="emprisa-maldoc-writeup-01" src="./images/emprisa-maldoc-writeup-01.png" /></p>
<p>Tools such as <a href="https://processhacker.sourceforge.io/">Process Hacker</a> will reveal a new process named <code>EQNEDT32.EXE</code> getting spawned right after opening the document. Those who have read through the CVE details would know that this is the expected behavior, as the vulnerability uses this process to run malicious code. In this case, the exploit downloads a file from the internet and automatically runs it.</p>
<p>Another tool such as <a href="https://sourceforge.net/projects/regshot/">Regshot</a> would reveal newly created files. It can determine these by taking a snapshot before the malicious document is opened, then taking another one after the downloaded payload gets triggered, and finally comparing the two snapshots and listing the differences. It's an invaluable tool to have.</p>
<p><img alt="emprisa-maldoc-writeup-02" src="./images/emprisa-maldoc-writeup-02.png" /></p>
<p>Running <a href="https://github.com/DidierStevens/DidierStevensSuite/blob/master/rtfdump.py">rtfdump.py</a> would then reveal some telling details about our maldoc, like for example, magic signatures and object streams.</p>
<p>Upon close inspection of the hexdump of the largest object stream (still via rtfdump), one would see a sequence of NOPs (aka a NOPsled) in certain parts. A NOPsled such as this usually indicates the possible start of shellcode. Carving this part of the shellcode and running it on an emulator such as <a href="https://github.com/fireeye/speakeasy">speakeasy</a> or <a href="http://sandsprite.com/blogs/index.php?uid=7&amp;pid=152">scdbg</a> won't work properly, however.</p>
<p><img alt="emprisa-maldoc-writeup-03" src="./images/emprisa-maldoc-writeup-03.png" /></p>
<p>The output shows the first line to be <code>LoadLibrary</code>, and then there's an error after that. This indicates that maybe there's a problem with the shellcode. </p>
<p>On further inspection, a little more further down there is another set of seemingly readable strings. This could indicate another shellcode. Or, maybe, a continuation of the first one? In between these supposed two shellcodes is a readable string that seems out of place in between the gibberish. Carving the two shellcodes and then combining them would now work when run on an emulator.</p>
<p><img alt="emprisa-maldoc-writeup-04" src="./images/emprisa-maldoc-writeup-04.png" /></p>
<p>If the previous solution was not immediately clear to you then there is another approach to the above. And that is to step through the <code>EQNEDT32</code> process as soon as it runs. However, attaching to this process is tricky as it triggers only for a split second and then exits. To debug this, a debugger should be automatically connected as soon as the process starts. Check out <a href="https://pentestlab.blog/2020/01/13/persistence-image-file-execution-options-injection/">this post</a> for details on how to do this.</p>
<p>Once attached, the painstaking process of debugging begins. Thankfully, we have an idea of what code is being loaded into memory. And this is the shellcode that has a NOPSled during our analysis with rtfdump.py above. Looking for this sequence and then putting a breakpoint where the memory location is accessed would stop the program just before the shellcode is run. Once the breakpoint triggered, we could step through the shellcode and find out what exactly the shellcode does and which Libraries are being called.</p>
<p>From here, we could also backtrack from where the shellcode is called to figure out how the exploit is triggered via a buffer overflow. This requires a bit of knowledge in reverse engineering. An alternative is to <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-18822">check out the CVE details</a> in search for the tool that was likely used to make the exploit, and then examining the code.</p>
<p>After all of that, you should have everything that you need to answer all the questions in the challenge. You may have noticed that I have not revealed the answers outright. You still have to find it on your own. However, I do hope that by walking you through the process, I have helped you understand how to get there.</p>
<blockquote>
<p>If you have more questions, or want to tell me what you think of the challenge, feel free to leave a comment below or send me a mesage at @accidentalrebel. </p>
</blockquote>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./emprisa-maldoc-writeup..html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./investigating-an-fb-phishing-site.html">Investigating an FB phishing site</a></h1>
	<div class="meta">
          <time datetime="2021-04-24T05:58:00+08:00">April 24, 2021</time>
          in <span class="categories">
            <a href="./tag/phishing.html">phishing</a>          </span>
	</div>
        <p><p>Last April 21, people were posting warnings about a suspicious Facebook post where your account will supposedly get hacked when you click it. From the discussions, I gathered that it is a classic phishing site scam. A very effective one too, because as soon as an account gets compromised the attacker logs in and tags the friends in the account allowing it to spread further. The news of this got big that even the PH CERT issued <a href="https://www.facebook.com/Ncertgovph/posts/1879686332199270">a security advisory on it</a>.</p>
<p><img alt="checking-the-fb-phishing-site-02" src="./images/checking-the-fb-phishing-site-02.jpg" /></p>
<h1 id="i-was-just-curious-i-swear">I was just curious, I swear!</h1>
<p>I wanted to see the phishing site for myself but I was unlucky and did not get tagged by anyone. So I reached out to people who did and I eventually got to this page shown below:</p>
<p><img alt="checking-the-fb-phishing-site-01" src="./images/checking-the-fb-phishing-site-01.png" /></p>
<p>To a trained eye, one could easily see the obvious red flags. But how can one notice them if there is a very attention-catching image in the middle beckoning to be clicked? It's a very simple tactic yet very effective. Clicking this link leads to an external website with an even more tantalizing image masquerading as a video. </p>
<p><img alt="checking-the-fb-phishing-site-03" src="./images/checking-the-fb-phishing-site-03.png" /></p>
<p>Clicking play on that video would then lead to a fake Facebook login page. We all know what's next after that. </p>
<p><img alt="checking-the-fb-phishing-site-06" src="./images/checking-the-fb-phishing-site-06.png" /></p>
<p>Of course, the very best course of action when a phishing site is discovered is to report it. I, however, was curious so I decided to poke around first.</p>
<h1 id="the-poking-begins">The poking begins</h1>
<p>Using my knowledge in OSINT (Open Source Intelligence) and pentesting, I poked around to see what I could learn from these set of pages.</p>
<p>One thing that immediately became obvious was that these "set of pages" were hosted on separate domains. The page with the video points to one domain, and the login page to another (that is even protected by DDNS (Dynamic DNS) via No-IP). </p>
<p><img alt="investigating-an-fb-phishing-site-08" src="./images/investigating-an-fb-phishing-site-08.png" /></p>
<p>I also noticed that the way that the two pages were built was different. The coding style is not the same, different frameworks were used, plus the robots.txt of the login page was more restrictive. </p>
<p>Why are they in separate domains? Wouldn't it be cheaper to just have both pages on the same domain? </p>
<p>My hunch is that maybe the two sites were made by different people. One guy made the landing page then a different one made the login page. Or maybe the login page is an out-of-the-box solution you pay for or rent if you want to set up your own phishing scam? A PhAAS (Phishing-as-a-Service)?</p>
<p><img alt="investigating-an-fb-phishing-site-09" src="./images/investigating-an-fb-phishing-site-09.png" /></p>
<p>During my reconnaissance, I also noticed that the URLs for the login page were changed a few times over a few hours. It's possible that the pages were being taken down thanks to the reports and the malicious actors were just making new instances and redirecting to it to make sure that the operation continues.</p>
<h1 id="ang-nhap-hoac-ang">Đăng nhập hoặc đăng</h1>
<p>Another thing I noticed is references to various Vietnamese terms and websites. Both pages have directories using the word "homnay", Vietnamese for the word "today". The source code also has a link to the news website "tuoitre.vn". </p>
<p><img alt="checking-the-fb-phishing-site-04" src="./images/checking-the-fb-phishing-site-04.png" /></p>
<p>The Google Analytics ID used can also be found in previously tagged but now-defunct Phishing websites with references to Vietnam. It's entirely possible that these phishing sites initially targeted Vietnamese users but eventually got to Philippine users via the tagging spreading mechanism.</p>
<p><img alt="checking-the-fb-phishing-site-05" src="./images/checking-the-fb-phishing-site-05.png" /></p>
<p>Or maybe it's a deliberate ploy to make it seem that the origin of the phish is Vietnamese. Just to throw off those of us snooping around.</p>
<h1 id="and-then-it-was-gone">And then it was gone</h1>
<p>I was tempted to make a dummy Facebook account and send the login details to the phishing site. The idea was to see how long before an account gets accessed after submitting the credentials and if the tagging of friends is automated or done manually. But sadly I ran out of free time and by the time I came back to it the login page was already completely offline. The landing page is still up though.</p>
<p>This investigation has taught me a lot about phishing sites. It's different from investigating malware but it's easy to see the similarities in intent and approaches. I might try investigating more in the future. I'm curious to find out what the usual <em>modus operandi</em> is and also how the general populace can better protect themselves from it. </p>
<p>This particular site may be down now, but I bet there will be more in the future. As long as there are people to fall for scams like these, this type of attack will continue.</p>
<blockquote>
<p>If you want to know more or discuss the details about the phishing site, I would be happy to exchange notes. Drop me a line on Twitter @accidentalrebel.</p>
</blockquote>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./investigating-an-fb-phishing-site.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./the-emprisa-maldoc-challenge.html">The Emprisa Maldoc Challenge</a></h1>
	<div class="meta">
          <time datetime="2021-04-04T16:37:00+08:00">April 04, 2021</time>
          in <span class="categories">
            <a href="./tag/maldoc.html">maldoc</a>,            <a href="./tag/ctf.html">ctf</a>          </span>
	</div>
        <p><p>I was inspired to make my own CTF challenge after finishing <a href="{filename}/maldoc101-writeup-part-1">Maldoc101</a> found at <a href="https://cyberdefenders.org/">Cyberdefenders.org</a>. The challenge I made is called <a href="https://cyberdefenders.org/labs/56">Emprisa Maldoc</a> and it is now up on their website. </p>
<p>Emprisa is based on a malicious document that I downloaded blindly from a malware sandbox. It used a relatively old but still interesting exploit that is still in use today. After researching more about it I came across a tool that can generate a malicious doc using the same exact exploit. This is when I got the idea to turn it into a challenge.</p>
<p><img alt="the-emprisa-maldoc-challenge-01" src="./images/the-emprisa-maldoc-challenge-01.png" /></p>
<p>The challenge has 14 questions with increasing and varying difficulty. The challenge is targeted towards intermediate analysts who already have experience examining maldocs before. The goal is to reinforce the use of common malware analysis tools, but at the same time, teach players new things and techniques. It involves flexing muscles related to open source intelligence, examining shellcodes, and debugging processes. </p>
<p>I don't want to spoil too much but if you are for it, you can give it a go <a href="https://cyberdefenders.org/labs/51">here</a>. It was hella fun to make and I do hope that it is also as fun to solve!</p>
<hr />
<p>Official write-up with hints coming soon.</p>
<p>I would like to extend my thanks to the team behind CyberDefenders.org. They accepted my submission, reviewed it, and worked with me in improving it. And also to <a href="https://twitter.com/jstrosch">Josh Stroschein</a> for making Maldoc101 and being kind enough to entertain me with my questions related to making challenges.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./the-emprisa-maldoc-challenge.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./ioli-crackme-0x03.html">IOLI Crackme 0x03</a></h1>
	<div class="meta">
          <time datetime="2021-03-22T20:03:00+08:00">March 22, 2021</time>
          in <span class="categories">
            <a href="./tag/re.html">re</a>,            <a href="./tag/crackme.html">crackme</a>          </span>
	</div>
        <p><p>I am continuing my reverse engineering review by tackling the <em>IOLI crackmes</em> by <a href="https://twitter.com/pof">@pof</a>. These are beginner friendly challenges that is perfect for newbies or for those who want to review the basics like me. Check out my writeups for <a href="./ioli-crackme-0x00.html">0x00</a>, <a href="./ioli-crackme-0x01.html">0x01</a>, and <a href="./ioli-crackme-0x02.html">0x02</a>.</p>
<h1 id="getting-the-password">Getting the password</h1>
<p>After opening the program in IDA I immediately saw that the code is almost exactly as the one in challenge <a href="./ioli-crackme-0x02.html">0x02</a>, with the exception of our expected <code>cmp</code> command being inside the <code>_test</code> function.</p>
<p><img alt="ioli-crackme-0x03-01" src="./images/ioli-crackme-0x03-01.png" /></p>
<p>Reading through the code I realized that the password for this challenge is exactly the same as the previous one!</p>
<p>But what's this? The success and failure messages are all garbled? And plus, what is this other new function called <code>_shift</code>?</p>
<p><img alt="ioli-crackme-0x03-02" src="./images/ioli-crackme-0x03-02.png" /></p>
<h1 id="a-different-kind-of-challenge">A different kind of challenge</h1>
<p>Opening up the <code>_shift</code> function shows us a short, but interesting looking program flow with two branches and one of the branches looping back. It seems we have a <em>loop</em> here that we could investigate.</p>
<p><img alt="ioli-crackme-0x03-03" src="./images/ioli-crackme-0x03-03.png" /></p>
<p>If we look at the input that the function takes we will find out that the strings that are being passed from the <code>_test</code> function are <code>Lqydolg#Sdvvzrug$</code> and <code>Sdvvzrug#RN$$$#=,</code> for the <em>failure</em> and <em>success</em> messages, respectively. This tells us that a cipher is applied to these strings. What cipher it is using is what we'll be trying to find out.</p>
<h1 id="discovering-the-cipher">Discovering the cipher</h1>
<p>The best way to discover the cipher used is to step through the code. We can do it with both static or dynamic analysis, but the latter is way easier.</p>
<p><img alt="ioli-crackme-0x03-04" src="./images/ioli-crackme-0x03-04.png" /></p>
<p>The code above starts with <code>mov eax, [ebp+arg_0]</code> which copies the pointer to the string passed to our <code>_shift</code> function. We then copy that pointer to <code>[esp+98h+Str]</code> which is the memory location pointing to the top of the current stack. This is done so that it can be passed as an argument when we do <code>call _strlen</code>.</p>
<p>After executing, <code>_strlen</code> returns the length of the specified string and is saved to register <code>eax</code>. This is then used in the line <code>cmp [ebp+var_7C], eax</code>. </p>
<p>But what is the value of <code>var_7C</code>? If you scroll up at the start of the subroutine, <code>var_7C</code> is assigned a value of zero. If you know how loops work, you'll realize that this variable is going to be used to hold a counter value. It starts at a value of <code>0</code> and it will eventually be incremented after every loop, which is what is happening at <code>401348</code>.</p>
<p>To make it easy for us to remember this, let's rename <code>var_7C</code> to a more memorable name like <code>var_counter</code>.</p>
<p><img alt="ioli-crackme-0x03-05" src="./images/ioli-crackme-0x03-05.png" /></p>
<p>So going back, to the comparison command <code>cmp [ebp+var_counter], eax</code>, which now translates to <code>cmp 0, 17</code>. <em>17</em> being the length of our failure string <code>Lqydolg#Sdvvzrug$</code>. Since this is not equal it now goes to this next block of code.</p>
<p><img alt="ioli-crackme-0x03-06" src="./images/ioli-crackme-0x03-06.png" /></p>
<p>Now this block is interesting. There's a lot that is happening but the gist of it is that the program gets one character from the input string, with <code>var_counter</code> as an offset. It then decrements that character value by 3, and added to a destination string. I'll be going through the code that I described step by step in the next section.</p>
<h1 id="stepping-through">Stepping through</h1>
<p>So to start, <code>lea eax, [ebp+var_78]</code> loads the address to <code>var_78</code> which in my case points to the address <code>28FE90</code>.</p>
<p><code>mov edx, eax</code> copies that address to <code>edx</code> so we can use it on the next line.</p>
<p><code>add edx, [ebp+var_counter]</code> adds to the address of <code>var_78</code>. Because <code>var_counter</code> is still <code>0</code>, the address remains at <code>28FE90</code>.</p>
<p><code>add eax, [ebp+arg_0]</code> does the same thing as above but this time adding to <code>[arg_0]</code> which contains the address <code>28FF10</code>.</p>
<p><code>movzx eax, byte ptr [eax]</code> copies the byte contained in <code>[eax]</code> or <code>28FF10</code>. In this case that byte contains the value <code>4Ch</code> or <code>L</code> in ASCII. This is the first letter in our failure string <code>Lqydolg#Sdvvzrug$</code>!</p>
<p><code>sub al, 3</code> then substracts 3 to <code>4Ch</code> making it <code>49h</code> which is ASCII for <code>I</code>.</p>
<p><code>mov [edx], al</code> saves the new character to the variable <code>var_78</code> which is the memory location <code>28FE90</code>. At this point in time the content is currently the character <code>I</code>. To make it easy for us to understand the code, let's rename <code>var_78</code> to <code>var_dest</code>. This name is apt because this will be the destination for our shifted ASCII characters.</p>
<p><code>lea eax, [ebp+var_counter]</code> and then <code>inc dword ptr [eax]</code> now increments the value of <code>var_counter</code>, which now makes it an integer value of <code>1</code>.</p>
<h1 id="looping-back">Looping back</h1>
<p>Alright. Now we go back up again to <code>loc_401320</code>. I'm not going to step through each line again, but I will highlight the important parts now that we have looped back.</p>
<p><code>cmp [ebp+var_counter]</code> now translates to <code>cmp 1, 17</code>, which is still not equal.</p>
<p><code>add edx, [ebp+var_counter]</code> now adds 1 to our <code>var_dest</code> variable, turning <code>28FE90</code> to <code>28FE91</code>. The address for the <code>arg_0</code> variable is also added by 1 at <code>add eax, [ebp+arg_0]</code>.</p>
<p>By the time <code>movzx eax, byte ptr [eax]</code> is executed it now gets the next character in our failure string which is <code>71h</code> or the letter <code>q</code>.</p>
<p><code>sub al, 3</code> converts are letter <code>q</code> to the letter <code>n</code>. And is once again saved to our <code>var_dest</code> variable with the command <code>mov [edx], al</code>.</p>
<h1 id="repeat-until">Repeat until...</h1>
<p>If I haven't lost you, then you should now be able to follow what will happen in the next steps:</p>
<p><code>var_counter</code> will get incremented again and again, which will point to the next characters in the string. For example, the next characters: <code>y</code> then <code>d</code> then <code>o</code> will get shifted to <code>v</code> then <code>a</code> then <code>l</code>, respectively. This shifting of each characters will continue until <code>cmp [ebp+var_counter</code> equates to <code>cmp 17, 17</code>. </p>
<p>By the end, <code>var_dest</code> now contains the newly shifted string <code>Invalid Password!</code>. Finally! Applying the same code above to the success message, the garbled message would end with <code>Password OK!!! :)</code>.</p>
<p>Wasn't that fun?</p>
<h1 id="on-to-the-next-challenge">On to the next challenge</h1>
<p>I hope I was able to explain properly the simple shifting algorithm used by the program above. I did it this way mostly for my own benefit and to make sure I really did understand how the algorithm worked in assembly. In future writeups I'll refrain from stepping through code at such a granular level, unless there is something really important that warrants it. Or maybe a video would be a much better format for these kinds of challenges?</p>
<p>Anyway, I look forward to the next challenge. Hopefully, you are too!</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./ioli-crackme-0x03.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./maldoc101-writeup-part-1.html">Maldoc101 Writeup (Part 1)</a></h1>
	<div class="meta">
          <time datetime="2021-03-13T08:34:00+08:00">March 13, 2021</time>
          in <span class="categories">
            <a href="./tag/re.html">re</a>,            <a href="./tag/malware_analysis.html">malware_analysis</a>,            <a href="./tag/malware.html">malware</a>          </span>
	</div>
        <p><p>This is part 1 out of 2 of my writeup for the Maldoc101 challenge made by Josh Stroschein (<a href="https://twitter.com/jstrosch">@jstrosch</a>) and is currently playable at <a href="https://cyberdefenders.org/labs/51">Cyberdefenders.Org</a>. I've done some maldoc analysis before but this is the first time I'm writing about my approach.</p>
<p>There is also an already existing writeup about this challenge <a href="https://github.com/jstrosch/malware-samples/blob/master/malware_analysis_exercises/2020/December/solution.md">from the creator himself</a>. You should check that out if you want a more detailed and focused writeup. This writeup is more from the perspective of someone relatively new to malware analysis. There's a lot more exploration and trial-and-error which, I hope, might give the reader a different view in how this kind of problem is approached.</p>
<h2 id="the-challenge">The challenge</h2>
<h3 id="name">Name</h3>
<p><a href="https://cyberdefenders.org/labs/51">MalDoc101 - Malicious Document</a></p>
<h3 id="description">Description</h3>
<p>It is common for threat actors to utilize living off the land (LOTL) techniques, such as the execution of PowerShell to further their attacks and transition from macro code. This challenge is intended to show how you can often times perform quick analysis to extract important IOCs. The focus of this exercise is on static techniques for analysis.</p>
<h3 id="suggested-tools">Suggested Tools</h3>
<ul>
<li>REMnux Virtual Machine (remnux.org)</li>
<li>Terminal/Command prompt w/ Python installed</li>
<li>Oledump</li>
<li>Text editor</li>
</ul>
<h2 id="the-easy-questions">The easy questions</h2>
<p>The first question seems very easy. The <em>suggested tools</em> section above also gives us an idea how to approach this.</p>
<blockquote>
<p>What streams contain macros in this document? (comma-separated, ascending).</p>
</blockquote>
<p><a href="https://blog.didierstevens.com/programs/oledump-py/">oledump.py</a> is a tool made by <a href="https://blog.didierstevens.com/about/">Didier Stevens</a> that allows the analysis of data streams found in OLE files such as MS Office documetns. Running the command below would show us which streams have macros in it. These are denoted with the character <em>M</em>.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>oledump.py sample.bin
<span class="go">  1:       114 &#39;\x01CompObj&#39;</span>
<span class="go">  2:      4096 &#39;\x05DocumentSummaryInformation&#39;</span>
<span class="go">  3:      4096 &#39;\x05SummaryInformation&#39;</span>
<span class="go">  4:      7119 &#39;1Table&#39;</span>
<span class="go">  5:    101483 &#39;Data&#39;</span>
<span class="go">  6:       581 &#39;Macros/PROJECT&#39;</span>
<span class="go">  7:       119 &#39;Macros/PROJECTwm&#39;</span>
<span class="go">  8:     12997 &#39;Macros/VBA/_VBA_PROJECT&#39;</span>
<span class="go">  9:      2112 &#39;Macros/VBA/__SRP_0&#39;</span>
<span class="go"> 10:       190 &#39;Macros/VBA/__SRP_1&#39;</span>
<span class="go"> 11:       532 &#39;Macros/VBA/__SRP_2&#39;</span>
<span class="go"> 12:       156 &#39;Macros/VBA/__SRP_3&#39;</span>
<span class="go"> 13: M    1367 &#39;Macros/VBA/diakzouxchouz&#39;</span>
<span class="go"> 14:       908 &#39;Macros/VBA/dir&#39;</span>
<span class="go"> 15: M    5705 &#39;Macros/VBA/govwiahtoozfaid&#39;</span>
<span class="go"> 16: m    1187 &#39;Macros/VBA/roubhaol&#39;</span>
<span class="go"> 17:        97 &#39;Macros/roubhaol/\x01CompObj&#39;</span>
<span class="go"> ...</span>
</code></pre></div>

<p>I later noticed that there is an upper-case and lower-case <em>M</em>. I learned that the upper-case <em>M</em> denotes a macro with a code. The lower-case denotes a user form. This is a distinction that will be important later in this challenge.</p>
<hr />
<blockquote>
<p>What command-line argument with Oledump do you use to view the raw content of a stream? (Do not include the leading dash) </p>
</blockquote>
<p>The next question is another easy one which ran easily be solved through <code>oledump.py</code>'s <em>--help</em> parameter.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>oledump.py --help
<span class="go">Usage: oledump.py [options] [file]</span>
<span class="go">Analyze OLE files (Compound Binary Files)</span>

<span class="go">Options:</span>
<span class="go">  --version             show program&#39;s version number and exit</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -m, --man             Print manual</span>
<span class="go">  -s SELECT, --select=SELECT</span>
<span class="go">                        select item nr for dumping (a for all)</span>
<span class="go">  -d, --dump            perform dump</span>
<span class="go">  -x, --hexdump         perform hex dump</span>
<span class="go">  -a, --asciidump       perform ascii dump</span>
<span class="go">  -A, --asciidumprle    perform ascii dump with RLE</span>
<span class="go">  -S, --strings         perform strings dump</span>
<span class="go">  -T, --headtail        do head &amp; tail</span>
<span class="go">  -v, --vbadecompress   VBA decompression</span>
<span class="go">  ...</span>
</code></pre></div>

<p>The answer to question number two is easy to spot.</p>
<hr />
<blockquote>
<p>What event is used to begin the execution of the macros?  </p>
</blockquote>
<p>I used a different tool for this particular question mostly because I knew that it already shows the information I need to answer the question. The tool is called <code>olevba</code> which is part of the <a href="https://github.com/decalage2/oletools">oletools</a> package of Python tools. <em>Olevba</em> is used for extracting and analyzing VBA macro source code for MS Office documents.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>olevba sample.bin
<span class="go">+----------+--------------------+---------------------------------------------+</span>
<span class="go">|Type      |Keyword             |Description                                  |</span>
<span class="go">+----------+--------------------+---------------------------------------------+</span>
<span class="go">|AutoExec  |Document_open       |Runs when the Word or Publisher document is  |</span>
<span class="go">|          |                    |opened                                       |</span>
<span class="go">|Suspicious|Create              |May execute file or a system command through |</span>
<span class="go">|          |                    |WMI                                          |</span>
<span class="go">|Suspicious|showwindow          |May hide the application                     |</span>
<span class="go">|Suspicious|CreateObject        |May create an OLE object                     |</span>
<span class="go">...</span>
</code></pre></div>

<h2 id="onto-the-main-event">Onto the main event</h2>
<blockquote>
<p>What malware family was this maldoc attempting to drop?</p>
</blockquote>
<p>I figured that the way for me to determine the answer for the question above is to start investigating the macro codes included in the document.</p>
<p>I knew from the previous question that the entry point to begin the execution of the macros is with the function <code>Document_open()</code>. The next step is to look for this entry point and go through the code to understand what the macro is doing.</p>
<p>To view the contents of a stream, I used the command below:</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>oledump.py sample.bin -s <span class="m">13</span> -v
<span class="go">Attribute VB_Name = &quot;diakzouxchouz&quot;</span>
<span class="go">Attribute VB_Base = &quot;1Normal.ThisDocument&quot;</span>
<span class="go">Attribute VB_GlobalNameSpace = False</span>
<span class="go">Attribute VB_Creatable = False</span>
<span class="go">Attribute VB_PredeclaredId = True</span>
<span class="go">Attribute VB_Exposed = True</span>
<span class="go">Attribute VB_TemplateDerived = True</span>
<span class="go">Attribute VB_Customizable = True</span>
<span class="go">Private Sub _</span>
<span class="go">Document_open()</span>
<span class="go">boaxvoebxiotqueb</span>
<span class="go">End Sub</span>
</code></pre></div>

<p>In the above output, I saw that <code>Document_open()</code> contains a single line of code which is a call to function <code>boaxvoebxiotqueb'</code>. This function is included in stream <code>15</code> which can be viewed with the command:</p>
<div class="codehilite"><pre><span></span><code>$ oledump.py sample.bin -s <span class="m">13</span> -v
Attribute <span class="nv">VB_Name</span> <span class="o">=</span> <span class="s2">&quot;govwiahtoozfaid&quot;</span>
Function boaxvoebxiotqueb<span class="o">()</span>
<span class="nv">gooykadheoj</span> <span class="o">=</span> Chr<span class="o">(</span>roubhaol.Zoom + Int<span class="o">(</span><span class="m">5</span> * <span class="m">3</span><span class="o">))</span>
Dim c7�ATOQe2�j As Integer
c7�ATOQe2�j <span class="o">=</span> <span class="m">6</span>
Do While c7�ATOQe2�j &lt; <span class="m">6</span> + <span class="m">2</span>
c7�ATOQe2�j <span class="o">=</span> c7�ATOQe2�j + <span class="m">5</span>: DoEvents
Loop
<span class="nv">haothkoebtheil</span> <span class="o">=</span> <span class="s2">&quot;2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqw2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqin2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqm2342772g3&amp;*gs7712ffvs626fqgm2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqt2342772g3&amp;*gs7712ffvs626fq&quot;</span> + gooykadheoj + <span class="s2">&quot;2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fq:w2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqin2342772g3&amp;*gs7712ffvs626fq322342772g3&amp;*gs7712ffvs626fq_2342772g3&amp;*gs7712ffvs626fq&quot;</span> + roubhaol.joefwoefcheaw + <span class="s2">&quot;2342772g3&amp;*gs7712ffvs626fqr2342772g3&amp;*gs7712ffvs626fqo2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqc2342772g3&amp;*gs7712ffvs626fqes2342772g3&amp;*gs7712ffvs626fqs2342772g3&amp;*gs7712ffvs626fq&quot;</span>
...
</code></pre></div>

<p>The above output contains more lines of what looks like gibberish code. Upon further inspection I realized that it's actually obfuscated. I can see common coding patterns which tells me that I could make sense of the code if I step through it and organize it so it is easy to understand.</p>
<p>The first line of the <code>boaxvoebxiotqueb</code> shows:</p>
<div class="codehilite"><pre><span></span><code>gooykadheoj = Chr(roubhaol.Zoom + Int(5 * 3))
</code></pre></div>

<p>What's <code>roubhaol</code>? Since this is the first line in the function, I know that it is not a locally defined variable. It must be declared somplace else.</p>
<p>After looking around I learned that <code>roubhaol</code> is a the name of the user form at stream <em>16</em>.</p>
<div class="codehilite"><pre><span></span><code><span class="go">16: m    1187 &#39;Macros/VBA/roubhaol&#39;</span>
</code></pre></div>

<p>So the next step is figuring out what <code>roubhaol.Zoom</code>'s value is. This value is not set anywhere in any of the macros by code. This means that the value is set in the form itself. To confirm, I opened up the Word document, pressed <code>Alt+F11</code> to open up the Visual Basic editor and then opened the <code>roubhaol</code> form. At the bottom we see that the value of <code>Zoom</code> is set to <code>100</code>.</p>
<p><img alt="maldoc101-writeup-01" src="./images/maldoc101-writeup-01.png" /></p>
<p>This means that by simulating the first line of code again we find that the variable <code>gooykadheoj</code> gets the character value of <code>s</code>.</p>
<div class="codehilite"><pre><span></span><code>gooykadheoj = Chr(roubhaol.Zoom + Int(5 * 3))
gooykadheoj = Chr(100 + Int(5 * 3))
gooykadheoj = Chr(115)
gooykadheoj = Chr(115) # character &quot;s&quot;
</code></pre></div>

<p>I then proceeded to go through the next set of lines.</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Dim</span> <span class="nv">c7</span>�<span class="nv">ATOQe2</span>�<span class="nv">j</span> <span class="nv">As</span> <span class="nv">Integer</span>
<span class="nv">c7</span>�<span class="nv">ATOQe2</span>�<span class="nv">j</span> <span class="o">=</span> <span class="mi">6</span>
<span class="k">Do</span> <span class="k">While</span> <span class="nv">c7</span>�<span class="nv">ATOQe2</span>�<span class="nv">j</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">2</span>
<span class="nv">c7</span>�<span class="nv">ATOQe2</span>�<span class="nv">j</span> <span class="o">=</span> <span class="nv">c7</span>�<span class="nv">ATOQe2</span>�<span class="nv">j</span> <span class="o">+</span> <span class="mi">5</span>: <span class="nv">DoEvents</span>
<span class="k">Loop</span>
</code></pre></div>

<p>This one is easier to simulate. <code>c7�ATOQe2�j</code> is assigend 6. And then there's a loop that adds <code>5</code> that eventually results to the value of <code>16</code>.</p>
<p>But wait, something is fishy here. The variable <code>c7�ATOQe2�j</code> is not found anywhere else after the block of code above. This tells us that this is just junk code that does not really do anything aside from waste an analyst's time! Sneaky sneaky.</p>
<p>To save me the time I proceeded to remove all junk code. I did this by going through each variables and seeing if they are used somewhere useful. If not, then they are safe to remove.</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Attribute</span> <span class="nv">VB_Name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">govwiahtoozfaid</span><span class="s2">&quot;</span>
<span class="nv">Function</span> <span class="nv">boaxvoebxiotqueb</span><span class="ss">()</span>
    <span class="nv">gooykadheoj</span> <span class="o">=</span> <span class="nv">Chr</span><span class="ss">(</span><span class="nv">roubhaol</span>.<span class="nv">Zoom</span> <span class="o">+</span> <span class="nv">Int</span><span class="ss">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">3</span><span class="ss">))</span>

    <span class="nv">haothkoebtheil</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqw2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqin2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqm2342772g3&amp;*gs7712ffvs626fqgm2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqt2342772g3&amp;*gs7712ffvs626fq</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nv">gooykadheoj</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="s">2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fq:w2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqin2342772g3&amp;*gs7712ffvs626fq322342772g3&amp;*gs7712ffvs626fq_2342772g3&amp;*gs7712ffvs626fq</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nv">roubhaol</span>.<span class="nv">joefwoefcheaw</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="s">2342772g3&amp;*gs7712ffvs626fqr2342772g3&amp;*gs7712ffvs626fqo2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqc2342772g3&amp;*gs7712ffvs626fqes2342772g3&amp;*gs7712ffvs626fqs2342772g3&amp;*gs7712ffvs626fq</span><span class="s2">&quot;</span>

    <span class="nv">deulsaocthuul</span> <span class="o">=</span> <span class="nv">juuvzouchmiopxeox</span><span class="ss">(</span><span class="nv">haothkoebtheil</span><span class="ss">)</span>

    <span class="nv">Set</span> <span class="nv">tiajriokchaoy</span> <span class="o">=</span> <span class="nv">CreateObject</span><span class="ss">(</span><span class="nv">deulsaocthuul</span><span class="ss">)</span>

    <span class="nv">deaknaugthein</span> <span class="o">=</span> <span class="nv">roubhaol</span>.<span class="nv">kaizseah</span>.<span class="nv">ControlTipText</span>
    <span class="nv">giakfeiw</span> <span class="o">=</span> <span class="nv">deulsaocthuul</span> <span class="o">+</span> <span class="nv">gooykadheoj</span> <span class="o">+</span> <span class="nv">roubhaol</span>.<span class="nv">paerwagyouqumeid</span>.<span class="nv">ControlTipText</span> <span class="o">+</span> <span class="nv">deaknaugthein</span>
    <span class="nv">queegthaen</span> <span class="o">=</span> <span class="nv">giakfeiw</span> <span class="o">+</span> <span class="nv">roubhaol</span>.<span class="nv">joefwoefcheaw</span>

    <span class="nv">Set</span> <span class="nv">deavjoajsear</span> <span class="o">=</span> <span class="nv">luumlaud</span><span class="ss">(</span><span class="nv">queegthaen</span><span class="ss">)</span>

    <span class="nv">xve</span> <span class="o">=</span> <span class="nv">Array</span> <span class="nv">_</span>
        <span class="ss">(</span><span class="s2">&quot;</span><span class="s">1234444123</span><span class="s2">&quot;</span>, <span class="nv">tiajriokchaoy</span>. <span class="nv">_</span>
        <span class="nv">Create</span><span class="ss">(</span><span class="nv">geulgelquuuj</span>, <span class="nv">kaenhaig</span>, <span class="nv">deavjoajsear</span><span class="ss">)</span>, <span class="s2">&quot;</span><span class="s">9938723</span><span class="s2">&quot;</span><span class="ss">)</span>
<span class="k">End</span> <span class="nv">Function</span>

<span class="nv">Function</span> <span class="nv">juuvzouchmiopxeox</span><span class="ss">(</span><span class="nv">yiajthoavheiw</span><span class="ss">)</span>
    <span class="nv">geutyoeytiestheug</span> <span class="o">=</span> <span class="nv">yiajthoavheiw</span>
    <span class="nv">feaxgeip</span> <span class="o">=</span> <span class="nv">Split</span><span class="ss">(</span><span class="nv">geutyoeytiestheug</span>, <span class="s2">&quot;</span><span class="s">2342772g3&amp;*gs7712ffvs626fq</span><span class="s2">&quot;</span><span class="ss">)</span>

    <span class="nv">jaquhoiqu</span> <span class="o">=</span> <span class="nv">csqw</span> <span class="o">+</span> <span class="nv">Join</span><span class="ss">(</span><span class="nv">feaxgeip</span>, <span class="nv">eihnx</span><span class="ss">)</span>
    <span class="nv">juuvzouchmiopxeox</span> <span class="o">=</span> <span class="nv">jaquhoiqu</span>
<span class="k">End</span> <span class="nv">Function</span>

<span class="nv">Function</span> <span class="nv">geulgelquuuj</span><span class="ss">()</span>
    <span class="nv">sjiqw</span> <span class="o">=</span> <span class="nv">roubhaol</span>.<span class="nv">gaoddaicsauktheb</span>.<span class="nv">Pages</span><span class="ss">(</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">10</span><span class="ss">)</span>.<span class="nv">ControlTipText</span>
    <span class="nv">geulgelquuuj</span> <span class="o">=</span> <span class="nv">juuvzouchmiopxeox</span><span class="ss">(</span><span class="nv">sjiqw</span><span class="ss">)</span>
<span class="k">End</span> <span class="nv">Function</span>

<span class="nv">Function</span> <span class="nv">luumlaud</span><span class="ss">(</span><span class="nv">zeolkaepxoag</span><span class="ss">)</span>
    <span class="nv">Set</span> <span class="nv">luumlaud</span> <span class="o">=</span> <span class="nv">CreateObject</span><span class="ss">(</span><span class="nv">zeolkaepxoag</span><span class="ss">)</span>
    <span class="nv">Dim</span> <span class="nv">vPu</span> <span class="nv">As</span> <span class="nv">String</span>
    <span class="nv">vPu</span> <span class="o">=</span> <span class="nv">Replace</span>$<span class="ss">(</span><span class="s2">&quot;</span><span class="s">BenqV1�igVwifwdQq</span><span class="s2">&quot;</span>, <span class="s2">&quot;</span><span class="s">BenqV1�i</span><span class="s2">&quot;</span>, <span class="s2">&quot;</span><span class="s">on5�</span><span class="s2">&quot;</span><span class="ss">)</span>
        <span class="nv">luumlaud</span> <span class="nv">_</span>
        . <span class="nv">_</span>
        <span class="nv">showwindow</span> <span class="o">=</span> <span class="ss">(</span><span class="nv">mujgoiy</span> <span class="o">+</span> <span class="nv">jioyseertioch</span><span class="ss">)</span> <span class="o">+</span> <span class="ss">(</span><span class="nv">neivberziok</span> <span class="o">+</span> <span class="nv">xuajroegquoudcaij</span><span class="ss">)</span>
<span class="k">End</span> <span class="nv">Function</span>
</code></pre></div>

<p>As you can see above, the code is shorter. It's also a little easier to understand. Only a little though, we still need to step through the code carefully to have a better grasp of what it is doing.</p>
<p>Let's take on the next line:</p>
<div class="codehilite"><pre><span></span><code>haothkoebtheil = &quot;2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqw2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqin2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqm2342772g3&amp;*gs7712ffvs626fqgm2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqt2342772g3&amp;*gs7712ffvs626fq&quot; + gooykadheoj + &quot;2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fq:w2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqin2342772g3&amp;*gs7712ffvs626fq322342772g3&amp;*gs7712ffvs626fq_2342772g3&amp;*gs7712ffvs626fq&quot; + roubhaol.joefwoefcheaw + &quot;2342772g3&amp;*gs7712ffvs626fqr2342772g3&amp;*gs7712ffvs626fqo2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqc2342772g3&amp;*gs7712ffvs626fqes2342772g3&amp;*gs7712ffvs626fqs2342772g3&amp;*gs7712ffvs626fq&quot;
</code></pre></div>

<p>If we look at the string carefully we would notice that a set of strings is concatenated with two variables. These variables are <code>gooykadheoj</code> and <code>roubhaol.joefwoefcheaw</code>. We already know the value of <code>gooykadheoj</code>. So what's the value of <code>roubhaol.joefwoefcheaw</code>?</p>
<p>I got this value by going back to Visual Basic Editor and selelecting <code>joefwoefcheaw</code>. The value we need is listed under <code>Text</code>.</p>
<p><img alt="maldoc101-writeup-02" src="./images/maldoc101-writeup-02.png" /></p>
<p>Substituting the values <code>s</code> and <code>P</code> I got the following:</p>
<div class="codehilite"><pre><span></span><code>haothkoebtheil = &quot;2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqw2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqin2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqm2342772g3&amp;*gs7712ffvs626fqgm2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqt2342772g3&amp;*gs7712ffvs626fqs2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fq:w2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqin2342772g3&amp;*gs7712ffvs626fq322342772g3&amp;*gs7712ffvs626fq_2342772g3&amp;*gs7712ffvs626fqP2342772g3&amp;*gs7712ffvs626fqr2342772g3&amp;*gs7712ffvs626fqo2342772g3&amp;*gs7712ffvs626fq2342772g3&amp;*gs7712ffvs626fqc2342772g3&amp;*gs7712ffvs626fqes2342772g3&amp;*gs7712ffvs626fqs2342772g3&amp;*gs7712ffvs626fq&quot;
</code></pre></div>

<p>It still doesn't clear up the gibberish, but at least it's now one big string. This same string is then passed as a parameter to function <code>juuvzouchmiopxeox</code>. </p>
<div class="codehilite"><pre><span></span><code>deulsaocthuul = juuvzouchmiopxeox(haothkoebtheil)
</code></pre></div>

<p>Let's look at the code inside <code>juuvzouchmiopxeox</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Function</span> <span class="nv">juuvzouchmiopxeox</span><span class="ss">(</span><span class="nv">yiajthoavheiw</span><span class="ss">)</span>
    <span class="nv">geutyoeytiestheug</span> <span class="o">=</span> <span class="nv">yiajthoavheiw</span>
    <span class="nv">feaxgeip</span> <span class="o">=</span> <span class="nv">Split</span><span class="ss">(</span><span class="nv">geutyoeytiestheug</span>, <span class="s2">&quot;</span><span class="s">2342772g3&amp;*gs7712ffvs626fq</span><span class="s2">&quot;</span><span class="ss">)</span>

    <span class="nv">jaquhoiqu</span> <span class="o">=</span> <span class="nv">csqw</span> <span class="o">+</span> <span class="nv">Join</span><span class="ss">(</span><span class="nv">feaxgeip</span>, <span class="nv">eihnx</span><span class="ss">)</span>
    <span class="nv">juuvzouchmiopxeox</span> <span class="o">=</span> <span class="nv">jaquhoiqu</span>
<span class="k">End</span> <span class="nv">Function</span>
</code></pre></div>

<p>Following the code we could see that the passed string is splitted using the call to the function <code>Split</code> with the substring <code>2342772g3&amp;*gs7712ffvs626fq</code>. This simply means that the substring is removed from the input string. The result of <code>Split</code> is then joined into one string using <code>Join</code>. There are the variables <code>csqw</code> and <code>eihnx</code>, they don't alter the string as these variables are empty. </p>
<p>At the end of this function the value of the passed string is now:</p>
<div class="codehilite"><pre><span></span><code><span class="n">winmgmts</span><span class="o">:</span><span class="n">win32_Process</span>
</code></pre></div>

<p>Aha! Something that is not gibberish for a change!</p>
<p>Going back to the caller function, the result of <code>juuvzouchmiopxeox</code> is saved to <code>deulsaocthuul</code>.</p>
<div class="codehilite"><pre><span></span><code>    deulsaocthuul = juuvzouchmiopxeox(haothkoebtheil)

    Set tiajriokchaoy = CreateObject(deulsaocthuul)
</code></pre></div>

<p>After that an object is created out of <code>deaulsaocthuul</code>, which we know contains <code>winmgmts:win32_Process</code>. </p>
<p>Looking at <a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-process">the microsoft docs</a> I find out that <code>The Win32_Process WMI class represents a process on an operating system.</code>. Interesting.</p>
<h2 id="taking-a-step-back">Taking a step back</h2>
<p>At this point there are already a number of questions that we could answer based on what we've done so far. Some are not yet answerable at the moment, however, so nothing left to do but to push forward. But that will be for the next part of this two part series.</p>
<p>Until then, I'm taking a step back as I marvel at my progress. It wouldn't take long until all the pieces would fall into place.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./maldoc101-writeup-part-1.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./ioli-crackme-0x02.html">IOLI Crackme 0x02</a></h1>
	<div class="meta">
          <time datetime="2021-03-06T10:34:00+08:00">March 06, 2021</time>
          in <span class="categories">
            <a href="./tag/re.html">re</a>,            <a href="./tag/crackme.html">crackme</a>          </span>
	</div>
        <p><p>I am continuing my reverse engineering review by tackling the <em>IOLI crackmes</em> by <a href="https://twitter.com/pof">@pof</a>. These are beginner friendly challenges that is perfect for newbies or for those who want to review the basics like me. Check out my writeups for <a href="./ioli-crackme-0x00.html">0x00</a> and <a href="./ioli-crackme-0x01.html">0x01</a>.</p>
<h1 id="getting-the-password">Getting the password</h1>
<p>After the first two challenges I kinda know what to expect already so I skipped running the program and immediately loaded it in IDA.</p>
<p><img alt="ioli-crackme-0x02-01" src="./images/ioli-crackme-0x02-01.png" /></p>
<p>So the lines leading to the comparison command now looks more complicated than before. We could easily see that there are some computations that happens thanks to the presence of <code>add</code> and <code>imul</code>. Before those, we have two values (<code>5Ah</code> and <code>1ECh</code>) which we can easily guess are the values that will be worked on by these arithmetic functions.</p>
<p>So going through the lines sequentially we can see that the two numbers are first added with <code>add [eax], edx</code>. Which results in a value of <code>246h</code>.</p>
<p>After that we see the line <code>imul eax, [ebp+var_8]</code>, which if you follow the sequence closely effectively multiplies <code>246h</code> by itself, resulting in a value of <code>52B24h</code>.</p>
<p>Convert <code>52B24h</code> to decimal equates to <code>338724</code>, which is unsprisingly the password that we need.</p>
<p><img alt="ioli-crackme-0x02-02" src="./images/ioli-crackme-0x02-02.png" /></p>
<h1 id="confirming-via-dynamic-analysis">Confirming via dynamic analysis</h1>
<p>What we did above is that we used static analysis to inspect the program line by line to determine the final computed password value. Let's use dynamic analysis and step through the code to see how our data is manipulated in memory during this process.</p>
<p>Let's set a breakpoint immediately after the initial two values are loaded into memory.</p>
<p><img alt="ioli-crackme-0x02-03" src="./images/ioli-crackme-0x02-03.png" /></p>
<p>If we look at the memory locations we would see the following:</p>
<p><img alt="ioli-crackme-0x02-04" src="./images/ioli-crackme-0x02-04.png" /></p>
<p><code>epb+var_8</code> points to <code>28FF40</code> which now contains <code>5Ah</code></p>
<p><code>ebp+var_C</code> points to <code>28FF3C</code> which now contains <code>1ECh</code></p>
<p>Stepping through the code and checking the memory location after <code>add [eax], edx</code> shows that the result <code>246h</code> is saved at memory location <code>28FF40</code>.</p>
<p><img alt="ioli-crackme-0x02-05" src="./images/ioli-crackme-0x02-05.png" /></p>
<p>Then after <code>imul eax, [ebp+var_8]</code> we see that eax now holds the value of <code>52B24h</code>, confirming the final computed value that we had from our static analysis.</p>
<p><img alt="ioli-crackme-0x02-06" src="./images/ioli-crackme-0x02-06.png" /></p>
<h1 id="patching-the-executables">Patching the executables</h1>
<p>Patching the executable is actually the same process as <a href="./ioli-crackme-0x00.html">my writeup for 0x00</a>.</p>
<h1 id="on-to-the-next-challenge">On to the next challenge...</h1>
<p>While the challenge is still easy, we can see that the complexity is slowly ramping up from previous challenges. We also took the time to confirm the result of our static analysis by debugging and stepping through the code. This is a good practice for me to familiarize myself with IDA, which I hope I could use in future challenges.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./ioli-crackme-0x02.html">Read on →</a> -->
      </article>
    </div>
  </div>
  <!-- CONTENT GOES HERE -->
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <article>
        <h1><a href="./introducing-shcode2exe.html">Introducing shcode2exe</a></h1>
	<div class="meta">
          <time datetime="2021-02-26T07:34:00+08:00">February 26, 2021</time>
          in <span class="categories">
            <a href="./tag/re.html">re</a>,            <a href="./tag/tools.html">tools</a>,            <a href="./tag/malware_analysis.html">malware_analysis</a>          </span>
	</div>
        <p><p><strong>[Edit: shcode2exe is <a href="https://docs.remnux.org/discover-the-tools/dynamically+reverse-engineer+code/shellcode#shcode-2-exe">now part of Remnux</a>]</strong></p>
<p>I've been playing around with <a href="https://remnux.org/">Remnux</a> and encountered a problem trying to get one of the tools to run properly. The tool is <a href="https://github.com/repnz/shellcode2exe">shellcode2exe</a>, it is used to compile binary shellcode to a file so it can easily be debugged by a debugger.</p>
<p>When I checked out the code, I was surprised to find out how simple it is. Basically, what happens is that the inputted shellcode is added to a barebones assembly file using the <code>incbin</code> assembly instruction. From there, the file is then automatically compiled and linked.</p>
<p>One big problem with the tool is that it needs to use <a href="https://www.winehq.org/">Wine</a> if it needs to run on Linux. I don't want such a huge dependency especially for my own malware analysis lab so I decided to write my own version which have led to the creation of <code>shcode2exe</code>.</p>
<h2 id="shcode2exe">shcode2exe</h2>
<p>While similar in functionality with the original tool, the biggest improvement I made is that it it does not depend on Wine along with other features as listed below:</p>
<ul>
<li>Can accept a shellcode blob or string (String format <code>\x5e\x31</code>)</li>
<li>Can target both 32bit or 64bit Windows architecture. </li>
<li>Cross platform. Works on Linux or Windows.</li>
<li>No dependency on Wine when running on Linux</li>
<li>Tested working with Python v3.3 and above</li>
<li>Tested working on Windows 7 (Non SP1) and above</li>
</ul>
<h2 id="usage">Usage</h2>
<p>Here's the help message for the tool:</p>
<div class="codehilite"><pre><span></span><code><span class="go">usage: shcode2exe.py [-h] [-o OUTPUT] [-s] [-a {32,64}] input</span>

<span class="go">Compile a binary shellcode blob into an exe file. Can target both 32bit or 64bit architecture.</span>

<span class="go">positional arguments:</span>
<span class="go">  input                 The input file containing the shellcode.</span>

<span class="go">optional arguments:</span>
<span class="go">  -h, --help            show this help message and exit</span>
<span class="go">  -o OUTPUT, --output OUTPUT</span>
<span class="go">                        Set output exe file.</span>
<span class="go">  -s, --string          Set if input file contains shellcode in string format.</span>
<span class="go">  -a {32,64}, --architecture {32,64}</span>
<span class="go">                        The windows architecture to use</span>
</code></pre></div>

<p>Here's how to load a file with shellcode in the format of a string</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>cat test.txt
<span class="go">\x5e\x31\xc0\xb0\x24\xcd\x80\xb0\x24\xcd\x80\xb0\x58\xbb\xad\xde\xe1\xfe\xb9\x69\x19\x12\x28\xba\x67\x45\x23\x01\xcd\x80</span>
<span class="gp">$ </span>./shcode2exe.py -s -o test-string.exe test.bin
</code></pre></div>

<p>Load a file with shellcode in the format of a blob</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>./shcode2exe.py -o test-blob.exe test.bin
</code></pre></div>

<p>Use 64 bit architecture for the output (32 bit is the default)</p>
<div class="codehilite"><pre><span></span><code><span class="gp">$ </span>./shcode2exe.py -o test-blob.exe -a <span class="m">64</span> test.bin
<span class="gp">$ </span>file test-blob.exe
<span class="go">test-blob.exe: PE32+ executable (console) x86-64 (stripped to external PDB), for MS Windows</span>
</code></pre></div>

<h2 id="next-steps">Next steps</h2>
<p>I decided to reach out to the people behind Remnux to ask if they could consider my tool as a replacement on their platform. It would be great if they would, but it's okay too if they don't, I made it for my own use anyway. (Update 2021-02-07: It's now <a href="https://github.com/REMnux/salt-states/issues/169">under review</a>)</p>
<p>For more information about the tool and it's code, go to <a href="https://github.com/accidentalrebel/shcode2exe">it's Github page</a>. If you have any comments or suggestions on how to improve it, feel free to tell me via Github issues or dm me at <a href="https://twitter.com/accidentalrebel">@accidentalrebel</a>.</p>
          <!-- <a class="full-article-link pull-right" rel="full-article" href="./introducing-shcode2exe.html">Read on →</a> -->
      </article>
    </div>
  </div>
</div>
<div class="pagination">
<p class="paginator">
    Page 1 / 3
        <a href="./index2.html">&raquo;</a>
        <a href="./index3.html">&#8649;</a>
</p>
</div>
    <footer id="footer" class="her-row">
      <div class="container">
        <div class="row">
          <h4>Powered by <a href="http://blog.getpelican.com/">Pelican</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
        </div>
      </div>
    </footer>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55068085-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-55068085-2');
    </script>
  </body>
</html>