<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>String anti-virus evasion in x64 assembly (Part 2)</title>
  <meta name="author" content="AccidentalRebel">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="String anti-virus evasion in x64 assembly (Part 2) July 09, 2022 in evasion,assembly,av">

  <link rel="canonical" href="./string-av-evasion-in-x64-assembly-part-2.html">

  <link href="./favicon.png" rel="icon">

  <link href="https://www.accidentalrebel.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="AccidentalRebel.com Full Atom Feed" />

  <link href="./theme/css/screen.css"  media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="./theme/css/tomorrow.css"  media="screen, projection" rel="stylesheet" type="text/css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

  
<meta name="twitter:card" content="summary">
<meta property="og:url" content="./string-av-evasion-in-x64-assembly-part-2.html">
<meta name="twitter:site:id" content="https://twitter.com/accidentalrebel">
<meta name="twitter:creator:id" content="accidentalrebel">
<meta property="og:title" content="String anti-virus evasion in x64 assembly (Part 2)">
<meta property="og:description" content="In my last blog post, I discussed a way to hide parameter strings from being detected by an anti-virus. The solution was simple and it worked.">
<meta property="og:image" content="https://www.accidentalrebel.com/images/string-anti-virus-evasion-in-x64-assembly-part-2-07.png">
<meta name="twitter:image:src" content="https://www.accidentalrebel.com/images/string-anti-virus-evasion-in-x64-assembly-part-2-07.png">


</head>
  <body>

    <div class="container" id="site-title">
      <div class="col-md-8 col-md-offset-2">
	<h1>
	  <a href=".">
	    AccidentalRebel.com
	  </a>
	</h1>
	<div id="profile">
	  <div class="left">
	    <img src="./theme/images/pic.png" />
	  </div>
	  <div class="right">
	    Karlo is a programmer for 10+ years who switched to cyber security. He is currently working as a L2 SOC Analyst and is focusing on malware reverse engineering and development.
	  </div>
	  <div class="clear"></div>
	</div>
	<div id="nav">
	  <ul>
	    <li><a href=".">Home</a></li>
	    <!-- <li><a href="./pages/made.html">My Works</a></li> -->
	    <li class="icon-nav" id="twitter-nav"><a href="https://twitter.com/accidentalrebel">Twitter</a></li>
	    <li class="icon-nav" id="github-nav"><a href="https://github.com/accidentalrebel">Github</a></li>
	    <li class="icon-nav" id="feed-nav"><a href="./feeds/all.atom.xml">RSS</a></li>
	  </ul>
	</div>
      </div>
    </div>

  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
	<article>
          <h1><a href="./string-av-evasion-in-x64-assembly-part-2.html">String anti-virus evasion in x64 assembly (Part 2)</a></h1>
          <div class="meta">
            <time datetime="2022-07-09T12:11:00+08:00">July 09, 2022</time>
            in <span class="categories">
              <a href="./tag/evasion.html">evasion</a>,              <a href="./tag/assembly.html">assembly</a>,              <a href="./tag/av.html">av</a>            </span>
          </div>
        <p>In <a href="string-av-evasion-in-x64-assembly-part-1">my last blog post</a>, I discussed a way to hide parameter strings from being detected by an anti-virus. The solution was simple and it worked. However, it was incomplete as strings of function calls and loaded DLLs were still detectable in memory.</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-01" src="./images/string-anti-virus-evasion-in-x64-assembly-part-2-01.png" /></p>
<p>In this post I'll be talking about the other technique from the same <a href="https://blog.scrt.ch/2020/07/15/engineering-antivirus-evasion-part-ii/">blog post</a> we were following before. It does a good job of explaining the concept which I'll be covering here too. I will also be writing the code in assembly as an added bonus, so we can better understand what goes on under the hood.</p>
<h2 id="the-problem">The problem</h2>
<p>Let's revisit our code from the last time. We have two functions being called <code>ShellExecuteA</code> and <code>ExitProcess</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;shellapi.h&gt;</span><span class="cp"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">ShellExecuteA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Upon compiling the program, the compiler takes the list of all functions used and places them in the executable (In this case, in the <code>.rdata</code> segment) as a readable string:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-07" src="./images/string-anti-virus-evasion-in-x64-assembly-part-2-07.png" /></p>
<p>A function name like <code>ShellExecuteA</code> will be sure to raise some eyebrows so we do not want it to be detectable. To hide this we need to do load the DLL at runtime by using <code>LoadLibrary</code> and <code>GetProcAddress</code>.</p>
<h2 id="coding-in-c">Coding in C</h2>
<p><code>LoadLibrary</code> accepts a string containing the DLL that we want to load.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">hShell32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s">&quot;shell32.dll&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>This loads the DLL's code into memory and returns a handle to that location. We can see the result of this when we look at the memory map in a debugger. Here's the memory map prior to calling <code>LoadLibrary</code>:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-03" src="./images/string-anti-virus-evasion-in-x64-assembly-part-2-03.png" /></p>
<p>And here's what it looks like after:</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-04" src="./images/string-anti-virus-evasion-in-x64-assembly-part-2-04.png" /></p>
<p>The <code>LoadLibrary</code> API loaded <code>shell32.dll</code> along with it's dependencies into memory. We can also see that it automatically handled where the new DLLs will be placed. In this case, in between pre-existing ones.</p>
<hr />
<h3 id="aside-how-do-we-know-which-dll-is-needed">Aside: How do we know which DLL is needed?</h3>
<blockquote>
<p>We can find out which DLL is needed by a function by looking at it's <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya">MSDN documentation</a>. Scroll at the end of every function documentation to see the "Requirements" section that lists the DLL that it needs.</p>
</blockquote>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-02" src="./images/string-anti-virus-evasion-in-x64-assembly-part-2-02.png" /></p>
<hr />
<p><code>LoadLibrary</code> then returns a <code>HANDLE</code> object which we can then pass to <code>GetProcAddress</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">_ShellExecuteA</span><span class="w"> </span><span class="n">fShellExecuteA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hShell32</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ShellExecuteA&quot;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p><code>GetProcAddress</code> looks through the library we loaded and returns the address of the <code>ShellExecuteA</code> function. This address needs to be cast to a typedef first before it can be called. This means we need to know the structure of the typedef, which we can determine by looking at the "Syntax" section in MSDN.</p>
<p>Here's the syntax for <code>ShellExecuteA</code> according to <a href="https://docs.microsoft.com/en-us/windows/win32/api/shellapi/nf-shellapi-shellexecutea">its documentation</a>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">HINSTANCE</span><span class="w"> </span><span class="nf">ShellExecuteA</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">HWND</span><span class="w">   </span><span class="n">hwnd</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpOperation</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">           </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpFile</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpParameters</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="p">]</span><span class="w"> </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpDirectory</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">[</span><span class="n">in</span><span class="p">]</span><span class="w">           </span><span class="n">INT</span><span class="w">    </span><span class="n">nShowCmd</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>And here's our typedef implementation:</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="n">HINSTANCE</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">HWND</span><span class="w">   </span><span class="n">hwnd</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpOperation</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpFile</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpParameters</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpDirectory</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">INT</span><span class="w">    </span><span class="n">nShowCmd</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>When everything is setup properly, the variable <code>fShellExecuteA</code> can now be used as a function.</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">fShellExecuteA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>Combining these together, this is what our code will look like:</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>

<span class="k">typedef</span><span class="w"> </span><span class="n">HINSTANCE</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">HWND</span><span class="w">   </span><span class="n">hwnd</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpOperation</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpFile</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpParameters</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LPCSTR</span><span class="w"> </span><span class="n">lpDirectory</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">INT</span><span class="w">    </span><span class="n">nShowCmd</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">hShell32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadLibrary</span><span class="p">(</span><span class="s">&quot;shell32.dll&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">_ShellExecuteA</span><span class="w"> </span><span class="n">fShellExecuteA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hShell32</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ShellExecuteA&quot;</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;n&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">fShellExecuteA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;open&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ca_notepad</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">SW_SHOW</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">ExitProcess</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>This is not yet done, however, as <code>strings.exe</code> can still detect our strings. This is because we now have strings "shell32.dll" and "ShellExecuteA" as parameters for <code>LoadLibrary</code> and <code>GetProcAddress</code>. And these are placed in the <code>.data</code> segment in memory.</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-05" src="./images/string-anti-virus-evasion-in-x64-assembly-part-2-05.png" /></p>
<p>This is where we can use the technique that we used in <a href="string-av-evasion-in-x64-assembly-part-1">part 1</a>. By declaring the string as an array as a local variable, the data is placed on the stack instead of in the <code>.data</code> segment. </p>
<p>Applying this technique gives us the following:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_shell32</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;s&#39;</span><span class="p">,</span><span class="sc">&#39;h&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;3&#39;</span><span class="p">,</span><span class="sc">&#39;2&#39;</span><span class="p">,</span><span class="sc">&#39;.&#39;</span><span class="p">,</span><span class="sc">&#39;d&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">hShell32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">ca_shell32</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">ca_shellExA</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="sc">&#39;S&#39;</span><span class="p">,</span><span class="sc">&#39;h&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;E&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;c&#39;</span><span class="p">,</span><span class="sc">&#39;u&#39;</span><span class="p">,</span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">_ShellExecuteA</span><span class="w"> </span><span class="n">fShellExecuteA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_ShellExecuteA</span><span class="p">)</span><span class="w"> </span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hShell32</span><span class="p">,</span><span class="w"> </span><span class="n">ca_shellExA</span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>And now we can see that it works!</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-06" src="./images/string-anti-virus-evasion-in-x64-assembly-part-2-06.png" /></p>
<h2 id="converting-to-assembly">Converting to assembly</h2>
<p>As promised, we'll be converting the code above into x64 windows assembly. It's an extra step, but can give us a better understanding by approaching it from a different programming language.</p>
<p>Starting from the beginning, we'll be using <code>LoadLibraryA</code> and <code>GetProcAddress</code> to dynamically load the <code>ShellExecuteA</code> function at runtime. </p>
<p>If we fast forward a bit, here's what we'll end up with:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">str_shell32</span><span class="p">]</span><span class="w">     </span><span class="c1">; Load &quot;shell32.dll&quot; string</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">LoadLibraryA</span><span class="w">       </span><span class="c1">; Call &quot;LoadLibraryA&quot;</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w">               </span><span class="c1">; Save result of LoadLibraryA to rcx</span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">str_shexa</span><span class="p">]</span><span class="w">       </span><span class="c1">; Load &quot;ShellExecuteA&quot; string</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">GetProcAddress</span><span class="w">     </span><span class="c1">; Call &quot;GetProcAddress&quot;</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rbx</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w">               </span><span class="c1">; The address of &quot;ShellExecuteA&quot; is saved to rbx</span>
<span class="w">    </span><span class="na">...</span><span class="w">                        </span>
<span class="w">    </span><span class="no">...</span><span class="w"> </span>
<span class="w">    </span><span class="no">call</span><span class="w">    </span><span class="no">rbx</span><span class="w">                </span><span class="c1">; Call &quot;ShellExeecuteA&quot;</span>
</code></pre></div>

<p>Wait, that's it? Yes! </p>
<p>This is the one of those rare moments that the Assembly code is more straightforward than C. This is because the value returned by <code>GetProcAddresss</code> is already an address. Since assembly deals with memory addresses, there's no need for any conversion like we did in the C version. The address can be called directly.</p>
<p>And just like the previous one, the code above is still not complete. The "shell" strings are still visible via <code>strings.exe</code> so we need to apply the technique again from Part 1. I won't be showing it step by step here anymore as it's quite lengthy.</p>
<p>This means that this example piece of code:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">str_shell32</span><span class="p">]</span><span class="w">     </span><span class="c1">; Load &quot;shell32.dll&quot; string</span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">LoadLibraryA</span><span class="w">       </span><span class="c1">; Call &quot;LoadLibraryA&quot;</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
</code></pre></div>

<p>Will now be like this:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">          </span><span class="c1">; Place &quot;shell32.dll&quot; string to the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">s</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="mi">3</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="mi">2</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="p">.</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span><span class="w"> </span>
<span class="w">    </span><span class="no">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">LoadLibraryA</span><span class="w"> </span><span class="c1">; Call &quot;LoadLibraryA&quot;</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
</code></pre></div>

<p><code>addstr2stack</code> is a macro we've written before <a href="string-av-evasion-in-x64-assembly-part-1">in part 1</a>. It makes declaring an string array easier.</p>
<p>Combining everything again, here's the final assembly code with comments:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="no">rbp</span><span class="w"></span>
<span class="w">    </span><span class="nf">mov</span><span class="w">     </span><span class="no">rbp</span><span class="p">,</span><span class="w"> </span><span class="no">rsp</span><span class="w"></span>
<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>

<span class="w">    </span><span class="c1">;; = START LOADLIBRARY ===========================================</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Place &quot;shell32.dll&quot; string to the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">s</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="mi">3</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="mi">2</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="p">.</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span><span class="w"> </span>
<span class="w">    </span><span class="no">lea</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">LoadLibraryA</span><span class="w"> </span><span class="c1">; Call LoadLibraryA</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>

<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Release &quot;shell32.dll&quot; string from stack</span>

<span class="w">    </span><span class="c1">;; = END LOADLIBRARY ===========================================</span>


<span class="w">    </span><span class="c1">;; = START GETPROCADDRESS ===========================================</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w">        </span><span class="c1">; Save value to rcx (1st parameter register)</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Place &quot;ShellExecuteA&quot; string to the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">S</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">h</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">l</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">E</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">x</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">c</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">u</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">A</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">GetProcAddress</span><span class="w">  </span><span class="c1">; Call GetProcAddress</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>

<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Release &quot;ShellExecuteA&quot; from stack</span>

<span class="w">    </span><span class="c1">;; = END GETPROCADDRESS ===========================================</span>


<span class="w">    </span><span class="c1">;; = START SHELLEXECUTEA ===========================================</span>

<span class="w">    </span><span class="nf">mov</span><span class="w"> </span><span class="no">r12</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w">        </span><span class="c1">; Save address of &quot;ShellExecuteA&quot; to r12 (To be called later)</span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Place &quot;notepad&quot; string to the stack</span>
<span class="w">    </span><span class="nf">addstr2stack</span><span class="w"> </span><span class="err">&quot;</span><span class="no">n</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">o</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">t</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">e</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">p</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">&quot;</span><span class="no">d</span><span class="err">&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0x0</span><span class="w"></span>
<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">r8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x5</span><span class="w"></span>
<span class="w">    </span><span class="nf">push</span><span class="w">    </span><span class="mi">0x0</span><span class="w"></span>
<span class="w">    </span><span class="nf">xor</span><span class="w"> </span><span class="no">r9</span><span class="p">,</span><span class="w"> </span><span class="no">r9</span><span class="w"></span>

<span class="w">    </span><span class="nf">lea</span><span class="w"> </span><span class="no">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">msg_open</span><span class="p">]</span><span class="w"> </span>
<span class="w">    </span><span class="no">xor</span><span class="w"> </span><span class="no">rcx</span><span class="p">,</span><span class="w"> </span><span class="no">rcx</span><span class="w"></span>

<span class="w">    </span><span class="nf">sub</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">r12</span><span class="w">         </span><span class="c1">; Call &quot;ShellExecuteA&quot;, jump to addres</span>
<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>

<span class="w">    </span><span class="nf">add</span><span class="w"> </span><span class="no">rsp</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="c1">; Release &quot;notepad&quot; string from stack</span>

<span class="w">    </span><span class="c1">;; = END SHELLEXECUTEA ===========================================</span>

<span class="w">    </span><span class="nf">xor</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">    </span><span class="nf">call</span><span class="w">    </span><span class="no">ExitProcess</span><span class="w"></span>
</code></pre></div>

<p>I know there's a lot to digest with the code above. I've made the flow similar to the flow of the C program so you can review them side by side if you feel lost. Hopefully, the comments and the separators would also help.</p>
<blockquote>
<p><strong>Note:</strong> Pay special attention to how the stack is reserved (with <code>sub rsp, 16</code>) and released (with <code>add rsp, 16</code>). I did not discuss stack alignments as it's a lengthy explanation in itself. But just remember that we are releasing the data once we've finished passing it to the function.</p>
</blockquote>
<p>If done correctly, the strings would not be detectable because the data is now on the stack and not in the <code>.data</code> segment.</p>
<p><img alt="string-anti-virus-evasion-in-x64-assembly-part-2-06" src="./images/string-anti-virus-evasion-in-x64-assembly-part-2-06.png" /></p>
<hr />
<p>It is important to note that anti-viruses can employ different techniques to do detection, but a huge part of their functionality will rely on detecting malicious strings. So at least, on that front, we now have an idea on how to defeat it.</p>
<p>You can view the code for part 1 and 2 <a href="https://github.com/accidentalrebel/string-anti-virus-evasion-x64-assembly">on Github</a>. Updates and fixes will be placed there.</p>
<p>I might post more assembly shenanigans in the future, so stay tuned.</p>
<p>And as always, for any questions or comments, feel free to reach out to me on <a href="https://twitter.com/accidentalrebel">Twitter</a> or <a href="https://www.linkedin.com/in/juan-karlo-licudine/">LinkedIn</a>.</p>
        <!-- Disqus goes here -->
        <section>
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite">Disqus goes here</div>
	  <script>
	    /**
	     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
	    /*
	     var disqus_config = function () {
	     this.page.url = AccidentalRebel;  // Replace PAGE_URL with your page's canonical URL variable
	     this.page.identifier = string-av-evasion-in-x64-assembly-part-2.html; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	     };
	    */
	    (function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = 'https://accidentalrebel.disqus.com//embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	    })();
	  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </section>
	</article>
      </div>
    </div>
  </div>
    <footer id="footer" class="her-row">
      <div class="container">
        <div class="row">
          <h4>Powered by <a href="http://blog.getpelican.com/">Pelican</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
        </div>
      </div>
    </footer>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55068085-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-55068085-2');
    </script>
  </body>
</html>