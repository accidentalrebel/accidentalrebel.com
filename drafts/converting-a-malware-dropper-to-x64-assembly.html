<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Converting a malware dropper to x64 assembly</title>
  <meta name="author" content="AccidentalRebel">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="description" content="Converting a malware dropper to x64 assembly July 03, 2022 in malware,assembly,reverse-engineering">

  <link rel="canonical" href="https://www.accidentalrebel.com/drafts/converting-a-malware-dropper-to-x64-assembly.html">

  <link href="https://www.accidentalrebel.com/favicon.png" rel="icon">


  <link href="https://www.accidentalrebel.com/theme/css/screen.css"  media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="https://www.accidentalrebel.com/theme/css/tomorrow.css"  media="screen, projection" rel="stylesheet" type="text/css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

  
<meta name="twitter:card" content="summary">
<meta property="og:url" content="https://www.accidentalrebel.com/drafts/converting-a-malware-dropper-to-x64-assembly.html">
<meta name="twitter:site:id" content="https://twitter.com/accidentalrebel">
<meta name="twitter:creator:id" content="accidentalrebel">
<meta property="og:title" content="Converting a malware dropper to x64 assembly">
<meta property="og:description" content="In this post I'll be converting a simple malware dropper written in C to x64 assembly. The purpose is to show how different sections of C code can be written in assembly. Although impractical, I fo">
<meta property="og:image" content="https://www.accidentalrebel.com/theme/images/share.png">
<meta name="twitter:image:src" content="https://www.accidentalrebel.com/theme/images/pic.png">


</head>
  <body>

    <div class="container" id="site-title">
      <div class="col-md-8 col-md-offset-2">
	<h1>
	  <a href="https://www.accidentalrebel.com">
	    AccidentalRebel.com
	  </a>
	</h1>
	<div id="profile">
	  <div class="left">
	    <img src="https://www.accidentalrebel.com/theme/images/pic.png" />
	  </div>
	  <div class="right">
	    My name is Karlo and I'm currently employed as a Cyber Security Engineer. I have an interest in threat hunting and malware analysis. I also work on cyber-security related programming projects like malware analysis tools and remote access tools.
	  </div>
	  <div class="clear"></div>
	</div>
	<div id="nav">
	  <ul>
	    <li><a href="https://www.accidentalrebel.com">Home</a></li>
	    <!-- <li><a href="https://www.accidentalrebel.com/pages/made.html">My Works</a></li> -->
	    <li class="icon-nav" id="twitter-nav"><a href="https://twitter.com/accidentalrebel">Twitter</a></li>
	    <li class="icon-nav" id="github-nav"><a href="https://github.com/accidentalrebel">Github</a></li>
	    <li class="icon-nav" id="feed-nav"><a href="./feeds/all.atom.xml">RSS</a></li>
	  </ul>
	</div>
      </div>
    </div>

  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
	<article>
          <h1><a href="https://www.accidentalrebel.com/drafts/converting-a-malware-dropper-to-x64-assembly.html">Converting a malware dropper to x64 assembly</a></h1>
          <div class="meta">
            <time datetime="2022-07-03T09:18:00+08:00">July 03, 2022</time>
            in <span class="categories">
              <a href="https://www.accidentalrebel.com/tag/malware.html">malware</a>,              <a href="https://www.accidentalrebel.com/tag/assembly.html">assembly</a>,              <a href="https://www.accidentalrebel.com/tag/reverse-engineering.html">reverse-engineering</a>            </span>
          </div>
        <p>In this post I'll be converting a simple malware dropper written in C to x64 assembly. The purpose is to show how different sections of C code can be written in assembly. Although impractical, I found that it's a good way to deepen my understanding of assembly to help me improve in malware development and reverse engineering.</p>
<p>And... also because I love coding in assembly and would always find an excuse to use it.</p>
<h2 id="what-to-expect">What to expect</h2>
<p>I'll be breaking down the code into sections and will include my thoughts and the things I've learned. I won't be covering the basics of assembly (<a href="https://sonictk.github.io/asm_tutorial/">this post</a> does a better job of doing that) and will instead focus on the intricacies of Windows x64 assembly development.</p>
<p><strong>Disclaimer:</strong> I am not an expert. I'm just someone who has learned some things and wish to share it to others.</p>
<h2 id="credits">Credits</h2>
<p>The malware dropper that we'll be converting is by <a href="https://twitter.com/sektor7net?lang=en">@reenz0h</a>. I found it at <a href="https://github.com/kymb0/Malware_learns">kymb0's repository</a> and I learned that it's a part of the <a href="https://institute.sektor7.net/">Red Team Operator course by Sektor7</a>. I've read good things about the course and I plan to take it in the future.</p>
<h2 id="the-dropper">The dropper</h2>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>

<span class="cm"> Red Team Operator course code template</span>
<span class="cm"> storing payload in .data section</span>

<span class="cm"> author: reenz0h (twitter: @sektor7net)</span>

<span class="cm">*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="c1">// 4 byte payload</span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">payload</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x90</span><span class="p">,</span><span class="w">       </span><span class="c1">// NOP</span>
<span class="w">    </span><span class="mh">0x90</span><span class="p">,</span><span class="w">       </span><span class="c1">// NOP</span>
<span class="w">    </span><span class="mh">0xcc</span><span class="p">,</span><span class="w">       </span><span class="c1">// INT3</span>
<span class="w">    </span><span class="mh">0xc3</span><span class="w">        </span><span class="c1">// RET</span>
<span class="p">};</span><span class="w"></span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">payload_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">exec_mem</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">BOOL</span><span class="w"> </span><span class="n">rv</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">th</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">oldprotect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Allocate a memory buffer for payload.</span>
<span class="w">    </span><span class="n">exec_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">payload_len</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_COMMIT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MEM_RESERVE</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-20s : 0x%-016p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;payload addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%-20s : 0x%-016p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;exec_mem addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Copy payload to new buffer</span>
<span class="w">    </span><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">payload_len</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Make new buffer as executable</span>
<span class="w">    </span><span class="n">rv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span><span class="w"> </span><span class="n">payload_len</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Hit me!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">getchar</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// If all good, run the payload</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">rv</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">th</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="w"> </span><span class="n">exec_mem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
        <!-- Disqus goes here -->
        <section>
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite">Disqus goes here</div>
	  <script>
	    /**
	     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
	    /*
	     var disqus_config = function () {
	     this.page.url = ;  // Replace PAGE_URL with your page's canonical URL variable
	     this.page.identifier = drafts/converting-a-malware-dropper-to-x64-assembly.html; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	     };
	    */
	    (function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	    })();
	  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </section>
	</article>
      </div>
    </div>
  </div>
    <footer id="footer" class="her-row">
      <div class="container">
        <div class="row">
          <h4>Powered by <a href="http://blog.getpelican.com/">Pelican</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
        </div>
      </div>
    </footer>

  </body>
</html>